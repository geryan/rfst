---
title: "Victorian Forest Futures Population Vability Analysis: Central Highlands"
output: 
  html_notebook: 
    toc: yes
    number_sections: true
author: GE Ryan
date: 2019-08-05
---

# Project setup

### Packages
Install packages if necessary. Listed are installers for packages not on CRAN and the devlopment (most up-to-date) version of STEPS.
```{r install packages}
# library(devtools)
# install_github("steps-dev/steps")
```

Load packages
```{r packages}
library(magrittr)
library(tidyr)
library(dplyr)
library(tibble)
library(sf)
library(lwgeom)
library(rgdal)
library(readr)
library(readxl)
library(ggplot2)
library(lubridate)
library(foreach)
library(doMC)
library(future)
library(future.apply)
library(tidyr)
library(dismo)
library(gbm)
library(steps)
library(raster)
```

### Functions
```{r functions}
source(file = "R/functions/pg.sf.R")
source(file = "R/functions/pg.pa.R")
source(file = "R/functions/read.vba.R")
source(file = "R/functions/proc.vba.R")
source(file = "R/functions/get.landis.vars.R")
source(file = "R/functions/rascc.R")
source(file = "R/functions/read.multi.line.header.R")
source(file = "R/functions/interpolate.climdat.R")
source(file = "R/functions/rst.op.R")
source(file = "R/functions/get.disturbance.R")
```

### Paths
```{r paths}
proj_path <- "/home/landis/rfst/"
# proj_path <- "D:/Users/ryan/Dropbox/Work/RFA_STEPS/rfst/"
```


# Prepare variables

## Analysis parameters

### Start year
```{r year0}
year0 <- 2019
```


### Timesteps
```{r ntimesteps}
ntimesteps <- 50
```

### Cores to use
```{r ncores}
ncores <- 20
```



## Geographic data

### Landscape
Set up base landscape layer
```{r ch_rst}
ch_rst <- raster(x = "data/grids/eco_v12.img") %T>%
  plot
```

```{r proj ext res}
ch_proj <- ch_rst@crs
ch_extent <- extent(ch_rst)
ch_res <- res(ch_rst)
```

### Boundaries
```{r rfa}
rfa <- read_sf("data/shapefiles/RFA/")%>%
  st_transform(crs = ch_proj)
rfa
```

```{r plot rfa}
pg.sf(rfa)
```

```{r ch_rfa}
ch_rfa <- rfa[rfa$NAME== "CENTRAL HIGHLANDS",] 

ch_rfa
```

```{r plot ch_rfa}
pg.sf(ch_rfa)
```


```{r ch_mask}
ch_mask <- rasterize(ch_rfa, ch_rst, field = 1, filename = "./output/landscape_vars/ch_mask.grd", overwrite = TRUE) 

ch_mask[ch_rst == 132] <- NA # removes lake areas from habitat

plot(ch_mask)
```
*Think carefully about using this layer as projections are for zone 55, so distorts west of the state*
```{r victoria}
victoria <- read_sf("data/shapefiles/vicstatepolygon/") %>%
   st_transform(crs = ch_proj)
```

### Landscape management

#### Fire history
```{r fire_history}
fire_history <- read_sf("data/shapefiles/vicfires/fire_history_lastburnt.shp") %>%
  st_transform(crs = ch_proj) %>%
  st_make_valid %>%
  st_crop(y = st_bbox(ch_rst)) %>%
  rasterize(y = ch_mask, field = "SEASON", fun = max, background = 1850) %>%
  mask(mask = ch_mask, filename = "output/landscape_vars/fire_history.grd", overwrite = TRUE)

fire_history
```

```{r plot fire_history}
plot(fire_history)
```

#### Logging history
```{r logging_history}
logging_history <- read_sf("data/shapefiles/viclogging/lastlog25.shp") %>%
  st_transform(crs = ch_proj) %>%
  st_make_valid %>%
  st_crop(y = st_bbox(ch_rst)) %>%
  mutate(season = SEASON %>% substr(1,4) %>% as.numeric) %>%
  rasterize(y = ch_mask, field = "season", fun = max, background = 1750) %>%
  mask(mask = ch_mask, filename = "output/landscape_vars/logging_history.grd", overwrite = TRUE)

logging_history
```

```{r plot logging_history}
plot(logging_history)
```

## Occurrence data

```{r pseudo_abs}
pseudo_abs <- read_sf("data/shapefiles/pseudo_absences/pseudo_absences.shp")%>%
  st_transform(crs = st_crs(ch_rst)) %>%
  mutate(PA = 0) %>%
  dplyr::select(PA, geometry) %>%
  st_zm(drop = TRUE)

pseudo_abs
```


### GG Occurrence data
Read in data
```{r gg_ari}
gg_ari <- read_excel(path = "data/tabular/BoA_SB_Combined_VBA_upload_v4.xls") %>%
  dplyr::dplyr::select(-starts_with("leave")) %>%
  rename("lon" = `X-coordinate (easting or longitude)`, "lat" = `Y-coordinate (northing or latitude)`) %>%
   fill(lon, lat, .direction = "down") %>%
  filter(`Taxon Name` == "Misc Target taxa not found") %>%
  dplyr::select(lon, lat) %>%
  mutate(PA = 0) %>%
  st_as_sf(coords = c("lon", "lat"), crs = st_crs(28355)) %>%
  st_transform(crs = st_crs(ch_rst))

gg_ari
```

```{r gg_vba}
gg_vba <- proc.vba("data/tabular/vba_gg_all_20190509.csv", project.crs = ch_proj)

gg_vba
```

```{r gg_pa_all}
gg_pa_all <- gg_vba %>%
  rbind(gg_ari)

gg_pa_all
```

```{r plot_gg_pa_all}
plot_gg_pa_all <- pg.pa(gg_pa_all, ch_rfa) +
  geom_sf(data = victoria, fill = NA)

plot_gg_pa_all
```

```{r gg_pa_ch}
gg_pa_ch <- gg_pa_all[ch_rfa,]
gg_pa_ch
```

```{r gg_pa_ch_psab}
gg_pa_ch_psab <- gg_pa_ch %>%
  rbind(pseudo_abs)
```


```{r write gg_pa_ch}
st_write(gg_pa_ch, "output/shapefiles/pa/ch/gg_pa_ch.shp", delete_layer = TRUE)
st_write(gg_pa_ch_psab, "output/shapefiles/pa/ch/gg_pa_ch_psab.shp", delete_layer = TRUE)
```


```{r pg_gg_pa_ch}
pg_gg_pa_ch <- pg.pa(gg_pa_ch %>% mutate(pseudo_abs = "vba") %>% rbind(pseudo_abs %>% mutate(pseudo_abs = "pseudo_absences")), ch_rfa) +
  facet_grid(.~pseudo_abs)

pg_gg_pa_ch
```

### LBP Occurrence data
```{r read lb occ}
lb_pa_all <- proc.vba("data/tabular/vba_lb_all_20190509.csv", project.crs = ch_proj)
```

```{r plot_lb_pa_all}
plot_lb_pa_all <- pg.pa(lb_pa_all, ch_rfa) +
  geom_sf(data = victoria, fill = NA)

plot_lb_pa_all
```

```{r lb_pa_ch}
lb_pa_ch <- lb_pa_all[ch_rfa,]
lb_pa_ch
```

```{r lb_pa_ch_psab}
lb_pa_ch_psab <- lb_pa_ch %>%
  rbind(pseudo_abs)
```


```{r write lbp_pa_ch}
st_write(lb_pa_ch, "output/shapefiles/pa/ch/lb_pa_ch.shp", delete_layer = TRUE)
st_write(lb_pa_ch_psab, "output/shapefiles/pa/ch/lb_pa_ch_psab.shp", delete_layer = TRUE)
```


```{r pg_lb_pa_ch}
pg_lb_pa_ch <- pg.pa(lb_pa_ch %>% mutate(pseudo_abs = "vba") %>% rbind(pseudo_abs %>% mutate(pseudo_abs = "pseudo_absences")), ch_rfa) +
  facet_grid(.~pseudo_abs)

pg_lb_pa_ch
```

```{r save image occu}
save.image("output/session_images/landscape-occupancy.RData")
```

```{r load image occu}
#load(file = "output/session_images/landscape-occupancy.RData")
```


## Landis output

### Scenario 1: Current planned burning, current timber harvesting, climate change under RCP 4.5, current bushfire regime (Buisness as usual)
```{r s1_vars_landis}
s1_vars_landis <- get.landis.vars(
  scn_path = "~/landis_ch_s1_pb-th-cc_50/",
  proj_path = proj_path,
  out_path = "/output/habitat_vars/",
  scn_id = "s1",
  proj_mask = ch_mask,
  timesteps = ntimesteps,
  cores = ncores
  )
```

```{r plot s1_vars_landis initial}
plot(s1_vars_landis[[1]])
```

```{r plot s1_vars_landis last}
plot(s1_vars_landis[[ntimesteps + 1]])
```


```{r s1_vars_landis save load}
save(s1_vars_landis, file = "output/habitat_vars/s1_vars_landis")

# load(file = "output/habitat_vars/s1_vars_landis_fut")
```


### Scenario 2: Current planned burning, current timber harvesting, climate change under RCP 8.5, increatred bushfire regime


### Scenario 3: Current planned burning, current timber harvesting, no climate change, current bushfire regime
```{r s3_vars_landis}
s3_vars_landis <- get.landis.vars(
  scn_path = "~/landis_ch_s3_pb-th-cc0_50/",
  proj_path = proj_path,
  out_path = "/output/habitat_vars/",
  scn_id = "s3",
  proj_mask = ch_mask,
  timesteps = ntimesteps,
  cores = ncores
  )
```

```{r plot s3_vars_landis initial}
plot(s3_vars_landis[[1]])
```

```{r plot s3_vars_landis last}
plot(s3_vars_landis[[ntimesteps + 1]])
```


```{r s3_vars_landis save load}
save(s3_vars_landis, file = "output/habitat_vars/s3_vars_landis")

# load(file = "output/habitat_vars/s3_vars_landis_fut")
```

### Scenario 4: Current planned burning, no harvesting, climate change under RCP 4.5, current bushfire regime
```{r s4_vars_landis}
s4_vars_landis <- get.landis.vars(
  scn_path = "~/landis_ch_s4_pb-th0-cc_50/",
  proj_path = proj_path,
  out_path = "/output/habitat_vars/",
  scn_id = "s4",
  proj_mask = ch_mask,
  timesteps = ntimesteps,
  cores = ncores,
  harvest_timber = FALSE
  )
```

```{r plot s4_vars_landis initial}
plot(s4_vars_landis[[1]])
```

```{r plot s4_vars_landis last}
plot(s4_vars_landis[[ntimesteps + 1]])
```


```{r s4_vars_landis save load}
save(s4_vars_landis, file = "output/habitat_vars/s4_vars_landis")

# load(file = "output/habitat_vars/s4_vars_landis_fut")
```

## Disturbance variables
Rely on landis output and land history.

### Time since fire

#### Scenario 1:
```{r s1_fire_vars}
s1_fire_vars <- get.disturbance(disturbances =  lapply(s1_vars_landis, FUN = function(x){x[["firesev"]]}),
                                disturbance_history = fire_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s1",
                                layernames = c("fihi", "tsf"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial fire history
```{r plot s1_fire_vars fire history initial}
plot(s1_fire_vars[[1]][["fihi"]])
```

Last fire history
```{r plot s1_fire_vars fire history last}
plot(s1_fire_vars[[ntimesteps + 1]][["fihi"]])
```

Initial time since fire
```{r plot s1_fire_vars time since fire initial}
plot(s1_fire_vars[[1]][["tsf"]])
```

Last time since fire
```{r plot s1_fire_var time since fire last}
plot(s1_fire_vars[[ntimesteps + 1]][["tsf"]])
```

#### Scenario 2

#### Scenario 3
```{r s3_fire_vars}
s3_fire_vars <- get.disturbance(disturbances =  lapply(s3_vars_landis, FUN = function(x){x[["firesev"]]}),
                                disturbance_history = fire_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s3",
                                layernames = c("fihi", "tsf"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial fire history
```{r plot s3_fire_vars fire history initial}
plot(s3_fire_vars[[1]][["fihi"]])
```

Last fire history
```{r plot s3_fire_vars fire history last}
plot(s3_fire_vars[[ntimesteps + 1]][["fihi"]])
```

Initial time since fire
```{r plot s3_fire_vars time since fire initial}
plot(s3_fire_vars[[1]][["tsf"]])
```

Last time since fire
```{r plot s3_fire_var time since fire last}
plot(s3_fire_vars[[ntimesteps + 1]][["tsf"]])
```

#### Scenario 4
```{r s4_fire_vars}
s4_fire_vars <- get.disturbance(disturbances =  lapply(s4_vars_landis, FUN = function(x){x[["firesev"]]}),
                                disturbance_history = fire_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s4",
                                layernames = c("fihi", "tsf"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial fire history
```{r plot s4_fire_vars fire history initial}
plot(s4_fire_vars[[1]][["fihi"]])
```

Last fire history
```{r plot s4_fire_vars fire history last}
plot(s4_fire_vars[[ntimesteps + 1]][["fihi"]])
```

Initial time since fire
```{r plot s4_fire_vars time since fire initial}
plot(s4_fire_vars[[1]][["tsf"]])
```

Last time since fire
```{r plot s4_fire_var time since fire last}
plot(s4_fire_vars[[ntimesteps + 1]][["tsf"]])
```



### Time since logging

#### Scenario 1:
```{r s1_logging_vars}
s1_logging_vars <- get.disturbance(disturbances =  lapply(s1_vars_landis, FUN = function(x){x[["harvest"]]}),
                                disturbance_history = logging_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s1",
                                layernames = c("lohi", "tsl"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial logging history
```{r plot s1_logging_vars logging history initial}
plot(s1_logging_vars[[1]][["lohi"]])
```

Last logging history
```{r plot s1_logging_vars logging history last}
plot(s1_logging_vars[[ntimesteps + 1]][["lohi"]])
```

Initial time since fire
```{r plot s1_logging_vars time since logging initial}
plot(s1_logging_vars[[1]][["tsl"]])
```

Last time since fire
```{r plot s1_logging_var time since logging last}
plot(s1_logging_vars[[ntimesteps + 1]][["tsl"]])
```

#### Scenario 2

#### Scenario 3
```{r s3_logging_vars}
s3_logging_vars <- get.disturbance(disturbances =  lapply(s3_vars_landis, FUN = function(x){x[["harvest"]]}),
                                disturbance_history = logging_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s3",
                                layernames = c("lohi", "tsl"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial logging history
```{r plot s3_logging_vars logging history initial}
plot(s3_logging_vars[[1]][["lohi"]])
```

Last logging history
```{r plot s3_logging_vars logging history last}
plot(s3_logging_vars[[ntimesteps + 1]][["lohi"]])
```

Initial time since fire
```{r plot s3_logging_vars time since logging initial}
plot(s3_logging_vars[[1]][["tsl"]])
```

Last time since fire
```{r plot s3_logging_var time since logging last}
plot(s3_logging_vars[[ntimesteps + 1]][["tsl"]])
```

#### Scenario 4
```{r s4_logging_vars}
s4_logging_vars <- get.disturbance(disturbances =  lapply(s4_vars_landis, FUN = function(x){x[["harvest"]]}),
                                disturbance_history = logging_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s4",
                                layernames = c("lohi", "tsl"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial logging history
```{r plot s4_logging_vars logging history initial}
plot(s4_logging_vars[[1]][["lohi"]])
```

Last logging history
```{r plot s4_logging_vars logging history last}
plot(s4_logging_vars[[ntimesteps + 1]][["lohi"]])
```

Initial time since fire
```{r plot s4_logging_vars time since logging initial}
plot(s4_logging_vars[[1]][["tsl"]])
```

Last time since fire
```{r plot s4_logging_var time since logging last}
plot(s4_logging_vars[[ntimesteps + 1]][["tsl"]])
```

## ARI Data

### Anisotronic heating x ruggedness
```{r ahr}
ahr <-raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/Anisotrophic_Heating_Ruggedness") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_ahr.grd", overwrite = TRUE) %T>%
  plot
```

### Log verticical distance all wetlands
```{r lvdaw}
lvdaw <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/log_vertical_distance_all_wetlands_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_lvdaw.grd", overwrite = TRUE) %T>%
  plot
```
### Log vertical distance major streams
```{r lvdma}
lvdma <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/log_vertical_distance_major_streams_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_lvdma.grd", overwrite = TRUE) %T>%
  plot
```
### Log vertical distance minor streams
```{r lvdmi}
lvdmi <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/log_vertical_distance_minor_streams_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_lvdmi.grd", overwrite = TRUE) %T>%
  plot
```
### Log vertical distance saline wetlands
```{r lvdsw}
lvdsw <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/log_vertical_distance_saline_wetlands_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_lvdsw.grd", overwrite = TRUE) %T>%
  plot
```
### Relative annual insolation
```{r rai}
rai <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/relative_annual_insolation_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_rai.grd", overwrite = TRUE) %T>%
  plot
```
### Thorium
```{r tho}
tho <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/sept2014thorium") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_tho.grd", overwrite = TRUE) %T>%
  plot
```

### Visible sky index
```{r vsky}
vsky <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/visible_sky_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_vsky.grd", overwrite = TRUE) %T>%
  plot
```

### Topographic wetness index
```{r twi}
twi <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/wetness_index_topocrop_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_twi.grd", overwrite = TRUE) %T>%
  plot
```

### Wind exposition
**Problem with layer**
```{r winex}
# winex <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/wind_exposition2015") %>%
  # projectRaster(to = ch_mask) %>%
  # mask(mask = ch_mask, filename = "output/habitat_vars/ari_winex.grd", overwrite = TRUE) %T>%
  # plot
```

### ARI variables stack

#### Initial variables
```{r ari_iv}
ari_iv <- stack(lvdaw, lvdma, lvdmi, lvdsw)

names(ari_iv) <- c("lvdaw", "lvdma", "lvdmi", "lvdsw")
```

#### Future variables 
Repeates into list for each year
```{r ari_v}
ari_v <- vector("list", ntimesteps + 1)

for(i in 1:(ntimesteps+1)){
  ari_v[[i]] <- ari_iv
}
```



## Climactic data
pc ~ percentage change
ac ~ absolute change

tmax ~ max temperature
tmin ~ minimum temperature
prec ~ precipitation
evtr ~ evapotranspiration

01 ~ January
07 ~ July

4.5 ~ rcp 4.5
8.5 ~ rcp 8.5


### Current climate
From WorldClim
#### Max temperature in January
```{r tmax01}
tmax01 <- getData(name = "worldclim", var = "tmax", res = 0.5, lat = -60, lon = 120)[[1]] %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/clim_vars/tmax01.grd", overwrite = TRUE)

names(tmax01) <- "tmax01"

plot(tmax01)
```

#### Minimum temperature in July
```{r tmin07}
tmin07 <- getData(name = "worldclim", var = "tmin", res = 0.5, lat = -60, lon = 120)[[7]] %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/clim_vars/tmin07.grd", overwrite = TRUE)

names(tmin07) <- "tmin07"

plot(tmin07)
```
#### Precipitation in January
```{r prec01}
prec01 <- getData(name = "worldclim", var = "prec", res = 0.5, lat = -60, lon = 120)[[1]] %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/clim_vars/prec01.grd", overwrite = TRUE)

names(prec01) <- "prec01"

plot(prec01)
```

#### Precipitation in July
```{r prec07}
prec07 <- getData(name = "worldclim", var = "tmax", res = 0.5, lat = -60, lon = 120)[[7]] %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/clim_vars/prec07.grd", overwrite = TRUE)

names(prec07) <- "prec07"

plot(prec07)
```




### Future climate
Data from [Climate Change in Australia](https://www.climatechangeinaustralia.gov.au/en/)

#### Change data
*There should be new data to replace this *
##### Absolute change in temperature
Get raw data
```{r raw temp ac}
#absolute change in temp
raw_tmax01_4.5_ac <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/tasmax_Amon_CSIRO-Mk3-6-0_rcp45_r1i1p1_abs-change-wrt-seasavg-clim_native.csv?tasmax_january[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")

raw_tmax01_8.5_ac <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/tasmax_Amon_CSIRO-Mk3-6-0_rcp85_r1i1p1_abs-change-wrt-seasavg-clim_native.csv?tasmax_january[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")

raw_tmin07_4.5_ac <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/tasmin_Amon_CSIRO-Mk3-6-0_rcp45_r1i1p1_abs-change-wrt-seasavg-clim_native.csv?tasmin_july[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]") 

raw_tmin07_8.5_ac <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/tasmin_Amon_CSIRO-Mk3-6-0_rcp85_r1i1p1_abs-change-wrt-seasavg-clim_native.csv?tasmin_july[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")
```
Years data available
```{r n temp ac}
n_tmax01_4.5 <- as.numeric(sub("-.*", "", unique(raw_tmax01_4.5_ac$time)))
n_tmax01_8.5 <- as.numeric(sub("-.*", "", unique(raw_tmax01_8.5_ac$time)))
n_tmin07_4.5 <- as.numeric(sub("-.*", "", unique(raw_tmin07_4.5_ac$time)))
n_tmin07_8.5 <- as.numeric(sub("-.*", "", unique(raw_tmin07_8.5_ac$time)))
```

Reprojected layers
```{r rasters temp ac}
tmax01_4.5_ac <- rascc(raw_tmax01_4.5_ac, new.proj.layer = ch_mask, filename = "output/clim_vars/tmax01_4.5_ac.grd")
tmax01_8.5_ac <- rascc(raw_tmax01_8.5_ac, new.proj.layer = ch_mask, filename = "output/clim_vars/tmax01_8.5_ac.grd")
tmin07_4.5_ac <- rascc(raw_tmin07_4.5_ac, new.proj.layer = ch_mask, filename = "output/clim_vars/tmin07_4.5_ac.grd")
tmin07_8.5_ac <- rascc(raw_tmin07_8.5_ac, new.proj.layer = ch_mask, filename = "output/clim_vars/tmin07_8.5_ac.grd")
```

##### Percentage change in precipitation
Get raw data
```{r raw prec pc}
raw_prec01_4.5_pc <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/pr_Amon_CSIRO-Mk3-6-0_rcp45_r1i1p1_perc-change-wrt-seassum-clim_native.csv?pr_january[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")

raw_prec01_8.5_pc <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/pr_Amon_CSIRO-Mk3-6-0_rcp85_r1i1p1_perc-change-wrt-seassum-clim_native.csv?pr_january[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")

raw_prec07_4.5_pc <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/pr_Amon_CSIRO-Mk3-6-0_rcp45_r1i1p1_perc-change-wrt-seassum-clim_native.csv?pr_july[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")

raw_prec07_8.5_pc <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/pr_Amon_CSIRO-Mk3-6-0_rcp85_r1i1p1_perc-change-wrt-seassum-clim_native.csv?pr_july[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")
```

Years data available
```{r n prec pc}
n_prec01_4.5 <- as.numeric(sub("-.*", "", unique(raw_prec01_4.5_pc$time)))
n_prec01_8.5 <- as.numeric(sub("-.*", "", unique(raw_prec01_4.5_pc$time)))
n_prec07_4.5 <- as.numeric(sub("-.*", "", unique(raw_prec07_4.5_pc$time)))
n_prec07_8.5 <- as.numeric(sub("-.*", "", unique(raw_prec07_4.5_pc$time)))
```

Reprojected layers
```{r raster prec pc}
prec01_4.5_pc <- rascc(raw_prec01_4.5_pc, new.proj.layer = ch_mask, filename = "output/clim_vars/prec01_4.5_pc.grd")
prec01_8.5_pc <- rascc(raw_prec01_8.5_pc, new.proj.layer = ch_mask, filename = "output/clim_vars/prec01_8.5_pc.grd")
prec07_4.5_pc <- rascc(raw_prec07_4.5_pc, new.proj.layer = ch_mask, filename = "output/clim_vars/prec07_4.5_pc.grd")
prec07_8.5_pc <- rascc(raw_prec07_8.5_pc, new.proj.layer = ch_mask, filename = "output/clim_vars/prec07_8.5_pc.grd")
```



####  Absolute predicted values

##### Temperature

add new function that writes these climate layers to files.


###### Jan max temperature RCP 4.5
```{r tmax01_4.5}
tmax01_4.5 <- rst.op(input1 = tmax01,
                     input2 = tmax01_4.5_ac,
                     proj_mask = ch_mask,
                     op = "addabs",
                     filename = "output/clim_vars/tmax01_4.5",
                     layernames = n_tmax01_4.5) %T>%
  plot
```

###### Jan max temperature RCP 8.5
```{r tmax01_8.5}
tmax01_8.5 <- rst.op(input1 = tmax01,
                     input2 = tmax01_8.5_ac,
                     proj_mask = ch_mask,
                     op = "addabs",
                     filename = "output/clim_vars/tmax01_8.5",
                     layernames = n_tmax01_8.5) %T>%
  plot
```
###### July min temperature RCP 4.5
```{r tmin07_4.5}
tmin07_4.5 <- rst.op(input1 = tmin07,
                     input2 = tmin07_4.5_ac,
                     proj_mask = ch_mask,
                     op = "addabs",
                     filename = "output/clim_vars/tmin07_4.5",
                     layernames = n_tmin07_4.5) %T>%
  plot
```

###### July min temperature RCP 8.5
```{r tmin07_8.5}
tmin07_8.5 <- rst.op(input1 = tmin07,
                     input2 = tmin07_8.5_ac,
                     proj_mask = ch_mask,
                     op = "addabs",
                     filename = "output/clim_vars/tmin07_8.5",
                     layernames = n_tmin07_8.5) %T>%
  plot
```

##### Precipitation

##### January precipitation RCP 4.5
```{r prec01_4.5}
prec01_4.5 <- rst.op(input1 = prec01,
                     input2 = prec01_4.5_pc,
                     proj_mask = ch_mask,
                     op = "addper",
                     filename = "output/clim_vars/prec01_4.5",
                     layernames = n_prec01_4.5) %T>%
  plot
```

##### January precipitation RCP 8.5
```{r prec01_8.5}
prec01_8.5 <- rst.op(input1 = prec01,
                     input2 = prec01_8.5_pc,
                     proj_mask = ch_mask,
                     op = "addper",
                     filename = "output/clim_vars/prec01_8.5",
                     layernames = n_prec01_8.5) %T>%
  plot
```

##### July precipitation RCP 4.5
```{r prec07_4.5}
prec07_4.5 <- rst.op(input1 = prec07,
                     input2 = prec07_4.5_pc,
                     proj_mask = ch_mask,
                     op = "addper",
                     filename = "output/clim_vars/prec07_4.5",
                     layernames = n_prec07_4.5) %T>%
  plot
```

##### July precipitation RCP 8.5
```{r prec07_8.5}
prec07_8.5 <- rst.op(input1 = prec07,
                     input2 = prec07_8.5_pc,
                     proj_mask = ch_mask,
                     op = "addper",
                     filename = "output/clim_vars/prec07_8.5",
                     layernames = n_prec07_8.5) %T>%
  plot
```

#### Interploate prediction data
```{r tmax01_4.5_int}
tmax01_4.5_int <- interpolate.climdat(initras = tmax01,
                                      futras = tmax01_4.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_tmax01_4.5,
                                      year0 =  year0,
                                      varname = "tmax01",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/tmax01_4.5")
```

```{r tmax01_8.5_int}
tmax01_8.5_int <- interpolate.climdat(initras = tmax01,
                                      futras = tmax01_8.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_tmax01_8.5,
                                      year0 =  year0,
                                      varname = "tmax01",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/tmax01_8.5")
```

```{r tmin07_4.5_int}
tmin07_4.5_int <- interpolate.climdat(initras = tmin07,
                                      futras = tmin07_4.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_tmin07_4.5,
                                      year0 =  year0,
                                      varname = "tmin07",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/tmin07_4.5")
```

```{r tmin07_8.5_int}
tmin07_8.5_int <- interpolate.climdat(initras = tmin07,
                                      futras = tmin07_8.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_tmin07_8.5,
                                      year0 =  year0,
                                      varname = "tmin07",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/tmin07_8.5")
```

```{r prec01_4.5_int}
prec01_4.5_int <- interpolate.climdat(initras = prec01,
                                      futras = prec01_4.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_prec01_4.5,
                                      year0 =  year0,
                                      varname = "prec01",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/prec01_4.5")
```

```{r prec01_8.5_int}
prec01_8.5_int <- interpolate.climdat(initras = prec01,
                                      futras = prec01_8.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_prec01_8.5,
                                      year0 =  year0,
                                      varname = "prec01",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/prec01_8.5")
```

```{r prec07_4.5_int}
prec07_4.5_int <- interpolate.climdat(initras = prec07,
                                      futras = prec07_4.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_prec07_4.5,
                                      year0 =  year0,
                                      varname = "prec07",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/prec07_4.5")
```

```{r prec07_8.5_int}
prec07_8.5_int <- interpolate.climdat(initras = prec07,
                                      futras = prec07_8.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_prec07_8.5,
                                      year0 =  year0,
                                      varname = "prec07",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/prec07_8.5")
```

### Climate variable sets

#### Climate variables
```{r clim_vars}
clim_vars_cc0 <- vector("list", ntimesteps + 1)
for(i in 1:(ntimesteps + 1)){
  clim_vars_cc0[[i]] <- stack(prec01, prec07, tmax01, tmin07)
}
clim_vars_4.5 <- mapply(prec01_4.5_int, prec07_4.5_int, tmax01_4.5_int, tmin07_4.5_int, FUN = stack)
clim_vars_8.5 <- mapply(prec01_8.5_int, prec07_8.5_int, tmax01_8.5_int, tmin07_8.5_int, FUN = stack)
```

```{r save image vars}
save.image(file = "output/session_images/input_variables.RData")
```



## Distribution model variables

### Species LANDIS variables

#### GG LANDIS vars
```{r gg_lv}
gglv <- c("ggf", "ggd", "hbt_1k", "prop_bio_regn", "prop_bio_targ", "prop_oge_1k")
```


#### LB LANDIS vars
```{r lblv}
lblv <- c("lbm", "hbt_3h", "prop_oge_3h")
```


### Greater Glider

#### Model data

#####  Scenario 1 Variable layers
```{r s1_v_gg initial}
s1_v_gg <- s1_vars_landis %>%
  sapply("[[", gglv) %>%
  mapply(clim_vars_4.5,
         ari_v,
         sapply(s1_fire_vars, "[[", "tsf"),
         sapply(s1_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s1_v_gg, file = "output/model_vars/s1_v_gg")
```

##### Model data
```{r md_gg}
md_gg <- s1_v_gg[[1]] %>%
  raster::extract(y = st_coordinates(gg_pa_ch)) %>%
  cbind("PA" = gg_pa_ch$PA, .) %>%
  as.data.frame %>%
  na.omit

save(md_gg, file = "output/model_vars/md_gg")
```

##### Model data with pseudo-absences
```{r s1_md_gg_ps}
s1_md_gg_ps <- s1_v_gg[[1]] %>%
  raster::extract(y = st_coordinates(gg_pa_ch_psab)) %>%
  cbind("PA" = gg_pa_ch_psab$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s1_md_gg_ps, file = "output/model_vars/s1_md_gg_ps")
```

##### Check for correlations
```{r corr s1_v_gg}
s1_gg_cor <- cor(s1_md_gg[, 2:dim(s1_md_gg)[2]])
s1_gg_cor
```
```{r highlight s1_gg_cor}
ifelse(s1_gg_cor > 0.7, s1_gg_cor, 0)
```

This suggests high degree of correlation (coefficient >0.7) between:

- hbt_1k and prop_oge_1k
- prec07, tmax01, and tmin07, and
- lvdaw, lvdma, and lvdsw.

Aim to keep:
- prop_oge_1k, as this has the biomass-by-age data so should be more nuanced than the hbt_1k index.
- tmin07, as highest average correlations and means we keep a temperature and a precipitation varible in the model
- lvdaw, as this encompasses both major water bodies and salt water bodies

Recompile variables excluding highly correlated variables.

```{r gg_lv recompile}
gglv <- c("ggf", "ggd", "prop_bio_regn", "prop_bio_targ", "prop_oge_1k")
```


```{r ari_v recomppile}
ari_v <- sapply(ari_v, "[[", c("lvdaw", "lvdmi"))
```

```{r clim_vars recompile}
clim_vars_cc0 <- sapply(clim_vars_cc0, "[[", c("prec01", "tmin07"))
clim_vars_4.5 <- sapply(clim_vars_4.5, "[[", c("prec01", "tmin07"))
clim_vars_8.5 <- sapply(clim_vars_8.5, "[[", c("prec01", "tmin07"))
```

#### Recompile scenario 1 variable layers
```{r s1_v_gg}
s1_v_gg <- s1_vars_landis %>%
  sapply("[[", gglv) %>%
  mapply(clim_vars_4.5,
         ari_v,
         sapply(s1_fire_vars, "[[", "tsf"),
         sapply(s1_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s1_v_gg, file = "output/model_vars/s1_v_gg")
```

##### Recompile  Model data
```{r s1_md_gg}
md_gg <- s1_v_gg[[1]] %>%
  raster::extract(y = st_coordinates(gg_pa_ch)) %>%
  cbind("PA" = gg_pa_ch$PA, .) %>%
  as.data.frame %>%
  na.omit

save(md_gg, file = "output/model_vars/md_gg")
```

##### Recompile Model data with pseudo-absences
```{r _md_gg_ps}
md_gg_ps <- s1_v_gg[[1]] %>%
  raster::extract(y = st_coordinates(gg_pa_ch_psab)) %>%
  cbind("PA" = gg_pa_ch_psab$PA, .) %>%
  as.data.frame %>%
  na.omit

save(md_gg_ps, file = "output/model_vars/md_gg_ps")
```

Check agian no  highly correlated variables
```{r check again s1_gg_cor}
which(cor(s1_md_gg) > 0.7 && cor(s1_md_gg) != 1) 
```


#### Leadbeater's Possum

##### Variable layers
```{r s1_v_lb}
s1_v_lb <- s1_vars_landis %>%
  sapply("[[", lblv) %>%
  mapply(clim_vars_4.5,
         ari_v,
         sapply(s1_fire_vars, "[[", "tsf"),
         sapply(s1_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s1_v_lb, file = "output/model_vars/s1_v_lb")
```

##### Model data
```{r s1_md_lb}
s1_md_lb <- s1_v_lb[[1]] %>%
  raster::extract(y = st_coordinates(lb_pa_ch)) %>%
  cbind("PA" = lb_pa_ch$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s1_md_lb, file = "output/model_vars/s1_md_lb")
```

##### Model data with pseudo-absences
```{r s1_md_lb_ps}
s1_md_lb_ps <- s1_v_lb[[1]] %>%
  raster::extract(y = st_coordinates(lb_pa_ch_psab)) %>%
  cbind("PA" = lb_pa_ch_psab$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s1_md_lb_ps, file = "output/model_vars/s1_md_lb_ps")
```

##### Check for correlations
```{r corr s1_v_lb}
s1_lb_cor <- cor(s1_md_lb[, 2:dim(s1_md_lb)[2]])
s1_lb_cor
```
```{r highlight s1_lb_cor}
ifelse(s1_lb_cor > 0.7, s1_lb_cor, 0)
```

Again high correlation between hollow-bearing tree index and proportion of old-growth eucalypts. As for greater glider, exclude the hbt_3h and recompile model variables.

##### LB LANDIS vars
```{r lblv}
lblv <- c("lbm", "prop_oge_3h")
```

##### Variable layers
```{r s1_v_lb}
s1_v_lb <- s1_vars_landis %>%
  sapply("[[", lblv) %>%
  mapply(clim_vars_4.5,
         ari_v,
         sapply(s1_fire_vars, "[[", "tsf"),
         sapply(s1_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s1_v_lb, file = "output/model_vars/s1_v_lb")
```

##### Model data
```{r s1_md_lb}
s1_md_lb <- s1_v_lb[[1]] %>%
  raster::extract(y = st_coordinates(lb_pa_ch)) %>%
  cbind("PA" = lb_pa_ch$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s1_md_lb, file = "output/model_vars/s1_md_lb")
```

##### Model data with pseudo-absences
```{r s1_md_lb_ps}
s1_md_lb_ps <- s1_v_lb[[1]] %>%
  raster::extract(y = st_coordinates(lb_pa_ch_psab)) %>%
  cbind("PA" = lb_pa_ch_psab$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s1_md_lb_ps, file = "output/model_vars/s1_md_lb_ps")
```

Check agian no  highly correlated variables
```{r check again s1_gg_cor}
which(cor(s1_md_lb) > 0.7 && cor(s1_md_lb) != 1) 
```


### Scenario 2

### Scenario 3

#### Greater Glider

##### Variable layers
```{r s3_v_gg}
s3_v_gg <- s3_vars_landis %>%
  sapply("[[", gglv) %>%
  mapply(clim_vars_cc0,
         ari_v,
         sapply(s3_fire_vars, "[[", "tsf"),
         sapply(s3_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s3_v_gg, file = "output/model_vars/s3_v_gg")
```

##### Model data
```{r s3_md_gg}
s3_md_gg <- s3_v_gg[[1]] %>%
  raster::extract(y = st_coordinates(gg_pa_ch)) %>%
  cbind("PA" = gg_pa_ch$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s3_md_gg, file = "output/model_vars/s3_md_gg")
```

##### Model data with pseudo-absences
```{r s3_md_gg_ps}
s3_md_gg_ps <- s3_v_gg[[1]] %>%
  raster::extract(y = st_coordinates(gg_pa_ch_psab)) %>%
  cbind("PA" = gg_pa_ch_psab$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s3_md_gg_ps, file = "output/model_vars/s3_md_gg_ps")
```


#### Leadbeater's Possum

##### Variable layers
```{r s3_v_lb}
s3_v_lb <- s3_vars_landis %>%
  sapply("[[", lblv) %>%
  mapply(clim_vars_cc0,
         ari_v,
         sapply(s3_fire_vars, "[[", "tsf"),
         sapply(s3_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s3_v_lb, file = "output/model_vars/s3_v_lb")
```

##### Model data
```{r s3_md_lb}
s3_md_lb <- s3_v_lb[[1]] %>%
  raster::extract(y = st_coordinates(lb_pa_ch)) %>%
  cbind("PA" = lb_pa_ch$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s3_md_lb, file = "output/model_vars/s3_md_lb")
```

##### Model data with pseudo-absences
```{r s3_md_lb_ps}
s3_md_lb_ps <- s3_v_lb[[1]] %>%
  raster::extract(y = st_coordinates(lb_pa_ch_psab)) %>%
  cbind("PA" = lb_pa_ch_psab$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s3_md_lb_ps, file = "output/model_vars/s3_md_lb_ps")
```

### Scenario 4

#### Greater Glider

#### Variable layers
```{r s4_v_gg}
s4_v_gg <- s4_vars_landis %>%
  sapply("[[", gglv) %>%
  mapply(clim_vars_4.5,
         ari_v,
         sapply(s4_fire_vars, "[[", "tsf"),
         sapply(s4_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s4_v_gg, file = "output/model_vars/s4_v_gg")
```

#### Model data
```{r s4_md_gg}
s4_md_gg <- s4_v_gg[[1]] %>%
  raster::extract(y = st_coordinates(gg_pa_ch)) %>%
  cbind("PA" = gg_pa_ch$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s4_md_gg, file = "output/model_vars/s4_md_gg")
```

#### Model data with pseudo-absences
```{r s4_md_gg_ps}
s4_md_gg_ps <- s4_v_gg[[1]] %>%
  raster::extract(y = st_coordinates(gg_pa_ch_psab)) %>%
  cbind("PA" = gg_pa_ch_psab$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s4_md_gg_ps, file = "output/model_vars/s4_md_gg_ps")
```


#### Leadbeater's Possum

#### Variable layers
```{r s4_v_lb}
s4_v_lb <- s4_vars_landis %>%
  sapply("[[", lblv) %>%
  mapply(clim_vars_4.5,
         ari_v,
         sapply(s4_fire_vars, "[[", "tsf"),
         sapply(s4_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s4_v_lb, file = "output/model_vars/s4_v_lb")
```

#### Model data
```{r s4_md_lb}
s4_md_lb <- s4_v_lb[[1]] %>%
  raster::extract(y = st_coordinates(lb_pa_ch)) %>%
  cbind("PA" = lb_pa_ch$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s4_md_lb, file = "output/model_vars/s4_md_lb")
```

#### Model data with pseudo-absences
```{r s4_md_lb_ps}
s4_md_lb_ps <- s4_v_lb[[1]] %>%
  raster::extract(y = st_coordinates(lb_pa_ch_psab)) %>%
  cbind("PA" = lb_pa_ch_psab$PA, .) %>%
  as.data.frame %>%
  na.omit

save(s4_md_lb_ps, file = "output/model_vars/s4_md_lb_ps")
```


# Distribution model fit and prediction

## Greater Glider

### Scenario 1
```{r s1_mod_gg}
s1_mod_gg <- gbm.step(data = s1_md_gg, gbm.x = 2:12, gbm.y = 1, family = "bernoulli", tree.complexity = 5, learning.rate = 0.01, step.size = 1, bag.fraction = 0.5, prev.stratify = FALSE, verbose = FALSE, max.trees = 1000)
```

```{r sumary s1_mod_gg}
summary(s1_mod_gg)
```

```{r s1_ip_gg}
#s1_ip_gg <- predict(s1_iv_gg, s1_mod_gg, type = "response", n.trees = s1_mod_gg$gbm.call$best.trees, filename = "output/habitat_pred/s1_fp_gg-000.tif")

#writeRaster(s1_ip_gg, "output/habitat_pred/s1_ip_gg.tif", overwrite = TRUE)
s1_ip_gg <- raster(x = "output/habitat_pred/s1_ip_gg.tif")

plot(s1_ip_gg)
```

```{r s1_fp_gg}
registerDoMC(cores = 20)

s1_fp_gg <- foreach(i = seq_len(length(s1_fv_gg))) %dopar% {
  predict(s1_fv_gg[[i]],
          s1_mod_gg,
          type = "response",
          n.trees = s1_mod_gg$gbm.call$best.trees,
          filename = paste0("output/habitat_pred/s1_fp_gg-", sprintf("%03d", i), ".tif"),
          overwrite = TRUE)
}

s1_fp_gg <- stack(s1_fp_gg)
```

```{r save s1_fp_gg}
save(s1_fp_gg, file = "output/habitat_pred/s1_fp_gg")
writeRaster(s1_fp_gg, filename = "output/habitat_pred/s1_fp_gg.tif")
```


### Scenario 3
```{r s3_mod_gg}
s3_mod_gg <- gbm.step(data = s3_md_gg, gbm.x = 3:7, gbm.y = 1, family = "bernoulli", tree.complexity = 5, learning.rate = 0.001, step.size = 1, bag.fraction = 0.5, prev.stratify = FALSE, verbose = FALSE, max.trees = 1000)
```
```{r sumary s3_mod_gg}
summary(s3_mod_gg)
```

```{r s3_ip_gg}
 # s3_ip_gg <- predict(s3_iv_gg, s3_mod_gg, type = "response", n.trees = s3_mod_gg$gbm.call$best.trees, filename ="output/habitat_pred/s3_fp_gg-000.tif")

 # writeRaster(s3_ip_gg, "output/habitat_pred/s3_ip_gg.tif", overwrite = TRUE)

s3_ip_gg <- raster(x = "output/habitat_pred/s3_ip_gg.tif")

plot(s3_ip_gg)
```

```{r s3_fp_gg}
registerDoMC(cores = 20)

s3_fp_gg <- foreach(i = seq_len(length(s3_fv_gg))) %dopar% {
  predict(s3_fv_gg[[i]],
          s3_mod_gg,
          type = "response",
          n.trees = s3_mod_gg$gbm.call$best.trees,
          filename = paste0("output/habitat_pred/s3_fp_gg-", sprintf("%03d", i), ".tif"),
          overwrite = TRUE)
}

s3_fp_gg <- stack(s3_fp_gg)
```

```{r save s3_fp_gg}
save(s3_fp_gg, file = "output/habitat_pred/s3_fp_gg")
writeRaster(s3_fp_gg, filename = "output/habitat_pred/s3_fp_gg.tif")
```

### Scenario 4
```{r s4_mod_gg}
s4_mod_gg <- gbm.step(data = s4_md_gg, gbm.x = 2:8, gbm.y = 1, family = "bernoulli", tree.complexity = 5, learning.rate = 0.001, step.size = 1, bag.fraction = 0.5, prev.stratify = FALSE, verbose = FALSE, max.trees = 1000)
```
```{r sumary s4_mod_gg}
summary(s4_mod_gg)
```

```{r s4_ip_gg}
# s4_ip_gg <- predict(s4_iv_gg, s4_mod_gg, type = "response", n.trees = s4_mod_gg$gbm.call$best.trees,  filename = "output/habitat_pred/4_fp_gg-000.tif")

# writeRaster(s4_ip_gg, "output/habitat_pred/s4_ip_gg.tif", overwrite = TRUE)

s4_ip_gg <- raster(x = "output/habitat_pred/s4_ip_gg.tif")

plot(s4_ip_gg)
```

```{r s4_fp_gg}
registerDoMC(cores = 20)

s4_fp_gg <- foreach(i = seq_len(length(s4_fv_gg))) %dopar% {
  predict(s4_fv_gg[[i]],
          s4_mod_gg,
          type = "response",
          n.trees = s4_mod_gg$gbm.call$best.trees,
          filename = paste0("output/habitat_pred/s4_fp_gg-", sprintf("%03d", i), ".tif"),
          overwrite = TRUE)
}

s4_fp_gg <- stack(s4_fp_gg)
```

```{r save s4_fp_gg}
save(s4_fp_gg, file = "output/habitat_pred/s4_fp_gg")
writeRaster(s4_fp_gg, filename = "output/habitat_pred/s4_fp_gg.tif")
```


## Leadbeater's Possum


### Scenario 1
```{r s1_mod_lb}
s1_mod_lb <- gbm.step(data = s1_md_lb, gbm.x = 2:7, gbm.y = 1, family = "bernoulli", tree.complexity = 5, learning.rate = 0.001, step.size = 1, bag.fraction = 0.5, prev.stratify = FALSE, verbose = FALSE, max.trees = 1000)
```
```{r sumary s1_mod_lb}
summary(s1_mod_lb)
```

```{r s1_ip_lb}
# s1_ip_lb <- predict(s1_iv_lb, s1_mod_lb, type = "response", n.trees = s1_mod_lb$gbm.call$best.trees, filename = "output/habitat_pred/s1_fp_lb-000.tif")

# writeRaster(s1_ip_lb, "output/habitat_pred/s1_ip_lb.tif", overwrite = TRUE)

s1_ip_lb <- raster(x = "output/habitat_pred/s1_ip_lb.tif")

plot(s1_ip_lb)
```

```{r s1_fp_lb}
registerDoMC(cores = 20)

s1_fp_lb <- foreach(i = seq_len(length(s1_fv_lb))) %dopar% {
  predict(s1_fv_lb[[i]],
          s1_mod_lb,
          type = "response",
          n.trees = s1_mod_lb$gbm.call$best.trees,
          filename = paste0("output/habitat_pred/s1_fp_lb-", sprintf("%03d", i), ".tif"),
          overwrite = TRUE)
}

s1_fp_lb <- stack(s1_fp_lb)
```

```{r save s1_fp_lb}
save(s1_fp_lb, file = "output/habitat_pred/s1_fp_lb")
writeRaster(s1_fp_lb, filename = "output/habitat_pred/s1_fp_lb.tif")
```

### Scenario 3
```{r s3_mod_lb}
s3_mod_lb <- gbm.step(data = s3_md_lb, gbm.x = 2:7, gbm.y = 1, family = "bernoulli", tree.complexity = 5, learning.rate = 0.001, step.size = 1, bag.fraction = 0.5, prev.stratify = FALSE, verbose = FALSE, max.trees = 1000)
```
```{r sumary s3_mod_lb}
summary(s3_mod_lb)
```

```{r s3_ip_lb}
# s3_ip_lb <- predict(s3_iv_lb, s3_mod_lb, type = "response", n.trees = s3_mod_lb$gbm.call$best.trees, filename = "output/habitat_pred/s3_fp_lb-000.tif")

# writeRaster(s3_ip_lb, "output/habitat_pred/s3_ip_lb.tif", overwrite = TRUE)

s3_ip_lb <- raster(x = "output/habitat_pred/s3_ip_lb.tif")

plot(s3_ip_lb)
```

```{r s3_fp_lb}
registerDoMC(cores = 20)

s3_fp_lb <- foreach(i = seq_len(length(s3_fv_lb))) %dopar% {
  predict(s3_fv_lb[[i]],
          s3_mod_lb,
          type = "response",
          n.trees = s3_mod_lb$gbm.call$best.trees,
          filename = paste0("output/habitat_pred/s3_fp_lb-", sprintf("%03d", i), ".tif"),
          overwrite = TRUE)
}

s3_fp_lb <- stack(s3_fp_lb)
```

```{r save s3_fp_lb}
save(s3_fp_lb, file = "output/habitat_pred/s3_fp_lb")
writeRaster(s3_fp_lb, filename = "output/habitat_pred/s3_fp_lb.tif")
```

### Scenario 4
```{r s4_mod_lb}
s4_mod_lb <- gbm.step(data = s4_md_lb, gbm.x = 2:7, gbm.y = 1, family = "bernoulli", tree.complexity = 5, learning.rate = 0.001, step.size = 1, bag.fraction = 0.5, prev.stratify = FALSE, verbose = FALSE, max.trees = 1000)
```
```{r sumary s4_mod_lb}
summary(s4_mod_lb)
```

```{r s4_ip_lb}
# s4_ip_lb <- predict(s4_iv_lb, s4_mod_lb, type = "response", n.trees = s4_mod_lb$gbm.call$best.trees, filename = "output/habitat_pred/s4_fp_lb-000.tif")

# writeRaster(s4_ip_lb, "output/habitat_pred/s4_ip_lb.tif", overwrite = TRUE)

s4_ip_lb <- raster(x = "output/habitat_pred/s4_ip_lb.tif")

plot(s4_ip_lb)
```

```{r s4_fp_lb}
registerDoMC(cores = 20)

s4_fp_lb <- foreach(i = seq_len(length(s4_fv_lb))) %dopar% {
  predict(s4_fv_lb[[i]],
          s4_mod_lb,
          type = "response",
          n.trees = s4_mod_lb$gbm.call$best.trees,
          filename = paste0("output/habitat_pred/s4_fp_lb-", sprintf("%03d", i), ".tif"),
          overwrite = TRUE)
}

s4_fp_lb <- stack(s4_fp_lb)
```

```{r save s4_fp_lb}
save(s4_fp_lb, file = "output/habitat_pred/s4_fp_lb")
writeRaster(s4_fp_lb, filename = "output/habitat_pred/s4_fp_lb.tif")
```



# Population viability analysis

## Greater Glider
```{r}
gg_trans_mat <- matrix(c(0.00,0.00,0.25,
                         0.50,0.00,0.00,
                         0.00,0.85,0.85),
                       nrow = 3, ncol = 3, byrow = TRUE) # based on Possingham et al 1994
colnames(gg_trans_mat) <- rownames(gg_trans_mat) <- c('Newborn','Juvenile','Adult')

gg_stable_states <- abs( eigen(gg_trans_mat)$vectors[,1] / base::sum(eigen(gg_trans_mat)$vectors[,1]) ) 
```


### Scenario 1
```{r}
s1_hs_gg <- stack(s1_ip_gg, s1_fp_gg)

for(i in 1:51){
  s1_hs_gg[[i]][is.na(s1_hs_gg[[i]][])] <- 0
}

s1_hs_gg <- mask(s1_hs_gg, mask = ch_mask)
```

```{r}
s1_hab_k_gg <- calc(s1_hs_gg[[1]], fun = function(x){if(is.na(x)) x else rbinom(prob = x, size = 3, n = 1)})

names(s1_hab_k_gg) <- "carryingCapacity"

s1_gg_popN <- stack(replicate(ncol(gg_trans_mat), s1_hab_k_gg))

s1_gg_popN <- s1_gg_popN*gg_stable_states

s1_gg_idx <- which(!is.na(s1_hs_gg[[1]][]) & s1_hs_gg[[1]][] < 0.95)

s1_gg_pop <- s1_gg_popN
s1_gg_pop[!is.na(s1_gg_pop)] <- 0
s1_gg_pop[[1]][sample(s1_gg_idx, 10000)] <- 1
s1_gg_pop[[2]][sample(s1_gg_idx, 10000)] <- 1
s1_gg_pop[[3]][sample(s1_gg_idx, 10000)] <- 1

s1_gg_pop <- s1_gg_pop*ch_mask

names(s1_gg_pop) <- colnames(gg_trans_mat)

s1_gg_TotpopN <- sum(cellStats(s1_gg_pop, 'sum', na.rm = TRUE)) # Get total population size to check sensible
s1_gg_init_pop_size <- sum(s1_gg_pop)
```

```{r}
s1_gg_landscape <- landscape(population = s1_gg_pop,
                          suitability = s1_hs_gg,
                          carrying_capacity = s1_hab_k_gg)

s1_gg_pop_dynamics <- population_dynamics(change = growth(transition_matrix = gg_trans_mat,
                                                       global_stochasticity = 0.1),
                                       dispersal = fast_dispersal(
                                         dispersal_kernel = exponential_dispersal_kernel(
                                           distance_decay = 8000)),
                                       modification = NULL)
```

```{r}
plan(sequential, workers = 1)
s1_gg_results_1_50 <- simulation(landscape = s1_gg_landscape,
                         population_dynamics = s1_gg_pop_dynamics,
                         habitat_dynamics = NULL,
                         timesteps = 50,
                         replicates = 1)


saveRDS(object = s1_gg_results_1_50, file = "output/pva_results/s1_gg_results_1_50.Rds")
```


```{r}
plot(s1_gg_results_1_50)
```

```{r}
plot(s1_gg_results_1_50[1], type = "raster", stages = 0, timesteps = c(1:5))
```

### Scenario 3
```{r}
s3_hs_gg <- stack(s3_ip_gg, s3_fp_gg)

for(i in 1:51){
  s3_hs_gg[[i]][is.na(s3_hs_gg[[i]][])] <- 0
}

s3_hs_gg <- mask(s3_hs_gg, mask = ch_mask)
```

```{r}
s3_hab_k_gg <- calc(s3_hs_gg[[1]], fun = function(x){if(is.na(x)) x else rbinom(prob = x, size = 3, n = 1)})

names(s3_hab_k_gg) <- "carryingCapacity"

s3_gg_popN <- stack(replicate(ncol(gg_trans_mat), s3_hab_k_gg))

s3_gg_popN <- s3_gg_popN*gg_stable_states

s3_gg_idx <- which(!is.na(s3_hs_gg[[1]][]) & s3_hs_gg[[1]][] < 0.95)

s3_gg_pop <- s3_gg_popN
s3_gg_pop[!is.na(s3_gg_pop)] <- 0
s3_gg_pop[[1]][sample(s3_gg_idx, 10000)] <- 1
s3_gg_pop[[2]][sample(s3_gg_idx, 10000)] <- 1
s3_gg_pop[[3]][sample(s3_gg_idx, 10000)] <- 1

s3_gg_pop <- s3_gg_pop*ch_mask

names(s3_gg_pop) <- colnames(gg_trans_mat)

s3_gg_TotpopN <- sum(cellStats(s3_gg_pop, 'sum', na.rm = TRUE)) # Get total population size to check sensible
s3_gg_init_pop_size <- sum(s3_gg_pop)
```

```{r}
s3_gg_landscape <- landscape(population = s3_gg_pop,
                          suitability = s3_hs_gg,
                          carrying_capacity = s3_hab_k_gg)

s3_gg_pop_dynamics <- population_dynamics(change = growth(transition_matrix = gg_trans_mat,
                                                       global_stochasticity = 0.1),
                                       dispersal = fast_dispersal(
                                         dispersal_kernel = exponential_dispersal_kernel(
                                           distance_decay = 8000)),
                                       modification = NULL)
```

```{r}
plan(sequential, workers = 1)
s3_gg_results_1_50 <- simulation(landscape = s3_gg_landscape,
                         population_dynamics = s3_gg_pop_dynamics,
                         habitat_dynamics = NULL,
                         timesteps = 50,
                         replicates = 1)


saveRDS(object = s3_gg_results_1_50, file = "output/pva_results/s3_gg_results_1_50.Rds")
```


```{r}
plot(s3_gg_results_1_50)
```

```{r}
plot(s3_gg_results_1_50[1], type = "raster", stages = 0, timesteps = c(1:5))
```

### Scenario 4
```{r}
s4_hs_gg <- stack(s4_ip_gg, s4_fp_gg)

for(i in 1:51){
  s4_hs_gg[[i]][is.na(s4_hs_gg[[i]][])] <- 0
}

s4_hs_gg <- mask(s4_hs_gg, mask = ch_mask)
```

```{r}
s4_hab_k_gg <- calc(s4_hs_gg[[1]], fun = function(x){if(is.na(x)) x else rbinom(prob = x, size = 3, n = 1)})

names(s4_hab_k_gg) <- "carryingCapacity"

s4_gg_popN <- stack(replicate(ncol(gg_trans_mat), s4_hab_k_gg))

s4_gg_popN <- s4_gg_popN*gg_stable_states

s4_gg_idx <- which(!is.na(s4_hs_gg[[1]][]) & s4_hs_gg[[1]][] < 0.95)

s4_gg_pop <- s4_gg_popN
s4_gg_pop[!is.na(s4_gg_pop)] <- 0
s4_gg_pop[[1]][sample(s4_gg_idx, 10000)] <- 1
s4_gg_pop[[2]][sample(s4_gg_idx, 10000)] <- 1
s4_gg_pop[[3]][sample(s4_gg_idx, 10000)] <- 1

s4_gg_pop <- s4_gg_pop*ch_mask

names(s4_gg_pop) <- colnames(gg_trans_mat)

s4_gg_TotpopN <- sum(cellStats(s4_gg_pop, 'sum', na.rm = TRUE)) # Get total population size to check sensible
s4_gg_init_pop_size <- sum(s4_gg_pop)
```

```{r}
s4_gg_landscape <- landscape(population = s4_gg_pop,
                          suitability = s4_hs_gg,
                          carrying_capacity = s4_hab_k_gg)

s4_gg_pop_dynamics <- population_dynamics(change = growth(transition_matrix = gg_trans_mat,
                                                       global_stochasticity = 0.1),
                                       dispersal = fast_dispersal(
                                         dispersal_kernel = exponential_dispersal_kernel(
                                           distance_decay = 8000)),
                                       modification = NULL)
```

```{r}
plan(sequential, workers = 1)
s4_gg_results_1_50 <- simulation(landscape = s4_gg_landscape,
                         population_dynamics = s4_gg_pop_dynamics,
                         habitat_dynamics = NULL,
                         timesteps = 50,
                         replicates = 1)


saveRDS(object = s4_gg_results_1_50, file = "output/pva_results/s4_gg_results_1_50.Rds")
```


```{r}
plot(s4_gg_results_1_50)
```

```{r}
plot(s4_gg_results_1_50[1], type = "raster", stages = 0, timesteps = c(1:5))
```


## Leadbeater's Possum
```{r}
lb_trans_mat <- matrix(c(0.00, 0.00, 1.10,
                         0.59, 0.00, 0.00,
                         0.00, 0.59, 0.79),
                       nrow = 3, ncol = 3, byrow = TRUE) 
colnames(lb_trans_mat) <- rownames(lb_trans_mat) <- c('Newborn','Juvenile','Adult')

lb_stable_states <- abs( eigen(lb_trans_mat)$vectors[,1] / base::sum(eigen(lb_trans_mat)$vectors[,1]) ) 
```

### Scenario 1
```{r}
s1_hs_lb <- stack(s1_ip_lb, s1_fp_lb)

for(i in 1:51){
  s1_hs_lb[[i]][is.na(s1_hs_lb[[i]][])] <- 0
}

s1_hs_lb <- mask(s1_hs_lb, mask = ch_mask)
```

```{r}
s1_hab_k_lb <- calc(s1_hs_lb[[1]], fun = function(x){if(is.na(x)) x else rbinom(prob = x, size = 3, n = 1)})

names(s1_hab_k_lb) <- "carryingCapacity"

s1_lb_popN <- stack(replicate(ncol(lb_trans_mat), s1_hab_k_lb))

s1_lb_popN <- s1_lb_popN*lb_stable_states

s1_lb_idx <- which(!is.na(s1_hs_lb[[1]][]) & s1_hs_lb[[1]][] < 0.95)

s1_lb_pop <- s1_lb_popN
s1_lb_pop[!is.na(s1_lb_pop)] <- 0
s1_lb_pop[[1]][sample(s1_lb_idx, 3000)] <- 1
s1_lb_pop[[2]][sample(s1_lb_idx, 3000)] <- 1
s1_lb_pop[[3]][sample(s1_lb_idx, 3000)] <- 1

s1_lb_pop <- s1_lb_pop*ch_mask

names(s1_lb_pop) <- colnames(lb_trans_mat)

s1_lb_TotpopN <- sum(cellStats(s1_lb_pop, 'sum', na.rm = TRUE)) # Get total population size to check sensible
s1_lb_init_pop_size <- sum(s1_lb_pop)
```

```{r}
s1_lb_landscape <- landscape(population = s1_lb_pop,
                          suitability = s1_hs_lb,
                          carrying_capacity = s1_hab_k_lb)

s1_lb_pop_dynamics <- population_dynamics(change = growth(transition_matrix = lb_trans_mat,
                                                       global_stochasticity = 0.3),
                                       dispersal = fast_dispersal(
                                         dispersal_kernel = exponential_dispersal_kernel(
                                           distance_decay = 2000)),
                                       modification = NULL)
```

```{r}
plan(sequential, workers = 1)
s1_lb_results_1_50 <- simulation(landscape = s1_lb_landscape,
                         population_dynamics = s1_lb_pop_dynamics,
                         habitat_dynamics = NULL,
                         timesteps = 50,
                         replicates = 1)


saveRDS(object = s1_lb_results_1_50, file = "output/pva_results/s1_lb_results_1_50.Rds")
```


```{r}
plot(s1_lb_results_1_50)
```

```{r}
plot(s1_lb_results_1_50[1], type = "raster", stages = 0, timesteps = c(1:5))
```

### Scenario 3
```{r}
s3_hs_lb <- stack(s3_ip_lb, s3_fp_lb)

for(i in 1:51){
  s3_hs_lb[[i]][is.na(s3_hs_lb[[i]][])] <- 0
}

s3_hs_lb <- mask(s3_hs_lb, mask = ch_mask)
```

```{r}
s3_hab_k_lb <- calc(s3_hs_lb[[1]], fun = function(x){if(is.na(x)) x else rbinom(prob = x, size = 3, n = 1)})

names(s3_hab_k_lb) <- "carryingCapacity"

s3_lb_popN <- stack(replicate(ncol(lb_trans_mat), s3_hab_k_lb))

s3_lb_popN <- s3_lb_popN*lb_stable_states

s3_lb_idx <- which(!is.na(s3_hs_lb[[1]][]) & s3_hs_lb[[1]][] < 0.95)

s3_lb_pop <- s3_lb_popN
s3_lb_pop[!is.na(s3_lb_pop)] <- 0
s3_lb_pop[[1]][sample(s3_lb_idx, 3000)] <- 1
s3_lb_pop[[2]][sample(s3_lb_idx, 3000)] <- 1
s3_lb_pop[[3]][sample(s3_lb_idx, 3000)] <- 1

s3_lb_pop <- s3_lb_pop*ch_mask

names(s3_lb_pop) <- colnames(lb_trans_mat)

s3_lb_TotpopN <- sum(cellStats(s3_lb_pop, 'sum', na.rm = TRUE)) # Get total population size to check sensible
s3_lb_init_pop_size <- sum(s3_lb_pop)
```

```{r}
s3_lb_landscape <- landscape(population = s3_lb_pop,
                          suitability = s3_hs_lb,
                          carrying_capacity = s3_hab_k_lb)

s3_lb_pop_dynamics <- population_dynamics(change = growth(transition_matrix = lb_trans_mat,
                                                       global_stochasticity = 0.1),
                                       dispersal = fast_dispersal(
                                         dispersal_kernel = exponential_dispersal_kernel(
                                           distance_decay = 8000)),
                                       modification = NULL)
```

```{r}
plan(sequential, workers = 1)
s3_lb_results_1_50 <- simulation(landscape = s3_lb_landscape,
                         population_dynamics = s3_lb_pop_dynamics,
                         habitat_dynamics = NULL,
                         timesteps = 50,
                         replicates = 1)


saveRDS(object = s3_lb_results_1_50, file = "output/pva_results/s3_lb_results_1_50.Rds")
```

```{r}
plot(s3_lb_results_1_50)
```

```{r}
plot(s3_lb_results_1_50[1], type = "raster", stages = 0, timesteps = c(1:5))
```

### Scenario 4
```{r}
s4_hs_lb <- stack(s4_ip_lb, s4_fp_lb)

for(i in 1:51){
  s4_hs_lb[[i]][is.na(s4_hs_lb[[i]][])] <- 0
}

s4_hs_lb <- mask(s4_hs_lb, mask = ch_mask)
```

```{r}
s4_hab_k_lb <- calc(s4_hs_lb[[1]], fun = function(x){if(is.na(x)) x else rbinom(prob = x, size = 3, n = 1)})

names(s4_hab_k_lb) <- "carryingCapacity"

s4_lb_popN <- stack(replicate(ncol(lb_trans_mat), s4_hab_k_lb))

s4_lb_popN <- s4_lb_popN*lb_stable_states

s4_lb_idx <- which(!is.na(s4_hs_lb[[1]][]) & s4_hs_lb[[1]][] < 0.95)

s4_lb_pop <- s4_lb_popN
s4_lb_pop[!is.na(s4_lb_pop)] <- 0
s4_lb_pop[[1]][sample(s4_lb_idx, 3000)] <- 1
s4_lb_pop[[2]][sample(s4_lb_idx, 3000)] <- 1
s4_lb_pop[[3]][sample(s4_lb_idx, 3000)] <- 1

s4_lb_pop <- s4_lb_pop*ch_mask

names(s4_lb_pop) <- colnames(lb_trans_mat)

s4_lb_TotpopN <- sum(cellStats(s4_lb_pop, 'sum', na.rm = TRUE)) # Get total population size to check sensible
s4_lb_init_pop_size <- sum(s4_lb_pop)
```

```{r}
s4_lb_landscape <- landscape(population = s4_lb_pop,
                          suitability = s4_hs_lb,
                          carrying_capacity = s4_hab_k_lb)

s4_lb_pop_dynamics <- population_dynamics(change = growth(transition_matrix = lb_trans_mat,
                                                       global_stochasticity = 0.1),
                                       dispersal = fast_dispersal(
                                         dispersal_kernel = exponential_dispersal_kernel(
                                           distance_decay = 8000)),
                                       modification = NULL)
```

```{r}
plan(sequential, workers = 1)
s4_lb_results_1_50 <- simulation(landscape = s4_lb_landscape,
                         population_dynamics = s4_lb_pop_dynamics,
                         habitat_dynamics = NULL,
                         timesteps = 50,
                         replicates = 1)


saveRDS(object = s4_lb_results_1_50, file = "output/pva_results/s4_lb_results_1_50.Rds")
```


```{r}
plot(s4_lb_results_1_50)
```

```{r}
plot(s4_lb_results_1_50[1], type = "raster", stages = 0, timesteps = c(1:5))
```


