---
title: "Victorian Forest Futures Population Vability Analysis: Central Highlands"
output: 
  html_notebook: 
    toc: yes
    number_sections: true
author: GE Ryan
date: 2019-08-05
---

# Project setup

### Packages
Install packages if necessary. Listed are installers for packages not on CRAN and the devlopment (most up-to-date) version of STEPS.
```{r install packages}
# library(devtools
# install_github("steps-dev/steps")
```

Load packages
```{r packages}
library(magrittr)
library(tidyr)
library(dplyr)
library(tibble)
library(sf)
library(lwgeom)
library(rgdal)
library(readr)
library(readxl)
library(ggplot2)
library(lubridate)
library(foreach)
library(doMC)
library(future)
library(future.apply)
library(tidyr)
library(dismo)
library(gbm)
library(steps)
library(raster)
```

### Functions
```{r functions}
source(file = "R/functions/pg.sf.R")
source(file = "R/functions/pg.pa.R")
source(file = "R/functions/read.vba.R")
source(file = "R/functions/proc.vba.R")
source(file = "R/functions/get.landis.vars.R")
source(file = "R/functions/rascc.R")
source(file = "R/functions/read.multi.line.header.R")
source(file = "R/functions/interpolate.climdat.R")
source(file = "R/functions/rst.op.R")
source(file = "R/functions/get.disturbance.R")
source(file = "R/functions/gbmstep.R")
source(file = "R/functions/brtpredict.R")
source(file = "R/functions/initpop.R")
source(file = "R/functions/parsim.R")
source(file = "R/functions/bind.simulation.repetitions.R")
source(file = "R/functions/get.stable.states.R")
source(file = "R/functions/rmax.R")
source(file = "R/functions/stackbrtpred.R")
source(file = "R/functions/gpr.R")
source(file = "R/functions/gps.R")
source(file = "R/functions/psr.R")
```

### Paths
```{r paths}
proj_path <- "/home/landis/rfst/"
# proj_path <- "D:/Users/ryan/Dropbox/Work/RFA_STEPS/rfst/"
```


# Prepare variables

## Analysis parameters

### Start year
```{r year0}
year0 <- 2019
```


### Timesteps
```{r ntimesteps}
ntimesteps <- 50
```

### Cores to use
```{r ncores}
ncores <- 20
```

```{r}
res <- 600
width.png <- 3200
height.png <- 2000
```

## Geographic data

### Landscape
Set up base landscape layer
```{r ch_rst}
ch_rst <- raster(x = "data/grids/eco_v12.img") %T>%
  plot
```

```{r}
png(file = "output/plots/ch_rst.png",
    width = width.png,
    height = height.png, res = res)
plot(ch_rst)
dev.off()
```


```{r}
ch_ic <- raster(x = "~/s1/IC_2019_V6.img") %T>%
  plot
```

```{r}
png(file = "output/plots/ch_ic.png",
    width = width.png,
    height = height.png, res = res)
plot(ch_ic)
dev.off()
```

```{r proj ext res}
ch_proj <- ch_rst@crs
ch_extent <- extent(ch_rst)
ch_res <- res(ch_rst)
```

### Boundaries
```{r rfa}
rfa <- read_sf("data/shapefiles/RFA/")%>%
  st_transform(crs = ch_proj)
rfa
```

```{r plot rfa}
pg.sf(rfa)
```

```{r ch_rfa}
ch_rfa <- rfa[rfa$NAME== "CENTRAL HIGHLANDS",] 

ch_rfa
```

```{r plot ch_rfa}
pg.sf(ch_rfa)
```


```{r ch_mask}
ch_mask <- rasterize(ch_rfa, ch_rst, field = 1, filename = "./output/landscape_vars/ch_mask.grd", overwrite = TRUE) 

ch_mask[ch_rst == 132] <- NA # removes lake areas from habitat

plot(ch_mask)
```
*Think carefully about using this layer as projections are for zone 55, so distorts west of the state*
```{r victoria}
victoria <- read_sf("data/shapefiles/vicstatepolygon/") %>%
   st_transform(crs = ch_proj)
```

### Landscape management

#### Fire history
```{r fire_history}
fire_history <- read_sf("data/shapefiles/vicfires/fire_history_lastburnt.shp") %>%
  st_transform(crs = ch_proj) %>%
  st_make_valid %>%
  st_crop(y = st_bbox(ch_rst)) %>%
  rasterize(y = ch_mask, field = "SEASON", fun = max, background = 1850) %>%
  mask(mask = ch_mask, filename = "output/landscape_vars/fire_history.grd", overwrite = TRUE)

fire_history
```

```{r plot fire_history}
plot(fire_history)
```
```{r}
png(file = "output/plots/fire_history.png",
    width = width.png,
    height = height.png, res = res)
plot(fire_history)
dev.off()
```

#### Logging history
```{r logging_history}
logging_history <- read_sf("data/shapefiles/viclogging/lastlog25.shp") %>%
  st_transform(crs = ch_proj) %>%
  st_make_valid %>%
  st_crop(y = st_bbox(ch_rst)) %>%
  mutate(season = SEASON %>% substr(1,4) %>% as.numeric) %>%
  rasterize(y = ch_mask, field = "season", fun = max, background = 1750) %>%
  mask(mask = ch_mask, filename = "output/landscape_vars/logging_history.grd", overwrite = TRUE)

logging_history
```

```{r plot logging_history}
plot(logging_history)
```

```{r}
png(file = "output/plots/logging_history.png",
    width = width.png,
    height = height.png, res = res)
plot(logging_history)
dev.off()
```


## Occurrence data

### GG Occurrence data
Read in data
```{r gg_ari}
gg_ari <- read_excel(path = "data/tabular/BoA_SB_Combined_VBA_upload_v4.xls") %>%
  dplyr::select(-starts_with("leave")) %>%
  rename("lon" = `X-coordinate (easting or longitude)`, "lat" = `Y-coordinate (northing or latitude)`) %>%
   fill(lon, lat, .direction = "down") %>%
  filter(`Taxon Name` == "Misc Target taxa not found") %>%
  dplyr::select(lon, lat) %>%
  mutate(PA = 0) %>%
  st_as_sf(coords = c("lon", "lat"), crs = st_crs(28355)) %>%
  st_transform(crs = st_crs(ch_rst))

gg_ari
```

```{r gg_vba}
gg_vba <- proc.vba("data/tabular/vba_gg_all_20190509.csv", project.crs = ch_proj)

gg_vba
```

```{r gg_pa_all}
gg_pa_all <- gg_vba %>%
  rbind(gg_ari)

gg_pa_all
```

```{r plot_gg_pa_all}
plot_gg_pa_all <- pg.pa(gg_pa_all, ch_rfa) +
  geom_sf(data = victoria, fill = NA)

plot_gg_pa_all
```

```{r}
png(file = "output/plots/gg_pa_all.png",
    width = width.png,
    height = height.png, res = res)

plot_gg_pa_all
dev.off()
```


```{r gg_pa_ch}
gg_pa_ch <- gg_pa_all[ch_rfa,]
gg_pa_ch
```

```{r bg_gg}
buffpres_gg_ch <-st_buffer(gg_pa_ch %>% filter(PA == 1), 3000) %>%
  rasterize(y = ch_mask, field = 1, filename = "output/landscape_vars/pointmask_gg_ch.grd", overwrite = TRUE)

pointmask_gg_ch <- ch_mask

pointmask_gg_ch[buffpres_gg_ch == 1] <- NA

bg_gg <- randomPoints(pointmask_gg_ch, 1000) %>%
  as.data.frame %>%
  mutate(PA = 0) %>%
  st_as_sf(coords = c("x", "y"), crs = ch_proj)

bg_gg
```



```{r gg_pa_ch_psab}
gg_pa_ch_psab <- gg_pa_ch %>%
  rbind(bg_gg)
```

```{r}
gg_old <- read_csv("data/tabular/archive/vicAtlasGGpresabs.csv") %>%
  st_as_sf(coords = c("LongitudeGDA94", "LatitudeGDA94"), crs = 4326) %>%
   st_transform(crs = ch_proj)

gg_old <- gg_old[ch_rfa,]
```


```{r write gg_pa_ch}
st_write(gg_pa_ch, "output/shapefiles/pa/ch/gg_pa_ch.shp", delete_layer = TRUE)
st_write(gg_pa_ch_psab, "output/shapefiles/pa/ch/gg_pa_ch_psab.shp", delete_layer = TRUE)
```

```{r}
pg_gg_pa_ch <- pg.pa(gg_pa_ch, ch_rfa)
pg_gg_pa_ch
```

```{r}
png(file = "output/plots/gg_pa_ch.png",
    width = width.png,
    height = height.png, res = res)

pg_gg_pa_ch

dev.off()
```


```{r pg_gg_pa_ch_ps}
pg_gg_pa_ch_ps <- pg.pa(gg_pa_ch %>% mutate(pseudo_abs = "vba") %>% rbind(bg_gg %>% mutate(pseudo_abs = "pseudo_absences")), ch_rfa) +
  facet_grid(.~pseudo_abs)

pg_gg_pa_ch_ps
```
```{r}
png(file = "output/plots/gg_pa_ch_ps.png",
    width = width.png,
    height = height.png, res = res)

pg_gg_pa_ch_ps

dev.off()
```


### LBP Occurrence data
```{r read lb occ}
lb_pa_all <- proc.vba("data/tabular/vba_lb_all_20190509.csv", project.crs = ch_proj)
```

```{r plot_lb_pa_all}
plot_lb_pa_all <- pg.pa(lb_pa_all, ch_rfa) +
  geom_sf(data = victoria, fill = NA)

plot_lb_pa_all
```

```{r}
png(file = "output/plots/lv_pa_all.png",
    width = width.png,
    height = height.png, res = res)

plot_lb_pa_all
dev.off()
```


```{r lb_pa_ch}
lb_pa_ch <- lb_pa_all[ch_rfa,]
lb_pa_ch
```


```{r bg_lb}
buffpres_lb_ch <- st_buffer(lb_pa_ch %>% filter(PA == 1), 3000) %>%
  rasterize(y = ch_mask, field = 1, filename = "output/landscape_vars/pointmask_lb_ch.grd", overwrite = TRUE)

pointmask_lb_ch <- ch_mask

pointmask_lb_ch[buffpres_lb_ch == 1] <- NA

bg_lb <- randomPoints(pointmask_lb_ch, 1000) %>%
  as.data.frame %>%
  mutate(PA = 0) %>%
  st_as_sf(coords = c("x", "y"), crs = ch_proj)

bg_lb
```

```{r lb_pa_ch_psab}
lb_pa_ch_psab <- lb_pa_ch %>%
  rbind(bg_lb)
```


```{r write lbp_pa_ch}
st_write(lb_pa_ch, "output/shapefiles/pa/ch/lb_pa_ch.shp", delete_layer = TRUE)
st_write(lb_pa_ch_psab, "output/shapefiles/pa/ch/lb_pa_ch_psab.shp", delete_layer = TRUE)
```

```{r}
pg_lb_pa_ch <- pg.pa(lb_pa_ch, ch_rfa)
pg_lb_pa_ch
```

```{r}
png(file = "output/plots/lb_pa_ch.png",
    width = width.png,
    height = height.png, res = res)
pg_lb_pa_ch

dev.off()
```


```{r pg_lb_pa_ch_ps}
pg_lb_pa_ch_ps <- pg.pa(lb_pa_ch %>% mutate(pseudo_abs = "vba") %>% rbind(bg_lb %>% mutate(pseudo_abs = "pseudo_absences")), ch_rfa) +
  facet_grid(.~pseudo_abs)

pg_lb_pa_ch_ps
```
```{r}
png(file = "output/plots/lb_pa_ch_ps.png",
    width = width.png,
    height = height.png, res = res)
pg_lb_pa_ch_ps

dev.off()
```


```{r save image occu}
save.image("output/session_images/landscape-occupancy.RData")
```

```{r load image occu}
#load(file = "output/session_images/landscape-occupancy.RData")
```


## Landis output

### Scenario 1: Current planned burning, current timber harvesting, climate change under RCP 4.5, current bushfire regime (Buisness as usual)
```{r s1_vars_landis}
s1_vars_landis <- get.landis.vars(
  scn_path = "~/s1/",
  proj_path = proj_path,
  out_path = "/output/habitat_vars/",
  scn_id = "s1",
  proj_mask = ch_mask,
  timesteps = ntimesteps,
  cores = ncores
  )
```

```{r plot s1_vars_landis initial}
plot(s1_vars_landis[[1]][[1:12]])
plot(s1_vars_landis[[1]][[13:22]])
```


```{r}
png(file = "output/plots/s1_vars_1.png",
    width = width.png,
    height = height.png, res = res)
plot(s1_vars_landis[[1]][[1:12]])

dev.off()

png(file = "output/plots/s1_vars_2.png",
    width = width.png,
    height = height.png, res = res)
plot(s1_vars_landis[[1]][[13:22]])

dev.off()
```


```{r}
saveGIF({
  for (i in 1:length(s1_vars_landis)){
    plot(s1_vars_landis[[i]][[20]], zlim = c(0,5))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s1_harvest.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s1_vars_landis)){
    plot(s1_vars_landis[[i]][[21]], zlim = c(0,5))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s1_firesev.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s1_vars_landis)){
    plot(s1_vars_landis[[i]][[1]], zlim = c(0,1))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s1_lbm.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s1_vars_landis)){
    plot(s1_vars_landis[[i]][[5]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s1_ggf_prop.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s1_vars_landis)){
    plot(s1_vars_landis[[i]][[13]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s1_prop_regnans.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s1_vars_landis)){
    plot(s1_vars_landis[[i]][[15]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s1_prop_150.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s1_vars_landis)){
    plot(s1_vars_landis[[i]][[16]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s1_prop_200.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s1_vars_landis)){
    plot(s1_vars_landis[[i]][[16]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s1_prop_oge.gif")
```



```{r plot s1_vars_landis last}
plot(s1_vars_landis[[ntimesteps + 1]][[1:12]])
plot(s1_vars_landis[[ntimesteps + 1]][[13:22]])
```


```{r s1_vars_landis save load}
save(s1_vars_landis, file = "output/habitat_vars/s1_vars_landis")

# load(file = "output/habitat_vars/s1_vars_landis_fut")
```

### Scenario 2: Current planned burning, current timber harvesting, climate change under RCP 8.5, increased bushfire regime (Buisness as usual)
```{r s2_vars_landis}
s2_vars_landis <- get.landis.vars(
  scn_path = "~/s2/",
  proj_path = proj_path,
  out_path = "/output/habitat_vars/",
  scn_id = "s2",
  proj_mask = ch_mask,
  timesteps = ntimesteps,
  cores = ncores
  )
```

```{r plot s2_vars_landis initial}
plot(s2_vars_landis[[1]][[1:12]])
plot(s2_vars_landis[[1]][[13:22]])
```

```{r plot s2_vars_landis last}
plot(s2_vars_landis[[ntimesteps + 1]][[1:12]])
plot(s2_vars_landis[[ntimesteps + 1]][[13:22]])
```


```{r}
saveGIF({
  for (i in 1:length(s2_vars_landis)){
    plot(s2_vars_landis[[i]][[20]], zlim = c(0,5))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s2_harvest.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s2_vars_landis)){
    plot(s2_vars_landis[[i]][[21]], zlim = c(0,5))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s2_firesev.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s2_vars_landis)){
    plot(s2_vars_landis[[i]][[1]], zlim = c(0,1))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s2_lbm.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s2_vars_landis)){
    plot(s2_vars_landis[[i]][[5]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s2_ggf_prop.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s2_vars_landis)){
    plot(s2_vars_landis[[i]][[13]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s2_prop_regnans.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s2_vars_landis)){
    plot(s2_vars_landis[[i]][[15]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s2_prop_150.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s2_vars_landis)){
    plot(s2_vars_landis[[i]][[16]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s2_prop_200.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s2_vars_landis)){
    plot(s2_vars_landis[[i]][[16]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s2_prop_oge.gif")
```




```{r s2_vars_landis save load}
save(s2_vars_landis, file = "output/habitat_vars/s2_vars_landis")

# load(file = "output/habitat_vars/s2_vars_landis_fut")
```


### Scenario 3: Current planned burning, current timber harvesting, no climate change, current bushfire regime
```{r s3_vars_landis}
s3_vars_landis <- get.landis.vars(
  scn_path = "~/s3/",
  proj_path = proj_path,
  out_path = "/output/habitat_vars/",
  scn_id = "s3",
  proj_mask = ch_mask,
  timesteps = ntimesteps,
  cores = ncores
  )
```

```{r plot s3_vars_landis initial}
plot(s3_vars_landis[[1]][[1:12]])
plot(s3_vars_landis[[1]][[13:22]])
```

```{r plot s3_vars_landis last}
plot(s3_vars_landis[[ntimesteps + 1]][[1:12]])
plot(s3_vars_landis[[ntimesteps + 1]][[13:22]])
```


```{r s3_vars_landis save load}
save(s3_vars_landis, file = "output/habitat_vars/s3_vars_landis")

# load(file = "output/habitat_vars/s3_vars_landis_fut")
```

```{r}
saveGIF({
  for (i in 1:length(s3_vars_landis)){
    plot(s3_vars_landis[[i]][[20]], zlim = c(0,5))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s3_harvest.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s3_vars_landis)){
    plot(s3_vars_landis[[i]][[21]], zlim = c(0,5))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s3_firesev.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s3_vars_landis)){
    plot(s3_vars_landis[[i]][[1]], zlim = c(0,1))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s3_lbm.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s3_vars_landis)){
    plot(s3_vars_landis[[i]][[5]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s3_ggf_prop.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s3_vars_landis)){
    plot(s3_vars_landis[[i]][[13]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s3_prop_regnans.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s3_vars_landis)){
    plot(s3_vars_landis[[i]][[15]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s3_prop_150.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s3_vars_landis)){
    plot(s3_vars_landis[[i]][[16]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s3_prop_200.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s3_vars_landis)){
    plot(s3_vars_landis[[i]][[16]], zlim = c(0,1))
    title(main = paste0("Year ",i-1))
  }
}, interval = 0.2, movie.name = "s3_prop_oge.gif")
```

```{r}
1+,
```

### Scenario 4: Current planned burning, no harvesting, climate change under RCP 4.5, current bushfire regime
```{r s4_vars_landis}
s4_vars_landis <- get.landis.vars(
  scn_path = "~/landis_ch_s4_pb-th0-cc_50/",
  proj_path = proj_path,
  out_path = "/output/habitat_vars/",
  scn_id = "s4",
  proj_mask = ch_mask,
  timesteps = ntimesteps,
  cores = ncores,
  harvest_timber = FALSE
  )
```

```{r plot s4_vars_landis initial}
plot(s4_vars_landis[[1]][[1:12]])
plot(s4_vars_landis[[1]][[13:22]])
```

```{r plot s4_vars_landis last}
plot(s4_vars_landis[[ntimesteps + 1]][[1:12]])
plot(s4_vars_landis[[ntimesteps + 1]][[13:22]])
```

```{r s4_vars_landis save load}
save(s4_vars_landis, file = "output/habitat_vars/s4_vars_landis")

# load(file = "output/habitat_vars/s4_vars_landis_fut")
```

## Disturbance variables
Rely on landis output and land history.

### Time since fire

#### Scenario 1:
```{r s1_fire_vars}
s1_fire_vars <- get.disturbance(disturbances =  lapply(s1_vars_landis, FUN = function(x){x[["firesev"]]}),
                                disturbance_history = fire_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s1",
                                layernames = c("fihi", "tsf"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial fire history
```{r plot s1_fire_vars fire history initial}
plot(s1_fire_vars[[1]][["fihi"]])
```

Last fire history
```{r plot s1_fire_vars fire history last}
plot(s1_fire_vars[[ntimesteps + 1]][["fihi"]])
```

Initial time since fire
```{r plot s1_fire_vars time since fire initial}
plot(s1_fire_vars[[1]][["tsf"]])
```

Last time since fire
```{r plot s1_fire_var time since fire last}
plot(s1_fire_vars[[ntimesteps + 1]][["tsf"]])
```


```{r}
saveGIF({
  for (i in 1:length(s1_vars_landis)){
    plot(s1_fire_vars[[i]][[1]], zlim = c(1850,2070))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s1_fihi.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s1_vars_landis)){
    plot(s1_fire_vars[[i]][[2]], zlim = c(0, 220))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s1_tsf.gif")
```


#### Scenario 2
```{r s2_fire_vars}
s2_fire_vars <- get.disturbance(disturbances =  lapply(s2_vars_landis, FUN = function(x){x[["firesev"]]}),
                                disturbance_history = fire_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s2",
                                layernames = c("fihi", "tsf"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial fire history
```{r plot s2_fire_vars fire history initial}
plot(s2_fire_vars[[1]][["fihi"]])
```

Last fire history
```{r plot s2_fire_vars fire history last}
plot(s2_fire_vars[[ntimesteps + 1]][["fihi"]])
```

Initial time since fire
```{r plot s2_fire_vars time since fire initial}
plot(s2_fire_vars[[1]][["tsf"]])
```

Last time since fire
```{r plot s2_fire_var time since fire last}
plot(s2_fire_vars[[ntimesteps + 1]][["tsf"]])
```


```{r}
saveGIF({
  for (i in 1:length(s2_fire_vars)){
    plot(s2_fire_vars[[i]][[1]], zlim = c(1850,2070))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s2_fihi.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s2_fire_vars)){
    plot(s2_fire_vars[[i]][[2]], zlim = c(0, 220))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s2_tsf.gif")
```

#### Scenario 3
```{r s3_fire_vars}
s3_fire_vars <- get.disturbance(disturbances =  lapply(s3_vars_landis, FUN = function(x){x[["firesev"]]}),
                                disturbance_history = fire_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s3",
                                layernames = c("fihi", "tsf"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial fire history
```{r plot s3_fire_vars fire history initial}
plot(s3_fire_vars[[1]][["fihi"]])
```

Last fire history
```{r plot s3_fire_vars fire history last}
plot(s3_fire_vars[[ntimesteps + 1]][["fihi"]])
```

Initial time since fire
```{r plot s3_fire_vars time since fire initial}
plot(s3_fire_vars[[1]][["tsf"]])
```

Last time since fire
```{r plot s3_fire_var time since fire last}
plot(s3_fire_vars[[ntimesteps + 1]][["tsf"]])
```


```{r}
saveGIF({
  for (i in 1:length(s3_fire_vars)){
    plot(s3_fire_vars[[i]][[1]], zlim = c(1850,2070))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s3_fihi.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s3_fire_vars)){
    plot(s3_fire_vars[[i]][[2]], zlim = c(0, 220))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s3_tsf.gif")
```

#### Scenario 4
```{r s4_fire_vars}
s4_fire_vars <- get.disturbance(disturbances =  lapply(s4_vars_landis, FUN = function(x){x[["firesev"]]}),
                                disturbance_history = fire_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s4",
                                layernames = c("fihi", "tsf"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial fire history
```{r plot s4_fire_vars fire history initial}
plot(s4_fire_vars[[1]][["fihi"]])
```

Last fire history
```{r plot s4_fire_vars fire history last}
plot(s4_fire_vars[[ntimesteps + 1]][["fihi"]])
```

Initial time since fire
```{r plot s4_fire_vars time since fire initial}
plot(s4_fire_vars[[1]][["tsf"]])
```

Last time since fire
```{r plot s4_fire_var time since fire last}
plot(s4_fire_vars[[ntimesteps + 1]][["tsf"]])
```



### Time since logging

#### Scenario 1:
```{r s1_logging_vars}
s1_logging_vars <- get.disturbance(disturbances =  lapply(s1_vars_landis, FUN = function(x){x[["harvest"]]}),
                                disturbance_history = logging_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s1",
                                layernames = c("lohi", "tsl"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial logging history
```{r plot s1_logging_vars logging history initial}
plot(s1_logging_vars[[1]][["lohi"]])
```

Last logging history
```{r plot s1_logging_vars logging history last}
plot(s1_logging_vars[[ntimesteps + 1]][["lohi"]])
```

Initial time since fire
```{r plot s1_logging_vars time since logging initial}
plot(s1_logging_vars[[1]][["tsl"]])
```

Last time since fire
```{r plot s1_logging_var time since logging last}
plot(s1_logging_vars[[ntimesteps + 1]][["tsl"]])
```

CHECK YEARS FOR ZLIM

```{r}
saveGIF({
  for (i in 1:length(s1_logging_vars)){
    plot(s1_logging_vars[[i]][[1]], zlim = c(1750,2070))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s1_lohi.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s1_logging_vars)){
    plot(s1_logging_vars[[i]][[2]], zlim = c(0, 220))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s1_tsl.gif")
```

#### Scenario 2
```{r s2_logging_vars}
s2_logging_vars <- get.disturbance(disturbances =  lapply(s2_vars_landis, FUN = function(x){x[["harvest"]]}),
                                disturbance_history = logging_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s2",
                                layernames = c("lohi", "tsl"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial logging history
```{r plot s2_logging_vars logging history initial}
plot(s2_logging_vars[[1]][["lohi"]])
```

Last logging history
```{r plot s2_logging_vars logging history last}
plot(s2_logging_vars[[ntimesteps + 1]][["lohi"]])
```

Initial time since fire
```{r plot s2_logging_vars time since logging initial}
plot(s2_logging_vars[[1]][["tsl"]])
```

Last time since fire
```{r plot s2_logging_var time since logging last}
plot(s2_logging_vars[[ntimesteps + 1]][["tsl"]])
```

```{r}
saveGIF({
  for (i in 1:length(s2_logging_vars)){
    plot(s2_logging_vars[[i]][[1]], zlim = c(1750,2070))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s2_lohi.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s2_logging_vars)){
    plot(s2_logging_vars[[i]][[2]], zlim = c(0, 220))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s2_tsl.gif")
```

#### Scenario 3
```{r s3_logging_vars}
s3_logging_vars <- get.disturbance(disturbances =  lapply(s3_vars_landis, FUN = function(x){x[["harvest"]]}),
                                disturbance_history = logging_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s3",
                                layernames = c("lohi", "tsl"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial logging history
```{r plot s3_logging_vars logging history initial}
plot(s3_logging_vars[[1]][["lohi"]])
```

Last logging history
```{r plot s3_logging_vars logging history last}
plot(s3_logging_vars[[ntimesteps + 1]][["lohi"]])
```

Initial time since fire
```{r plot s3_logging_vars time since logging initial}
plot(s3_logging_vars[[1]][["tsl"]])
```

Last time since fire
```{r plot s3_logging_var time since logging last}
plot(s3_logging_vars[[ntimesteps + 1]][["tsl"]])
```

```{r}
saveGIF({
  for (i in 1:length(s3_logging_vars)){
    plot(s3_logging_vars[[i]][[1]], zlim = c(1750,2070))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s3_lohi.gif")
```

```{r}
saveGIF({
  for (i in 1:length(s3_logging_vars)){
    plot(s3_logging_vars[[i]][[2]], zlim = c(0, 220))
    title(main = paste0("Year ", i-1))
  }
}, interval = 0.2, movie.name = "s3_tsl.gif")
```

#### Scenario 4
```{r s4_logging_vars}
s4_logging_vars <- get.disturbance(disturbances =  lapply(s4_vars_landis, FUN = function(x){x[["harvest"]]}),
                                disturbance_history = logging_history,
                                out_path = "output/landscape_vars/",
                                scn_id = "s4",
                                layernames = c("lohi", "tsl"),
                                ntimesteps = ntimesteps,
                                year0 = year0)
```
Initial logging history
```{r plot s4_logging_vars logging history initial}
plot(s4_logging_vars[[1]][["lohi"]])
```

Last logging history
```{r plot s4_logging_vars logging history last}
plot(s4_logging_vars[[ntimesteps + 1]][["lohi"]])
```

Initial time since fire
```{r plot s4_logging_vars time since logging initial}
plot(s4_logging_vars[[1]][["tsl"]])
```

Last time since fire
```{r plot s4_logging_var time since logging last}
plot(s4_logging_vars[[ntimesteps + 1]][["tsl"]])
```




## ARI Data

### Anisotronic heating x ruggedness
```{r ahr}
ahr <-raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/Anisotrophic_Heating_Ruggedness") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_ahr.grd", overwrite = TRUE) %T>%
  plot
```

### Log verticical distance all wetlands
```{r lvdaw}
lvdaw <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/log_vertical_distance_all_wetlands_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_lvdaw.grd", overwrite = TRUE) %T>%
  plot
```
### Log vertical distance major streams
```{r lvdma}
lvdma <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/log_vertical_distance_major_streams_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_lvdma.grd", overwrite = TRUE) %T>%
  plot
```
### Log vertical distance minor streams
```{r lvdmi}
lvdmi <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/log_vertical_distance_minor_streams_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_lvdmi.grd", overwrite = TRUE) %T>%
  plot
```
### Log vertical distance saline wetlands
```{r lvdsw}
lvdsw <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/log_vertical_distance_saline_wetlands_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_lvdsw.grd", overwrite = TRUE) %T>%
  plot
```
### Relative annual insolation
```{r rai}
rai <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/relative_annual_insolation_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_rai.grd", overwrite = TRUE) %T>%
  plot
```
### Thorium
```{r tho}
tho <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/sept2014thorium") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_tho.grd", overwrite = TRUE) %T>%
  plot
```

### Visible sky index
```{r vsky}
vsky <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/visible_sky_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_vsky.grd", overwrite = TRUE) %T>%
  plot
```

### Topographic wetness index
```{r twi}
twi <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/wetness_index_topocrop_sept2012") %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/habitat_vars/ari_twi.grd", overwrite = TRUE) %T>%
  plot
```

### Wind exposition
**Problem with layer**
```{r winex}
# winex <- raster(x = "data/grids/Env_covariates_noClimate_VicGrid94/wind_exposition2015") %>%
  # projectRaster(to = ch_mask) %>%
  # mask(mask = ch_mask, filename = "output/habitat_vars/ari_winex.grd", overwrite = TRUE) %T>%
  # plot
```

### ARI variables stack

#### Initial variables
```{r ari_iv}
ari_iv <- stack(lvdaw, lvdma, lvdmi, lvdsw)

names(ari_iv) <- c("lvdaw", "lvdma", "lvdmi", "lvdsw")
```

#### Future variables 
Repeates into list for each year
```{r ari_v}
ari_v <- vector("list", ntimesteps + 1)

for(i in 1:(ntimesteps+1)){
  ari_v[[i]] <- ari_iv
}
```



## Climactic data
pc ~ percentage change
ac ~ absolute change

tmax ~ max temperature
tmin ~ minimum temperature
prec ~ precipitation
evtr ~ evapotranspiration

01 ~ January
07 ~ July

4.5 ~ rcp 4.5
8.5 ~ rcp 8.5


### Current climate
From WorldClim
#### Max temperature in January
```{r tmax01}
tmax01 <- getData(name = "worldclim", var = "tmax", path = paste0(proj_path, "/output/wc_30sec/tmax/"), res = 0.5, lat = -60, lon = 120)[[1]] %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/clim_vars/tmax01.grd", overwrite = TRUE)

names(tmax01) <- "tmax01"

plot(tmax01)
```

#### Minimum temperature in July
```{r tmin07}
tmin07 <- getData(name = "worldclim", var = "tmin", path = paste0(proj_path, "/output/wc_30sec/tmin/"), res = 0.5, lat = -60, lon = 120)[[7]] %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/clim_vars/tmin07.grd", overwrite = TRUE)

names(tmin07) <- "tmin07"

plot(tmin07)
```
#### Precipitation in January
```{r prec01}
prec01 <- getData(name = "worldclim", var = "prec", path = paste0(proj_path, "/output/wc_30sec/prec/"), res = 0.5, lat = -60, lon = 120)[[1]] %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/clim_vars/prec01.grd", overwrite = TRUE)

names(prec01) <- "prec01"

plot(prec01)
```

#### Precipitation in July
```{r prec07}
prec07 <- getData(name = "worldclim", var = "prec", path = paste0(proj_path, "/output/wc_30sec/prec/"), res = 0.5, lat = -60, lon = 120)[[7]] %>%
  projectRaster(to = ch_mask) %>%
  mask(mask = ch_mask, filename = "output/clim_vars/prec07.grd", overwrite = TRUE)

names(prec07) <- "prec07"

plot(prec07)
```




### Future climate
Data from [Climate Change in Australia](https://www.climatechangeinaustralia.gov.au/en/)

#### Change data
*There should be new data to replace this *
##### Absolute change in temperature
Get raw data
```{r raw temp ac}
#absolute change in temp
raw_tmax01_4.5_ac <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/tasmax_Amon_CSIRO-Mk3-6-0_rcp45_r1i1p1_abs-change-wrt-seasavg-clim_native.csv?tasmax_january[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")

raw_tmax01_8.5_ac <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/tasmax_Amon_CSIRO-Mk3-6-0_rcp85_r1i1p1_abs-change-wrt-seasavg-clim_native.csv?tasmax_january[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")

raw_tmin07_4.5_ac <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/tasmin_Amon_CSIRO-Mk3-6-0_rcp45_r1i1p1_abs-change-wrt-seasavg-clim_native.csv?tasmin_july[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]") 

raw_tmin07_8.5_ac <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/tasmin_Amon_CSIRO-Mk3-6-0_rcp85_r1i1p1_abs-change-wrt-seasavg-clim_native.csv?tasmin_july[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")
```
Years data available
```{r n temp ac}
n_tmax01_4.5 <- as.numeric(sub("-.*", "", unique(raw_tmax01_4.5_ac$time)))
n_tmax01_8.5 <- as.numeric(sub("-.*", "", unique(raw_tmax01_8.5_ac$time)))
n_tmin07_4.5 <- as.numeric(sub("-.*", "", unique(raw_tmin07_4.5_ac$time)))
n_tmin07_8.5 <- as.numeric(sub("-.*", "", unique(raw_tmin07_8.5_ac$time)))
```

Reprojected layers
```{r rasters temp ac}
tmax01_4.5_ac <- rascc(raw_tmax01_4.5_ac, new.proj.layer = ch_mask, filename = "output/clim_vars/tmax01_4.5_ac.grd")
tmax01_8.5_ac <- rascc(raw_tmax01_8.5_ac, new.proj.layer = ch_mask, filename = "output/clim_vars/tmax01_8.5_ac.grd")
tmin07_4.5_ac <- rascc(raw_tmin07_4.5_ac, new.proj.layer = ch_mask, filename = "output/clim_vars/tmin07_4.5_ac.grd")
tmin07_8.5_ac <- rascc(raw_tmin07_8.5_ac, new.proj.layer = ch_mask, filename = "output/clim_vars/tmin07_8.5_ac.grd")
```

##### Percentage change in precipitation
Get raw data
```{r raw prec pc}
raw_prec01_4.5_pc <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/pr_Amon_CSIRO-Mk3-6-0_rcp45_r1i1p1_perc-change-wrt-seassum-clim_native.csv?pr_january[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")

raw_prec01_8.5_pc <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/pr_Amon_CSIRO-Mk3-6-0_rcp85_r1i1p1_perc-change-wrt-seassum-clim_native.csv?pr_january[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")

raw_prec07_4.5_pc <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/pr_Amon_CSIRO-Mk3-6-0_rcp45_r1i1p1_perc-change-wrt-seassum-clim_native.csv?pr_july[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")

raw_prec07_8.5_pc <- read.multi.line.header(file = "http://nrm-erddap.nci.org.au/erddap/griddap/pr_Amon_CSIRO-Mk3-6-0_rcp85_r1i1p1_perc-change-wrt-seassum-clim_native.csv?pr_july[(2025-01-01T12:00:00Z):1:(2090-01-01T12:00:00Z)][(-40.10297775):1:(-32.64199448)][(140.625):1:(150)]")
```

Years data available
```{r n prec pc}
n_prec01_4.5 <- as.numeric(sub("-.*", "", unique(raw_prec01_4.5_pc$time)))
n_prec01_8.5 <- as.numeric(sub("-.*", "", unique(raw_prec01_4.5_pc$time)))
n_prec07_4.5 <- as.numeric(sub("-.*", "", unique(raw_prec07_4.5_pc$time)))
n_prec07_8.5 <- as.numeric(sub("-.*", "", unique(raw_prec07_4.5_pc$time)))
```

Reprojected layers
```{r raster prec pc}
prec01_4.5_pc <- rascc(raw_prec01_4.5_pc, new.proj.layer = ch_mask, filename = "output/clim_vars/prec01_4.5_pc.grd")
prec01_8.5_pc <- rascc(raw_prec01_8.5_pc, new.proj.layer = ch_mask, filename = "output/clim_vars/prec01_8.5_pc.grd")
prec07_4.5_pc <- rascc(raw_prec07_4.5_pc, new.proj.layer = ch_mask, filename = "output/clim_vars/prec07_4.5_pc.grd")
prec07_8.5_pc <- rascc(raw_prec07_8.5_pc, new.proj.layer = ch_mask, filename = "output/clim_vars/prec07_8.5_pc.grd")
```



####  Absolute predicted values

##### Temperature

add new function that writes these climate layers to files.


###### Jan max temperature RCP 4.5
```{r tmax01_4.5}
tmax01_4.5 <- rst.op(input1 = tmax01,
                     input2 = tmax01_4.5_ac,
                     proj_mask = ch_mask,
                     op = "addabs",
                     filename = "output/clim_vars/tmax01_4.5",
                     layernames = n_tmax01_4.5) %T>%
  plot
```

###### Jan max temperature RCP 8.5
```{r tmax01_8.5}
tmax01_8.5 <- rst.op(input1 = tmax01,
                     input2 = tmax01_8.5_ac,
                     proj_mask = ch_mask,
                     op = "addabs",
                     filename = "output/clim_vars/tmax01_8.5",
                     layernames = n_tmax01_8.5) %T>%
  plot
```
###### July min temperature RCP 4.5
```{r tmin07_4.5}
tmin07_4.5 <- rst.op(input1 = tmin07,
                     input2 = tmin07_4.5_ac,
                     proj_mask = ch_mask,
                     op = "addabs",
                     filename = "output/clim_vars/tmin07_4.5",
                     layernames = n_tmin07_4.5) %T>%
  plot
```

###### July min temperature RCP 8.5
```{r tmin07_8.5}
tmin07_8.5 <- rst.op(input1 = tmin07,
                     input2 = tmin07_8.5_ac,
                     proj_mask = ch_mask,
                     op = "addabs",
                     filename = "output/clim_vars/tmin07_8.5",
                     layernames = n_tmin07_8.5) %T>%
  plot
```

##### Precipitation

##### January precipitation RCP 4.5
```{r prec01_4.5}
prec01_4.5 <- rst.op(input1 = prec01,
                     input2 = prec01_4.5_pc,
                     proj_mask = ch_mask,
                     op = "addper",
                     filename = "output/clim_vars/prec01_4.5",
                     layernames = n_prec01_4.5) %T>%
  plot
```

##### January precipitation RCP 8.5
```{r prec01_8.5}
prec01_8.5 <- rst.op(input1 = prec01,
                     input2 = prec01_8.5_pc,
                     proj_mask = ch_mask,
                     op = "addper",
                     filename = "output/clim_vars/prec01_8.5",
                     layernames = n_prec01_8.5) %T>%
  plot
```

##### July precipitation RCP 4.5
```{r prec07_4.5}
prec07_4.5 <- rst.op(input1 = prec07,
                     input2 = prec07_4.5_pc,
                     proj_mask = ch_mask,
                     op = "addper",
                     filename = "output/clim_vars/prec07_4.5",
                     layernames = n_prec07_4.5) %T>%
  plot
```

##### July precipitation RCP 8.5
```{r prec07_8.5}
prec07_8.5 <- rst.op(input1 = prec07,
                     input2 = prec07_8.5_pc,
                     proj_mask = ch_mask,
                     op = "addper",
                     filename = "output/clim_vars/prec07_8.5",
                     layernames = n_prec07_8.5) %T>%
  plot
```

#### Interploate prediction data
```{r tmax01_4.5_int}
tmax01_4.5_int <- interpolate.climdat(initras = tmax01,
                                      futras = tmax01_4.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_tmax01_4.5,
                                      year0 =  year0,
                                      varname = "tmax01",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/tmax01_4.5")
```

```{r tmax01_8.5_int}
tmax01_8.5_int <- interpolate.climdat(initras = tmax01,
                                      futras = tmax01_8.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_tmax01_8.5,
                                      year0 =  year0,
                                      varname = "tmax01",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/tmax01_8.5")
```

```{r tmin07_4.5_int}
tmin07_4.5_int <- interpolate.climdat(initras = tmin07,
                                      futras = tmin07_4.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_tmin07_4.5,
                                      year0 =  year0,
                                      varname = "tmin07",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/tmin07_4.5")
```

```{r tmin07_8.5_int}
tmin07_8.5_int <- interpolate.climdat(initras = tmin07,
                                      futras = tmin07_8.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_tmin07_8.5,
                                      year0 =  year0,
                                      varname = "tmin07",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/tmin07_8.5")
```

```{r prec01_4.5_int}
prec01_4.5_int <- interpolate.climdat(initras = prec01,
                                      futras = prec01_4.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_prec01_4.5,
                                      year0 =  year0,
                                      varname = "prec01",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/prec01_4.5")
```

```{r prec01_8.5_int}
prec01_8.5_int <- interpolate.climdat(initras = prec01,
                                      futras = prec01_8.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_prec01_8.5,
                                      year0 =  year0,
                                      varname = "prec01",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/prec01_8.5")
```

```{r prec07_4.5_int}
prec07_4.5_int <- interpolate.climdat(initras = prec07,
                                      futras = prec07_4.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_prec07_4.5,
                                      year0 =  year0,
                                      varname = "prec07",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/prec07_4.5")
```

```{r prec07_8.5_int}
prec07_8.5_int <- interpolate.climdat(initras = prec07,
                                      futras = prec07_8.5,
                                      ntimesteps = ntimesteps,
                                      data_years = n_prec07_8.5,
                                      year0 =  year0,
                                      varname = "prec07",
                                      proj_mask = ch_mask,
                                      filename = "output/clim_vars/prec07_8.5")
```

### Climate variable sets

#### Climate variables
```{r clim_vars}
clim_vars_cc0 <- vector("list", ntimesteps + 1)
for(i in 1:(ntimesteps + 1)){
  clim_vars_cc0[[i]] <- stack(prec01, prec07, tmax01, tmin07)
}
clim_vars_4.5 <- mapply(prec01_4.5_int, prec07_4.5_int, tmax01_4.5_int, tmin07_4.5_int, FUN = stack)
clim_vars_8.5 <- mapply(prec01_8.5_int, prec07_8.5_int, tmax01_8.5_int, tmin07_8.5_int, FUN = stack)
```

```{r save image vars}
save.image(file = "output/session_images/input_variables.RData")
```



# Distribution modelling

## Distribution model variable collation

### Scenario 1
```{r s1_v}
s1_v <- s1_vars_landis %>%
  mapply(clim_vars_4.5,
         ari_v,
         sapply(s1_fire_vars, "[[", "tsf"),
         sapply(s1_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s1_v, file = "output/model_vars/s1_v")
```

### Scenario 2
```{r s2_v}
s2_v <- s1_vars_landis %>%
  mapply(clim_vars_8.5,
         ari_v,
         sapply(s2_fire_vars, "[[", "tsf"),
         sapply(s2_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s2_v, file = "output/model_vars/s2_v")
```

### Scenario 3
```{r s3_v}
s3_v <- s3_vars_landis %>%
  mapply(clim_vars_cc0,
         ari_v,
         sapply(s3_fire_vars, "[[", "tsf"),
         sapply(s3_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s3_v, file = "output/model_vars/s3_v")
```

### Scenario 4
```{r s4_v}
s4_v <- s4_vars_landis %>%
  mapply(clim_vars_4.5,
         ari_v,
         sapply(s4_fire_vars, "[[", "tsf"),
         sapply(s4_logging_vars, "[[", "tsl"),
         FUN = stack)

save(s4_v, file = "output/model_vars/s4_v")
```

## Distribution model data sampling

### Greater Glider
#### Presence-absence
```{r md_gg}
md_gg <- s1_v[[1]] %>%
  raster::extract(y = st_coordinates(gg_pa_ch)) %>%
  cbind("PA" = gg_pa_ch$PA, .) %>%
  as.data.frame %>%
  na.omit

save(md_gg, file = "output/model_vars/md_gg")
```

#### Presence-absence and background
```{r md_gg_ps}
md_gg_ps <- s1_v[[1]] %>%
  raster::extract(y = st_coordinates(gg_pa_ch_psab)) %>%
  cbind("PA" = gg_pa_ch_psab$PA, .) %>%
  as.data.frame %>%
  na.omit

save(md_gg_ps, file = "output/model_vars/md_gg_ps")
```

#### Presence-absence and background
```{r md_gg_old}
md_gg_old <- s1_v[[1]] %>%
  raster::extract(y = st_coordinates(gg_old)) %>%
  cbind("PA" = gg_old$PA, .) %>%
  as.data.frame %>%
  na.omit

save(md_gg_old, file = "output/model_vars/md_gg_old")
```


### Leadbeater's possum
#### Presence-absence
```{r md_lb}
md_lb <- s1_v[[1]] %>%
  raster::extract(y = st_coordinates(lb_pa_ch)) %>%
  cbind("PA" = lb_pa_ch$PA, .) %>%
  as.data.frame %>%
  na.omit

save(md_lb, file = "output/model_vars/md_lb")
```

#### Presence-absence and background
```{r md_lb_ps}
md_lb_ps <- s1_v[[1]] %>%
  raster::extract(y = st_coordinates(lb_pa_ch_psab)) %>%
  cbind("PA" = lb_pa_ch_psab$PA, .) %>%
  as.data.frame %>%
  na.omit

save(md_lb_ps, file = "output/model_vars/md_lb_ps")
```


```{r same image distribution_data}
save.image(file = "output/session_images/distribution_data.RData")
```

### Check data correlations and produce variable subsets

#### Greater glider
```{r gg_cor}
gg_cor <- cor(md_gg[, 2:dim(md_gg)[2]])

gg_cor_v <- which(gg_cor >0.7 & gg_cor < 1, arr.ind = TRUE)

gg_cor_list <- cbind.data.frame(var1 = rownames(gg_cor)[gg_cor_v[,"row"]],
                                var2 = colnames(gg_cor)[gg_cor_v[,"col"]],
                                correlation = gg_cor[which(gg_cor >0.7 & gg_cor < 1, arr.ind = TRUE)]) %>%
  arrange(var1, var2) %>%
  as.matrix

gg_cor_list
```

#### Variable subsets
Rmove variables to sets that exclude correlations, exclude variables intended to represent the same idea, and represent specific types of models. While also keep one with everything.

c("PA", "lbm_prop", "lbm_biom", "ac_prop", "ac_biom", "ggf_prop", "ggf_biom", "ggd_prop", "ggd_prop_og", "ggd_biom", "ggd_biom_og", "hbt_3h", "hbt_1k", "prop_bio_regn", "prop_bio_targ", "prop_old_150", "prop_old_200", "prop_oge", "prop_oge_3h", "prop_oge_1k", "harvest", "firesev", "woody", "prec01", "prec07", "tmax01", "tmin07", "lvdaw", "lvdma", "lvdmi", "lvdsw", "tsf", "tsl")

c("PA", "lbm_prop", "lbm_biom", "ac_prop", "ac_biom", "ggf_prop", "ggf_biom", "ggd_prop", "ggd_prop_og", "ggd_biom", "ggd_biom_og", "hbt_3h", "hbt_1k", "prop_bio_regn", "prop_bio_targ", "prop_old_150", "prop_old_200", "prop_oge", "prop_oge_3h", "prop_oge_1k", "prec01", "prec07", "tmax01", "tmin07", "lvdaw", "lvdma", "lvdmi", "lvdsw", "tsf", "tsl")

```{r v_gg}
v_gg_a <- c("PA", "lbm_prop", "lbm_biom", "ac_prop", "ac_biom", "ggf_prop", "ggf_biom", "ggd_prop", "ggd_prop_og", "ggd_biom", "ggd_biom_og", "hbt_3h", "hbt_1k", "prop_bio_regn", "prop_bio_targ", "prop_old_150", "prop_old_200", "prop_oge", "prop_oge_3h", "prop_oge_1k", "prec01", "prec07", "tmax01", "tmin07", "lvdaw", "lvdma", "lvdmi", "lvdsw", "tsf", "tsl")

v_gg_1 <- c("PA", "ggf_prop", "ggd_prop_og", "prop_bio_regn", "prec01", "tmin07", "lvdaw", "lvdmi", "tsf", "tsl")
v_gg_2 <- c("PA", "ggf_biom", "ggd_biom_og", "prop_bio_regn", "prec01", "tmin07", "lvdaw", "lvdmi", "tsf", "tsl")
v_gg_3 <- c("PA", "ggf_prop", "ggd_prop_og", "prop_bio_regn", "tsf", "tsl")
v_gg_4 <- c("PA", "prop_bio_regn", "prop_bio_targ", "prop_old_150", "prop_old_200")
```

```{r mv_gg}
mv_gg_a <- md_gg[, v_gg_a]
mv_gg_1 <- md_gg[, v_gg_1]
mv_gg_2 <- md_gg[, v_gg_2]
mv_gg_3 <- md_gg[, v_gg_3]
mv_gg_4 <- md_gg[, v_gg_4]

mv_gg_a_ps <- md_gg_ps[, v_gg_a]
mv_gg_1_ps <- md_gg_ps[, v_gg_1]
mv_gg_2_ps <- md_gg_ps[, v_gg_2]
mv_gg_3_ps <- md_gg_ps[, v_gg_3]
mv_gg_4_ps <- md_gg_ps[, v_gg_4]

mv_gg_a_old <- md_gg_old[, v_gg_a]
mv_gg_1_old <- md_gg_old[, v_gg_1]
mv_gg_2_old <- md_gg_old[, v_gg_2]
mv_gg_3_old <- md_gg_old[, v_gg_3]
mv_gg_4_old <- md_gg_old[, v_gg_4]
```




#### Leadbeater's possum
```{r lb_cor}
lb_cor <- cor(md_lb[, 2:dim(md_lb)[2]])

lb_cor_v <- which(lb_cor >0.7 & lb_cor < 1, arr.ind = TRUE)

lb_cor_list <- cbind.data.frame(var1 = rownames(lb_cor)[lb_cor_v[,"row"]],
                                var2 = colnames(lb_cor)[lb_cor_v[,"col"]],
                                correlation = lb_cor[which(lb_cor > 0.7 & lb_cor < 1, arr.ind = TRUE)]) %>%
  arrange(var1, var2) %>%
  as.matrix

lb_cor_list
```
#### Variable subsets
c("PA", "lbm_prop", "lbm_biom", "ac_prop", "ac_biom", "ggf_prop", "ggf_biom", "ggd_prop", "ggd_prop_og", "ggd_biom", "ggd_biom_og", "hbt_3h", "hbt_1k", "prop_bio_regn", "prop_bio_targ", "prop_old_150", "prop_old_200", "prop_oge", "prop_oge_3h", "prop_oge_1k", "harvest", "firesev", "woody", "prec01", "prec07", "tmax01", "tmin07", "lvdaw", "lvdma", "lvdmi", "lvdsw", "tsf", "tsl")

c("PA", "lbm_prop", "lbm_biom", "ac_prop", "ac_biom", "ggf_prop", "ggf_biom", "ggd_prop", "ggd_prop_og", "ggd_biom", "ggd_biom_og", "hbt_3h", "hbt_1k", "prop_bio_regn", "prop_bio_targ", "prop_old_150", "prop_old_200", "prop_oge", "prop_oge_3h", "prop_oge_1k", "prec01", "prec07", "tmax01", "tmin07", "lvdaw", "lvdma", "lvdmi", "lvdsw", "tsf", "tsl")

```{r v_lv}
v_lb_a <- c("PA", "lbm_prop", "lbm_biom", "ac_prop", "ac_biom", "ggf_prop", "ggf_biom", "ggd_prop", "ggd_prop_og", "ggd_biom", "ggd_biom_og", "hbt_3h", "hbt_1k", "prop_bio_regn", "prop_bio_targ", "prop_old_150", "prop_old_200", "prop_oge", "prop_oge_3h", "prop_oge_1k", "prec01", "prec07", "tmax01", "tmin07", "lvdaw", "lvdma", "lvdmi", "lvdsw", "tsf", "tsl")

v_lb_1 <- c("PA", "lbm_prop", "lbm_biom", "prop_oge_3h", "prec01", "tmin07", "lvdaw", "lvdmi", "tsf", "tsl")
v_lb_2 <- c("PA", "ac_prop", "ac_biom", "prop_oge_3h", "prec01", "tmin07", "lvdaw", "lvdmi", "tsf", "tsl")
v_lb_3 <- c("PA", "lbm_prop", "lbm_biom", "prop_oge_3h", "tsf", "tsl")
v_lb_4 <- c("PA", "ac_prop", "ac_biom", "prop_oge_3h", "tsf", "tsl")
```

```{r mv_lb}
mv_lb_a <- md_lb[, v_lb_a]
mv_lb_1 <- md_lb[, v_lb_1]
mv_lb_2 <- md_lb[, v_lb_2]
mv_lb_3 <- md_lb[, v_lb_3]
mv_lb_4 <- md_lb[, v_lb_4]

mv_lb_a_ps <- md_lb_ps[, v_lb_a]
mv_lb_1_ps <- md_lb_ps[, v_lb_1]
mv_lb_2_ps <- md_lb_ps[, v_lb_2]
mv_lb_3_ps <- md_lb_ps[, v_lb_3]
mv_lb_4_ps <- md_lb_ps[, v_lb_4]
```


## Distribution model fit

### Greater Glider

#### Variable set 1
```{r brt_gg_1}
brt_gg_1 <- gbmstep(data = mv_gg_1, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_gg_1}
summary(brt_gg_1)
```

```{r gbm.plot brt_gg_1}
gbm.plot(brt_gg_1)
```

```{r}
png(file = "output/plots/brt_gg_1.png",
    width = width.png,
    height = height.png, res = res)
gbm.plot(brt_gg_1)

dev.off()
```


```{r initial pred brt_gg_1}
ip_gg_1 <- brtpredict(variables = s1_v,
                      model = brt_gg_1,
                      scn_id = "ip",
                      varset = "1",
                      species = "gg")

plot(ip_gg_1)
```

#### Variable set 2
```{r brt_gg_2}
brt_gg_2 <- gbmstep(data = mv_gg_2, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_gg_2}
summary(brt_gg_2)
```

```{r gbm.plot brt_gg_2}
gbm.plot(brt_gg_2)
```

```{r initial pred brt_gg_2}
ip_gg_2 <- brtpredict(variables = s1_v,
                      model = brt_gg_2,
                      scn_id = "ip",
                      varset = "2",
                      species = "gg")

plot(ip_gg_2)
```

#### Variable set 3
```{r brt_gg_3}
brt_gg_3 <- gbmstep(data = mv_gg_3, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_gg_3}
summary(brt_gg_3)
```

```{r gbm.plot brt_gg_3}
gbm.plot(brt_gg_3)
```

```{r initial pred brt_gg_3}
ip_gg_3 <- brtpredict(variables = s1_v,
                      model = brt_gg_3,
                      scn_id = "ip",
                      varset = "3",
                      species = "gg")

plot(ip_gg_3)
```

#### Variable set 4
```{r brt_gg_4}
brt_gg_4 <- gbmstep(data = mv_gg_4, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_gg_4}
summary(brt_gg_4)
```

```{r gbm.plot brt_gg_4}
gbm.plot(brt_gg_4)
```

```{r initial pred brt_gg_4}
ip_gg_4 <- brtpredict(variables = s1_v,
                      model = brt_gg_4,
                      scn_id = "ip",
                      varset = "4",
                      species = "gg")

plot(ip_gg_4)
```

#### Variable set 1 pseudo-absence
```{r brt_gg_1_ps}
brt_gg_1_ps <- gbmstep(data = mv_gg_1_ps, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_gg_1_ps}
summary(brt_gg_1_ps)
```

```{r gbm.plot brt_gg_1_ps}
gbm.plot(brt_gg_1_ps)
```

```{r initial pred brt_gg_1_ps}
ip_gg_1_ps <- brtpredict(variables = s1_v,
                      model = brt_gg_1_ps,
                      scn_id = "ip",
                      varset = "1_ps",
                      species = "gg")

plot(ip_gg_1_ps)
```

#### Variable set 2 pseudo-absence
```{r brt_gg_2_ps}
brt_gg_2_ps <- gbmstep(data = mv_gg_2_ps, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_gg_2_ps}
summary(brt_gg_2_ps)
```

```{r gbm.plot brt_gg_2_ps}
gbm.plot(brt_gg_2_ps)
```

```{r initial pred brt_gg_2_ps}
ip_gg_2_ps <- brtpredict(variables = s1_v,
                      model = brt_gg_2_ps,
                      scn_id = "ip",
                      varset = "2_ps",
                      species = "gg")

plot(ip_gg_2_ps)
```

#### Variable set 3 pseudo-absence
```{r brt_gg_3_ps}
brt_gg_3_ps <- gbmstep(data = mv_gg_3_ps, learning.rate = 0.001, bag.fraction = 0.5)
```



```{r sumary brt_gg_3_ps}
summary(brt_gg_3_ps)
```

```{r gbm.plot brt_gg_3_ps}
gbm.plot(brt_gg_3_ps)
```

```{r initial pred brt_gg_3_ps}
ip_gg_3_ps <- brtpredict(variables = s1_v,
                      model = brt_gg_3_ps,
                      scn_id = "ip",
                      varset = "3_ps",
                      species = "gg")

plot(ip_gg_3_ps)
```

#### Variable set 4 pseudo-absence
```{r brt_gg_4_ps}
brt_gg_4_ps <- gbmstep(data = mv_gg_4_ps, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_gg_4_ps}
summary(brt_gg_4_ps)
```

```{r gbm.plot brt_gg_4_ps}
gbm.plot(brt_gg_4_ps)
```

```{r initial pred brt_gg_4_ps}
ip_gg_4_ps <- brtpredict(variables = s1_v,
                      model = brt_gg_4_ps,
                      scn_id = "ip",
                      varset = "4_ps",
                      species = "gg")

plot(ip_gg_4_ps)
```

### Leadbeater's Possum

#### Variable set 1
```{r brt_lb_1}
brt_lb_1 <- gbmstep(data = mv_lb_1, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_lb_1}
summary(brt_lb_1)
```

```{r gbm.plot brt_lb_1}
gbm.plot(brt_lb_1)
```

```{r initial pred brt_lb_1}
ip_lb_1 <- brtpredict(variables = s1_v,
                      model = brt_lb_1,
                      scn_id = "ip",
                      varset = "1",
                      species = "lb")

plot(ip_lb_1)
```

#### Variable set 2
```{r brt_lb_2}
brt_lb_2 <- gbmstep(data = mv_lb_2, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_lb_2}
summary(brt_lb_2)
```

```{r gbm.plot brt_lb_2}
gbm.plot(brt_lb_2)
```

```{r initial pred brt_lb_2}
ip_lb_2 <- brtpredict(variables = s1_v,
                      model = brt_lb_2,
                      scn_id = "ip",
                      varset = "2",
                      species = "lb")

plot(ip_lb_2)
```

#### Variable set 3
```{r brt_lb_3}
brt_lb_3 <- gbmstep(data = mv_lb_3, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_lb_3}
summary(brt_lb_3)
```

```{r gbm.plot brt_lb_3}
gbm.plot(brt_lb_3)
```

```{r initial pred brt_lb_3}
ip_lb_3 <- brtpredict(variables = s1_v,
                      model = brt_lb_3,
                      scn_id = "ip",
                      varset = "3",
                      species = "lb")

plot(ip_lb_3)
```

#### Variable set 4
```{r brt_lb_4}
brt_lb_4 <- gbmstep(data = mv_lb_4, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_lb_4}
summary(brt_lb_4)
```

```{r gbm.plot brt_lb_4}
gbm.plot(brt_lb_4)
```

```{r initial pred brt_lb_4}
ip_lb_4 <- brtpredict(variables = s1_v,
                      model = brt_lb_4,
                      scn_id = "ip",
                      varset = "4",
                      species = "lb")

plot(ip_lb_4)
```

#### Variable set 1 pseudo-absence
```{r brt_lb_1_ps}
brt_lb_1_ps <- gbmstep(data = mv_lb_1_ps, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_lb_1_ps}
summary(brt_lb_1_ps)
```

```{r gbm.plot brt_lb_1_ps}
gbm.plot(brt_lb_1_ps)
```

```{r initial pred brt_lb_1_ps}
ip_lb_1_ps <- brtpredict(variables = s1_v,
                      model = brt_lb_1_ps,
                      scn_id = "ip",
                      varset = "1_ps",
                      species = "lb")

plot(ip_lb_1_ps)
```

#### Variable set 2 pseudo-absence
```{r brt_lb_2_ps}
brt_lb_2_ps <- gbmstep(data = mv_lb_2_ps, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_lb_2_ps}
summary(brt_lb_2_ps)
```

```{r gbm.plot brt_lb_2_ps}
gbm.plot(brt_lb_2_ps)
```

```{r initial pred brt_lb_2_ps}
ip_lb_2_ps <- brtpredict(variables = s1_v,
                      model = brt_lb_2_ps,
                      scn_id = "ip",
                      varset = "2_ps",
                      species = "lb")

plot(ip_lb_2_ps)
```

#### Variable set 3 pseudo-absence
```{r brt_lb_3_ps}
brt_lb_3_ps <- gbmstep(data = mv_lb_3_ps, learning.rate = 0.001, bag.fraction = 0.5)
```

```{r sumary brt_lb_3_ps}
summary(brt_lb_3_ps)
```

```{r gbm.plot brt_lb_3_ps}
gbm.plot(brt_lb_3_ps)
```

```{r initial pred brt_lb_3_ps}
ip_lb_3_ps <- brtpredict(variables = s1_v,
                      model = brt_lb_3_ps,
                      scn_id = "ip",
                      varset = "3_ps",
                      species = "lb")

plot(ip_lb_3_ps)
```

#### Variable set 4 pseudo-absence
```{r brt_lb_4_ps}
brt_lb_4_ps <- gbmstep(data = mv_lb_4_ps, learning.rate = 0.001, bag.fraction = 0.5, )
```

```{r sumary brt_lb_4_ps}
summary(brt_lb_4_ps)
```

```{r gbm.plot brt_lb_4_ps}
gbm.plot(brt_lb_4_ps)
```

```{r initial pred brt_lb_4_ps}
ip_lb_4_ps <- brtpredict(variables = s1_v,
                      model = brt_lb_4_ps,
                      scn_id = "ip",
                      varset = "4_ps",
                      species = "lb")

plot(ip_lb_4_ps)
```


```{r save image dist fits}
save.image(file = "output/session_images/distribution_fits.RData")
```


## Distribution model predictions

### Greater Glider

#### Scenario 1

##### Model 1
```{r s1_p_gg_1}
s1_p_gg_1 <- brtpredict(variables = s1_v,
                      model = brt_gg_1,
                      scn_id = "s1",
                      varset = "1",
                      species = "gg",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 4
```{r s1_p_gg_4}
s1_p_gg_4 <- brtpredict(variables = s1_v,
                      model = brt_gg_4,
                      scn_id = "s1",
                      varset = "4",
                      species = "gg",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 1 pseudo-absences
```{r s1_p_gg_1_ps}
s1_p_gg_1_ps <- brtpredict(variables = s1_v,
                      model = brt_gg_1_ps,
                      scn_id = "s1",
                      varset = "1_ps",
                      species = "gg",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 4 pseudo-absences
```{r s1_p_gg_4_ps}
s1_p_gg_4_ps <- brtpredict(variables = s1_v,
                      model = brt_gg_4_ps,
                      scn_id = "s1",
                      varset = "4_ps",
                      species = "gg",
                      initial = FALSE,
                      ncores = ncores)
```

#### Scenario 2

##### Model 1
```{r s2_p_gg_1}
s2_p_gg_1 <- brtpredict(variables = s2_v,
                      model = brt_gg_1,
                      scn_id = "s2",
                      varset = "1",
                      species = "gg",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 4
```{r s2_p_gg_4}
# s2_p_gg_4 <- brtpredict(variables = s2_v,
#                       model = brt_gg_4,
#                       scn_id = "s2",
#                       varset = "4",
#                       species = "gg",
#                       initial = FALSE,
#                       ncores = ncores)
```

##### Model 1 pseudo-absences
```{r s2_p_gg_1_ps}
s2_p_gg_1_ps <- brtpredict(variables = s2_v,
                      model = brt_gg_1_ps,
                      scn_id = "s2",
                      varset = "1_ps",
                      species = "gg",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 4 pseudo-absences
```{r s2_p_gg_4_ps}
# s2_p_gg_4_ps <- brtpredict(variables = s2_v,
#                       model = brt_gg_4_ps,
#                       scn_id = "s2",
#                       varset = "4_ps",
#                       species = "gg",
#                       initial = FALSE,
#                       ncores = ncores)
```

#### Scenario 3

##### Model 1
```{r s3_p_gg_1}
s3_p_gg_1 <- brtpredict(variables = s3_v,
                      model = brt_gg_1,
                      scn_id = "s3",
                      varset = "1",
                      species = "gg",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 4
```{r s3_p_gg_4}
# s3_p_gg_4 <- brtpredict(variables = s3_v,
#                       model = brt_gg_4,
#                       scn_id = "s3",
#                       varset = "4",
#                       species = "gg",
#                       initial = FALSE,
#                       ncores = ncores)
```

##### Model 1 pseudo-absences
```{r s3_p_gg_1_ps}
s3_p_gg_1_ps <- brtpredict(variables = s3_v,
                      model = brt_gg_1_ps,
                      scn_id = "s3",
                      varset = "1_ps",
                      species = "gg",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 4 pseudo-absences
```{r s3_p_gg_4_ps}
# s3_p_gg_4_ps <- brtpredict(variables = s3_v,
#                       model = brt_gg_4_ps,
#                       scn_id = "s3",
#                       varset = "4_ps",
#                       species = "gg",
#                       initial = FALSE,
#                       ncores = ncores)
```

#### Scenario 4

##### Model 1
```{r s4_p_gg_1}
# s4_p_gg_1 <- brtpredict(variables = s4_v,
#                       model = brt_gg_1,
#                       scn_id = "s4",
#                       varset = "1",
#                       species = "gg",
#                       initial = FALSE,
#                       ncores = ncores)
```

##### Model 4
```{r s4_p_gg_4}
# s4_p_gg_4 <- brtpredict(variables = s4_v,
#                       model = brt_gg_4,
#                       scn_id = "s4",
#                       varset = "4",
#                       species = "gg",
#                       initial = FALSE,
#                       ncores = ncores)
```

##### Model 1 pseudo-absences
```{r s4_p_gg_1_ps}
# s4_p_gg_1_ps <- brtpredict(variables = s4_v,
#                       model = brt_gg_1_ps,
#                       scn_id = "s4",
#                       varset = "1_ps",
#                       species = "gg",
#                       initial = FALSE,
#                       ncores = ncores)
```

##### Model 4 pseudo-absences
```{r s4_p_gg_4_ps}
# s4_p_gg_4_ps <- brtpredict(variables = s4_v,
#                       model = brt_gg_4_ps,
#                       scn_id = "s4",
#                       varset = "4_ps",
#                       species = "gg",
#                       initial = FALSE,
#                       ncores = ncores)
```

### Leadbeater's Possum

#### Scenario 1

##### Model 1
```{r s1_p_lb_1}
s1_p_lb_1 <- brtpredict(variables = s1_v,
                      model = brt_lb_1,
                      scn_id = "s1",
                      varset = "1",
                      species = "lb",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 3
```{r s1_p_lb_3}
s1_p_lb_3 <- brtpredict(variables = s1_v,
                      model = brt_lb_3,
                      scn_id = "s1",
                      varset = "3",
                      species = "lb",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 1 pseudo-absences
```{r s1_p_lb_1_ps}
s1_p_lb_1_ps <- brtpredict(variables = s1_v,
                      model = brt_lb_1_ps,
                      scn_id = "s1",
                      varset = "1_ps",
                      species = "lb",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 3 pseudo-absences
```{r s1_p_lb_3_ps}
s1_p_lb_3_ps <- brtpredict(variables = s1_v,
                      model = brt_lb_3_ps,
                      scn_id = "s1",
                      varset = "3_ps",
                      species = "lb",
                      initial = FALSE,
                      ncores = ncores)
```

#### Scenario 2

##### Model 1
```{r s2_p_lb_1}
s2_p_lb_1 <- brtpredict(variables = s2_v,
                      model = brt_lb_1,
                      scn_id = "s2",
                      varset = "1",
                      species = "lb",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 3
```{r s2_p_lb_3}
# s2_p_lb_3 <- brtpredict(variables = s2_v,
#                       model = brt_lb_3,
#                       scn_id = "s2",
#                       varset = "3",
#                       species = "lb",
#                       initial = FALSE,
#                       ncores = ncores)
```

##### Model 1 pseudo-absences
```{r s2_p_lb_1_ps}
s2_p_lb_1_ps <- brtpredict(variables = s2_v,
                      model = brt_lb_1_ps,
                      scn_id = "s2",
                      varset = "1_ps",
                      species = "lb",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 3 pseudo-absences
```{r s2_p_lb_3_ps}
# s2_p_lb_3_ps <- brtpredict(variables = s2_v,
#                       model = brt_lb_3_ps,
#                       scn_id = "s2",
#                       varset = "3_ps",
#                       species = "lb",
#                       initial = FALSE,
#                       ncores = ncores)
```

#### Scenario 3

##### Model 1
```{r s3_p_lb_1}
s3_p_lb_1 <- brtpredict(variables = s3_v,
                      model = brt_lb_1,
                      scn_id = "s3",
                      varset = "1",
                      species = "lb",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 3
```{r s3_p_lb_3}
# s3_p_lb_3 <- brtpredict(variables = s3_v,
#                       model = brt_lb_3,
#                       scn_id = "s3",
#                       varset = "3",
#                       species = "lb",
#                       initial = FALSE,
#                       ncores = ncores)
```

##### Model 1 pseudo-absences
```{r s3_p_lb_1_ps}
s3_p_lb_1_ps <- brtpredict(variables = s3_v,
                      model = brt_lb_1_ps,
                      scn_id = "s3",
                      varset = "1_ps",
                      species = "lb",
                      initial = FALSE,
                      ncores = ncores)
```

##### Model 3 pseudo-absences
```{r s3_p_lb_3_ps}
# s3_p_lb_3_ps <- brtpredict(variables = s3_v,
#                       model = brt_lb_3_ps,
#                       scn_id = "s3",
#                       varset = "3_ps",
#                       species = "lb",
#                       initial = FALSE,
#                       ncores = ncores)
```

#### Scenario 4

##### Model 1
```{r s4_p_lb_1}
# s4_p_lb_1 <- brtpredict(variables = s4_v,
#                       model = brt_lb_1,
#                       scn_id = "s4",
#                       varset = "1",
#                       species = "lb",
#                       initial = FALSE,
#                       ncores = ncores)
```

##### Model 3
```{r s4_p_lb_3}
# s4_p_lb_3 <- brtpredict(variables = s4_v,
#                       model = brt_lb_3,
#                       scn_id = "s4",
#                       varset = "3",
#                       species = "lb",
#                       initial = FALSE,
#                       ncores = ncores)
```

##### Model 1 pseudo-absences
```{r s4_p_lb_1_ps}
# s4_p_lb_1_ps <- brtpredict(variables = s4_v,
#                       model = brt_lb_1_ps,
#                       scn_id = "s4",
#                       varset = "1_ps",
#                       species = "lb",
#                       initial = FALSE,
#                       ncores = ncores)
```

##### Model 3 pseudo-absences
```{r s4_p_lb_3_ps}
# s4_p_lb_3_ps <- brtpredict(variables = s4_v,
#                       model = brt_lb_3_ps,
#                       scn_id = "s4",
#                       varset = "3_ps",
#                       species = "lb",
#                       initial = FALSE,
#                       ncores = ncores)
```

```{r save.image distribution_predictions}
save.image(file = "output/session_images/distribution_predictions.RData")
```



```{r stackbrtpred}
s1_p_gg_1    <- stackbrtpred(scn_id = "s1", varset = "1"    , species = "gg")
s1_p_gg_4    <- stackbrtpred(scn_id = "s1", varset = "4"    , species = "gg")
s1_p_gg_1_ps <- stackbrtpred(scn_id = "s1", varset = "1_ps" , species = "gg")
s1_p_gg_4_ps <- stackbrtpred(scn_id = "s1", varset = "4_ps" , species = "gg")

s2_p_gg_1    <- stackbrtpred(scn_id = "s2", varset = "1"    , species = "gg")
# s2_p_gg_4    <- stackbrtpred(scn_id = "s2", varset = "4"    , species = "gg")
s2_p_gg_1_ps <- stackbrtpred(scn_id = "s2", varset = "1_ps" , species = "gg")
# s2_p_gg_4_ps <- stackbrtpred(scn_id = "s2", varset = "4_ps" , species = "gg")

s3_p_gg_1    <- stackbrtpred(scn_id = "s3", varset = "1"    , species = "gg")
# s3_p_gg_4    <- stackbrtpred(scn_id = "s3", varset = "4"    , species = "gg")
s3_p_gg_1_ps <- stackbrtpred(scn_id = "s3", varset = "1_ps" , species = "gg")
# s3_p_gg_4_ps <- stackbrtpred(scn_id = "s3", varset = "4_ps" , species = "gg")

# s4_p_gg_1    <- stackbrtpred(scn_id = "s4", varset = "1"    , species = "gg")
# s4_p_gg_4    <- stackbrtpred(scn_id = "s4", varset = "4"    , species = "gg")
# s4_p_gg_1_ps <- stackbrtpred(scn_id = "s4", varset = "1_ps" , species = "gg")
# s4_p_gg_4_ps <- stackbrtpred(scn_id = "s4", varset = "4_ps" , species = "gg")

s1_p_lb_1    <- stackbrtpred(scn_id = "s1", varset = "1"    , species = "lb")
s1_p_lb_3    <- stackbrtpred(scn_id = "s1", varset = "3"    , species = "lb")
s1_p_lb_1_ps <- stackbrtpred(scn_id = "s1", varset = "1_ps" , species = "lb")
s1_p_lb_3_ps <- stackbrtpred(scn_id = "s1", varset = "3_ps" , species = "lb")

s2_p_lb_1    <- stackbrtpred(scn_id = "s2", varset = "1"    , species = "lb")
# s2_p_lb_3    <- stackbrtpred(scn_id = "s2", varset = "3"    , species = "lb")
s2_p_lb_1_ps <- stackbrtpred(scn_id = "s2", varset = "1_ps" , species = "lb")
# s2_p_lb_3_ps <- stackbrtpred(scn_id = "s2", varset = "3_ps" , species = "lb")

s3_p_lb_1    <- stackbrtpred(scn_id = "s3", varset = "1"    , species = "lb")
# s3_p_lb_3    <- stackbrtpred(scn_id = "s3", varset = "3"    , species = "lb")
s3_p_lb_1_ps <- stackbrtpred(scn_id = "s3", varset = "1_ps" , species = "lb")
# s3_p_lb_3_ps <- stackbrtpred(scn_id = "s3", varset = "3_ps" , species = "lb")

# s4_p_lb_1    <- stackbrtpred(scn_id = "s4", varset = "1"    , species = "lb")
# s4_p_lb_3    <- stackbrtpred(scn_id = "s4", varset = "3"    , species = "lb")
# s4_p_lb_1_ps <- stackbrtpred(scn_id = "s4", varset = "1_ps" , species = "lb")
# s4_p_lb_3_ps <- stackbrtpred(scn_id = "s4", varset = "3_ps" , species = "lb")
```



# Population viability analysis

## Greater Glider

### PVA Input variables

```{r ageClassNames}
ageClassNames <- c('Newborn','Juvenile','Adult')
```

#### Transition matrices

##### Mid fecundity
```{r gg_trans_mat_fm}
tm_gg_fm <- matrix(c(0.00,0.00,0.40,
                     0.50,0.00,0.00,
                     0.00,0.83,0.83),
                   nrow = 3,
                   ncol = 3,
                   byrow = TRUE)

colnames(tm_gg_fm) <- rownames(tm_gg_fm) <- ageClassNames

ss_gg_fm <- get.stable.states(tm_gg_fm)

ss_gg_fm

rmax(tm = tm_gg_fm)
```


##### Low fecundity
```{r gg_trans_mat_fl}
tm_gg_fl <- matrix(c(0.00,0.00,0.25,
                     0.50,0.00,0.00,
                     0.00,0.85,0.85),
                   nrow = 3,
                   ncol = 3,
                   byrow = TRUE) # based on Possingham et al 1994

colnames(tm_gg_fl) <- rownames(tm_gg_fl) <- ageClassNames

ss_gg_fl <- get.stable.states(tm_gg_fl)

ss_gg_fl

rmax(tm = tm_gg_fl)
```

#### Carraying capacity

##### Scenario 1

##### Model 1
```{r cc_gg_1_1}
cc_gg_1_1 <- rst.op(input1 = s1_p_gg_1[[1]],
                    op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_gg_1_1.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```
##### Model 1 ps
```{r cc_gg_1_1_ps}
cc_gg_1_1_ps <- rst.op(input1 = s1_p_gg_1_ps[[1]],
                       op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_gg_1_1_ps.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```

```{r}
png(file = "output/plots/cc_gg_1_1_ps.png",
    width = width.png,
    height = height.png, res = res)

plot(cc_gg_1_1_ps)
dev.off()
```


##### Model 4
```{r cc_gg_1_4}
cc_gg_1_4 <- rst.op(input1 = s1_p_gg_4[[1]],
                    op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_gg_1_4.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```
##### Model 4 ps
```{r cc_gg_1_4_ps}
cc_gg_1_4_ps <- rst.op(input1 = s1_p_gg_4_ps[[1]],
                       op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_gg_1_4_ps.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```

##### Scenario 2

##### Model 1
```{r cc_gg_2_1}
cc_gg_2_1 <- rst.op(input1 = s2_p_gg_1[[1]],
                    op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_gg_2_1.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```
##### Model 1 ps
```{r cc_gg_2_1_ps}
cc_gg_2_1_ps <- rst.op(input1 = s2_p_gg_1_ps[[1]],
                       op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_gg_2_1_ps.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```


##### Scenario 3

##### Model 1
```{r cc_gg_3_1}
cc_gg_3_1 <- rst.op(input1 = s3_p_gg_1[[1]],
                    op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_gg_3_1.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```
##### Model 1 ps
```{r cc_gg_3_1_ps}
cc_gg_3_1_ps <- rst.op(input1 = s3_p_gg_1_ps[[1]],
                       op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_gg_3_1_ps.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```

##### Scenario 4

##### Model 1
```{r cc_gg_4_1}
cc_gg_4_1 <- rst.op(input1 = s4_p_gg_1[[1]],
                    op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_gg_4_1.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```
##### Model 1 ps
```{r cc_gg_4_1_ps}
cc_gg_4_1_ps <- rst.op(input1 = s4_p_gg_1_ps[[1]],
                       op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_gg_4_1_ps.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```
#### Initial population

##### Scenario 1

###### Model 1
```{r p0_gg_1_1}
p0_gg_1_1 <- initpop(hs = s1_p_gg_1[[1]],
                     cc = cc_gg_1_1,
                     tm = tm_gg_fm,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1",
                     species = "gg") %T>%
  plot
```
```{r}
pop0_gg_1_1 <- colSums(getValues(p0_gg_1_1), na.rm = TRUE)
```


###### Model 1 ps
```{r p0_gg_1_1_ps}
p0_gg_1_1_ps <- initpop(hs = s1_p_gg_1_ps[[1]],
                     cc = cc_gg_1_1_ps,
                     tm = tm_gg_fm,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1_ps",
                     species = "gg") %T>%
  plot
```
```{r}
pop0_gg_1_1_ps <- colSums(getValues(p0_gg_1_1_ps), na.rm = TRUE)
```

###### Model 1 low fecondity
```{r p0_gg_1_1_fl}
p0_gg_1_1_fl <- initpop(hs = s1_p_gg_1[[1]],
                     cc = cc_gg_1_1,
                     tm = tm_gg_fl,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1_fl",
                     species = "gg") %T>%
  plot
```
```{r}
pop0_gg_1_1_fl <- colSums(getValues(p0_gg_1_1_fl), na.rm = TRUE)
```

###### Model 1 ps low fecundity
```{r p0_gg_1_1_ps_fl}
p0_gg_1_1_ps_fl <- initpop(hs = s1_p_gg_1_ps[[1]],
                     cc = cc_gg_1_1_ps,
                     tm = tm_gg_fl,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1_ps_fl",
                     species = "gg") %T>%
  plot
```
```{r}
pop0_gg_1_1_ps_fl <- colSums(getValues(p0_gg_1_1_ps_fl), na.rm = TRUE)
```
###### Model 4
```{r p0_gg_1_4}
p0_gg_1_4 <- initpop(hs = s1_p_gg_4[[1]],
                     cc = cc_gg_1_4,
                     tm = tm_gg_fm,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "4",
                     species = "gg") %T>%
  plot
```
```{r}
pop0_gg_1_4 <- colSums(getValues(p0_gg_1_4), na.rm = TRUE)
```
###### Model 4 ps
```{r p0_gg_1_4_ps}
p0_gg_1_4_ps <- initpop(hs = s1_p_gg_4_ps[[1]],
                     cc = cc_gg_1_4_ps,
                     tm = tm_gg_fm,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "4_ps",
                     species = "gg") %T>%
  plot
```
```{r}
pop0_gg_1_4_ps <- colSums(getValues(p0_gg_1_4_ps), na.rm = TRUE)
```
##### Scenario 2
###### Model 1
```{r p0_gg_2_1}
p0_gg_2_1 <- initpop(hs = s2_p_gg_1[[1]],
                     cc = cc_gg_2_1,
                     tm = tm_gg_fm,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s2",
                     varset = "1",
                     species = "gg") %T>%
  plot
```
```{r}
pop0_gg_2_1 <- colSums(getValues(p0_gg_2_1), na.rm = TRUE)
```
###### Model 1 ps
```{r p0_gg_2_1_ps}
p0_gg_2_1_ps <- initpop(hs = s2_p_gg_1_ps[[1]],
                     cc = cc_gg_2_1_ps,
                     tm = tm_gg_fm,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s2",
                     varset = "1_ps",
                     species = "gg") %T>%
  plot
```
```{r}
pop0_gg_2_1_ps <- colSums(getValues(p0_gg_2_1_ps), na.rm = TRUE)
```

##### Scenario 3
###### Model 1
```{r p0_gg_3_1}
p0_gg_3_1 <- initpop(hs = s3_p_gg_1[[1]],
                     cc = cc_gg_3_1,
                     tm = tm_gg_fm,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s3",
                     varset = "1",
                     species = "gg") %T>%
  plot
```
```{r}
pop0_gg_3_1 <- colSums(getValues(p0_gg_3_1), na.rm = TRUE)
```
###### Model 1 ps
```{r p0_gg_3_1_ps}
p0_gg_3_1_ps <- initpop(hs = s3_p_gg_1_ps[[1]],
                     cc = cc_gg_3_1_ps,
                     tm = tm_gg_fm,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s3",
                     varset = "1_ps",
                     species = "gg") %T>%
  plot
```
```{r}
pop0_gg_3_1_ps <- colSums(getValues(p0_gg_3_1_ps), na.rm = TRUE)
```
##### Scenario 4
###### Model 1
```{r p0_gg_4_1}
p0_gg_4_1 <- initpop(hs = s4_p_gg_1[[1]],
                     cc = cc_gg_4_1,
                     tm = tm_gg_fm,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s4",
                     varset = "1",
                     species = "gg") %T>%
  plot
```

###### Model 1 ps
```{r p0_gg_4_1_ps}
p0_gg_4_1_ps <- initpop(hs = s4_p_gg_1_ps[[1]],
                     cc = cc_gg_4_1_ps,
                     tm = tm_gg_fm,
                     popsize = 10000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s4",
                     varset = "1_ps",
                     species = "gg") %T>%
  plot
```
#### Landscape objects

##### Scenario 1

###### Model 1
```{r l_gg_1_1}
l_gg_1_1 <- landscape(
  population = p0_gg_1_1,
  suitability = s1_p_gg_1,
  carrying_capacity = cc_gg_1_1
)
```

###### Model 1 ps
```{r l_gg_1_1_ps}
l_gg_1_1_ps <- landscape(
  population = p0_gg_1_1_ps,
  suitability = s1_p_gg_1_ps,
  carrying_capacity = cc_gg_1_1_ps
)
```

###### Model 1 low fecundity
```{r l_gg_1_1_fl}
l_gg_1_1_fl <- landscape(
  population = p0_gg_1_1_fl,
  suitability = s1_p_gg_1,
  carrying_capacity = cc_gg_1_1
)
```

###### Model 1 ps low fecundity
```{r l_gg_1_1_ps_fl}
l_gg_1_1_ps_fl <- landscape(
  population = p0_gg_1_1_ps_fl,
  suitability = s1_p_gg_1_ps,
  carrying_capacity = cc_gg_1_1_ps
)
```

###### Model 4
```{r l_gg_1_4}
l_gg_1_4 <- landscape(
  population = p0_gg_1_4,
  suitability = s1_p_gg_4,
  carrying_capacity = cc_gg_1_4
)
```

###### Model 4 ps
```{r l_gg_1_4_ps}
l_gg_1_4_ps <- landscape(
  population = p0_gg_1_4_ps,
  suitability = s1_p_gg_4_ps,
  carrying_capacity = cc_gg_1_4_ps
)
```

##### Scenario 2
###### Model 1
```{r l_gg_2_1}
l_gg_2_1 <- landscape(
  population = p0_gg_2_1,
  suitability = s2_p_gg_1,
  carrying_capacity = cc_gg_2_1
)
```

###### Model 1 ps
```{r l_gg_2_1_ps}
l_gg_2_1_ps <- landscape(
  population = p0_gg_2_1_ps,
  suitability = s2_p_gg_1_ps,
  carrying_capacity = cc_gg_2_1_ps
)
```

##### Scenario 3
###### Model 1
```{r l_gg_3_1}
l_gg_3_1 <- landscape(
  population = p0_gg_3_1,
  suitability = s3_p_gg_1,
  carrying_capacity = cc_gg_3_1
)
```

###### Model 1 ps
```{r l_gg_3_1_ps}
l_gg_3_1_ps <- landscape(
  population = p0_gg_3_1_ps,
  suitability = s3_p_gg_1_ps,
  carrying_capacity = cc_gg_3_1_ps
)
```



#### Population dynamics objects

##### Mid fecundity, mid dispersal
```{r pd_gg_fm_dm}
pd_gg_fm_dm <- population_dynamics(
  change = growth(transition_matrix = tm_gg_fm,
                  global_stochasticity = 0.1),
  dispersal =  cellular_automata_dispersal(max_cells = c(0, 325, 325),
                                          dispersal_proportion = carrying_capacity_dispersal())
  )
```

##### Low fecundity, mid dispersal
```{r pd_gg_fl_dm}
pd_gg_fl_dm <- population_dynamics(
  change = growth(transition_matrix = tm_gg_fl,
                  global_stochasticity = 0.1),
  dispersal =  cellular_automata_dispersal(max_cells = c(0, 325, 325),
                                          dispersal_proportion = carrying_capacity_dispersal())
  )
```

##### Mid fecundity, low dispersal
```{r pd_gg_fm_dl}
pd_gg_fm_dl <- population_dynamics(
  change = growth(transition_matrix = tm_gg_fm,
                  global_stochasticity = 0.1),
  dispersal =  cellular_automata_dispersal(max_cells = c(0, 160, 160),
                                          dispersal_proportion = carrying_capacity_dispersal())
  )
```


```{r}
save.image(file = "output/session_images/gg_pva_objects.RData")
```



### PVAs

```{r}
ntimesteps <- 50
nreplicates <- 5
nworkers <- 5
width.pdf <- 5
height.pdf <- 3.125
```


#### Scenario 1

##### Model 1
```{r sim_gg_1_1}
sim_gg_1_1 <- parsim(
  landscape = l_gg_1_1,
  population_dynamics = pd_gg_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1",
  species = "gg"
)

gc()
```

```{r popsize_gg_1_1}
popsize_gg_1_1 <- gps(x = sim_gg_1_1,
                      workers = nworkers)

saveRDS(object = popsize_gg_1_1,
        file = "output/pva_popmat/popsize_gg_1_1")
```

```{r spop_gg_1_1}
spop_gg_1_1 <- psr(popmat = popsize_gg_1_1)

pdf(file = "output/plots/pop/spop_gg_1_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1)
dev.off()

spop_gg_1_1
```

```{r tpop_gg_1_1}
tpop_gg_1_1 <- psr(popmat = popsize_gg_1_1, stages = 0)

pdf(file = "output/plots/pop/tpop_gg_1_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1, stages = 0)
dev.off()

tpop_gg_1_1
```


##### Model 1 ps
```{r sim_gg_1_1_ps}
sim_gg_1_1_ps <- parsim(
  landscape = l_gg_1_1_ps,
  population_dynamics = pd_gg_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1_ps",
  species = "gg"
)

gc()
```

```{r popsize_gg_1_1_ps}
popsize_gg_1_1_ps <- gps(x = sim_gg_1_1_ps,
                      workers = nworkers)

saveRDS(object = popsize_gg_1_1_ps,
        file = "output/pva_popmat/popsize_gg_1_1_ps")
```

```{r spop_gg_1_1_ps}
spop_gg_1_1_ps <- psr(popmat = popsize_gg_1_1_ps)

pdf(file = "output/plots/pop/spop_gg_1_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1_ps)
dev.off()

spop_gg_1_1_ps
```

```{r tpop_gg_1_1_ps}
tpop_gg_1_1_ps <- psr(popmat = popsize_gg_1_1_ps, stages = 0)

pdf(file = "output/plots/pop/tpop_gg_1_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1_ps, stages = 0)
dev.off()

tpop_gg_1_1_ps
```

##### Model 4
```{r sim_gg_1_4}
sim_gg_1_4 <- parsim(
  landscape = l_gg_1_4,
  population_dynamics = pd_gg_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "4",
  species = "gg"
)

gc()
```

```{r popsize_gg_1_4}
popsize_gg_1_4 <- gps(x = sim_gg_1_4,
                      workers = nworkers)

saveRDS(object = popsize_gg_1_4,
        file = "output/pva_popmat/popsize_gg_1_4")
```

```{r spop_gg_1_4}
spop_gg_1_4 <- psr(popmat = popsize_gg_1_4)

pdf(file = "output/plots/pop/spop_gg_1_4.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_4)
dev.off()

spop_gg_1_4
```

```{r tpop_gg_1_4}
tpop_gg_1_4 <- psr(popmat = popsize_gg_1_4, stages = 0)

pdf(file = "output/plots/pop/tpop_gg_1_4.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_4, stages = 0)
dev.off()

tpop_gg_1_4
```

##### Model 4 ps
```{r sim_gg_1_4_ps}
sim_gg_1_4_ps <- parsim(
  landscape = l_gg_1_4_ps,
  population_dynamics = pd_gg_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "4_ps",
  species = "gg"
)

gc()
```

```{r popsize_gg_1_4_ps}
popsize_gg_1_4_ps <- gps(x = sim_gg_1_4_ps,
                      workers = nworkers)

saveRDS(object = popsize_gg_1_4_ps,
        file = "output/pva_popmat/popsize_gg_1_4_ps")
```

```{r spop_gg_1_4_ps}
spop_gg_1_4_ps <- psr(popmat = popsize_gg_1_4_ps)

pdf(file = "output/plots/pop/spop_gg_1_4_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_4_ps)
dev.off()

spop_gg_1_4_ps
```

```{r tpop_gg_1_4_ps}
tpop_gg_1_4_ps <- psr(popmat = popsize_gg_1_4_ps, stages = 0)

pdf(file = "output/plots/pop/tpop_gg_1_4_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_4_ps, stages = 0)
dev.off()

tpop_gg_1_4_ps
```

#### Scenario 2

##### Model 1
```{r sim_gg_2_1}
sim_gg_2_1 <- parsim(
  landscape = l_gg_2_1,
  population_dynamics = pd_gg_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s2",
  varset = "1",
  species = "gg"
)

gc()
```

```{r popsize_gg_2_1}
popsize_gg_2_1 <- gps(x = sim_gg_2_1,
                      workers = nworkers)

saveRDS(object = popsize_gg_2_1,
        file = "output/pva_popmat/popsize_gg_2_1")
```

```{r spop_gg_2_1}
spop_gg_2_1 <- psr(popmat = popsize_gg_2_1)

pdf(file = "output/plots/pop/spop_gg_2_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_2_1)
dev.off()

spop_gg_2_1
```

```{r tpop_gg_2_1}
tpop_gg_2_1 <- psr(popmat = popsize_gg_2_1, stages = 0)

pdf(file = "output/plots/pop/tpop_gg_2_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_2_1, stages = 0)
dev.off()

tpop_gg_2_1
```


##### Model 1 ps
```{r sim_gg_2_1_ps}
sim_gg_2_1_ps <- parsim(
  landscape = l_gg_2_1_ps,
  population_dynamics = pd_gg_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s2",
  varset = "1_ps",
  species = "gg"
)

gc()
```

```{r popsize_gg_2_1_ps}
popsize_gg_2_1_ps <- gps(x = sim_gg_2_1_ps,
                      workers = nworkers)

saveRDS(object = popsize_gg_2_1_ps,
        file = "output/pva_popmat/popsize_gg_2_1_ps")
```

```{r spop_gg_2_1_ps}
spop_gg_2_1_ps <- psr(popmat = popsize_gg_2_1_ps)

pdf(file = "output/plots/pop/spop_gg_2_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_2_1_ps)
dev.off()

spop_gg_2_1_ps
```

```{r tpop_gg_2_1_ps}
tpop_gg_2_1_ps <- psr(popmat = popsize_gg_2_1_ps, stages = 0)

pdf(file = "output/plots/pop/spop_gg_2_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_2_1_ps, stages = 0)
dev.off()

tpop_gg_2_1_ps
```

#### Scenario 3

##### Model 1
```{r sim_gg_3_1}
sim_gg_3_1 <- parsim(
  landscape = l_gg_3_1,
  population_dynamics = pd_gg_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s3",
  varset = "1",
  species = "gg"
)

gc()
```

```{r popsize_gg_3_1}
popsize_gg_3_1 <- gps(x = sim_gg_3_1,
                      workers = nworkers)

saveRDS(object = popsize_gg_3_1,
        file = "output/pva_popmat/popsize_gg_3_1")
```

```{r spop_gg_3_1}
spop_gg_3_1 <- psr(popmat = popsize_gg_3_1)

pdf(file = "output/plots/pop/spop_gg_3_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_3_1)
dev.off()

spop_gg_3_1
```

```{r tpop_gg_3_1}
tpop_gg_3_1 <- psr(popmat = popsize_gg_3_1, stages = 0)

pdf(file = "output/plots/pop/tpop_gg_3_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_3_1, stages = 0)
dev.off()

tpop_gg_3_1
```


##### Model 1 ps
```{r sim_gg_3_1_ps}
sim_gg_3_1_ps <- parsim(
  landscape = l_gg_3_1_ps,
  population_dynamics = pd_gg_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s3",
  varset = "1_ps",
  species = "gg"
)

gc()
```

```{r popsize_gg_3_1_ps}
popsize_gg_3_1_ps <- gps(x = sim_gg_3_1_ps,
                      workers = nworkers)

saveRDS(object = popsize_gg_3_1_ps,
        file = "output/pva_popmat/popsize_gg_3_1_ps")
```

```{r spop_gg_3_1_ps}
spop_gg_3_1_ps <- psr(popmat = popsize_gg_3_1_ps)

pdf(file = "output/plots/pop/spop_gg_3_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_3_1_ps)
dev.off()

spop_gg_3_1_ps
```

```{r tpop_gg_3_1_ps}
tpop_gg_3_1_ps <- psr(popmat = popsize_gg_3_1_ps, stages = 0)

pdf(file = "output/plots/pop/tpop_gg_3_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_3_1_ps, stages = 0)
dev.off()

tpop_gg_3_1_ps
```



## Leadbeater's Possum

### PVA Input variables

```{r ageClassNames}
ageClassNames <- c('Newborn','Juvenile','Adult')
```

#### Transition matrices

##### Mid fecundity
```{r lb_trans_mat_fm}
tm_lb_fm <- matrix(c(0.00,0.00,1.10,
                     0.59,0.00,0.00,
                     0.00,0.59,0.59),
                   nrow = 3,
                   ncol = 3,
                   byrow = TRUE)

colnames(tm_lb_fm) <- rownames(tm_lb_fm) <- ageClassNames

ss_lb_fm <- get.stable.states(tm_lb_fm)

ss_lb_fm

rmax(tm = tm_lb_fm)
```


##### Low fecundity
```{r lb_trans_mat_fl}
tm_lb_fl <- matrix(c(0.00,0.00,1.10,
                     0.59,0.00,0.00,
                     0.00,0.59,0.79),
                   nrow = 3,
                   ncol = 3,
                   byrow = TRUE)# based on Possingham et al 1994

colnames(tm_lb_fl) <- rownames(tm_lb_fl) <- ageClassNames

ss_lb_fl <- get.stable.states(tm_lb_fl)

ss_lb_fl

rmax(tm = tm_lb_fl)
```

#### Carraying capacity

##### Scenario 1

##### Model 1
```{r cc_lb_1_1}
cc_lb_1_1 <- rst.op(input1 = s1_p_lb_1[[1]],
                    op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_lb_1_1.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```
##### Model 1 ps
```{r cc_lb_1_1_ps}
cc_lb_1_1_ps <- rst.op(input1 = s1_p_lb_1_ps[[1]],
                       op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_lb_1_1_ps.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```
##### Model 3
```{r cc_lb_1_3}
cc_lb_1_3 <- rst.op(input1 = s1_p_lb_3[[1]],
                    op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_lb_1_3.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```
##### Model 3 ps
```{r cc_lb_1_3_ps}
cc_lb_1_3_ps <- rst.op(input1 = s1_p_lb_3_ps[[1]],
                       op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_lb_1_3_ps.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```

##### Scenario 2

##### Model 1
```{r cc_lb_2_1}
cc_lb_2_1 <- rst.op(input1 = s2_p_lb_1[[1]],
                    op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_lb_2_1.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```
##### Model 1 ps
```{r cc_lb_2_1_ps}
cc_lb_2_1_ps <- rst.op(input1 = s2_p_lb_1_ps[[1]],
                       op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_lb_2_1_ps.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```


##### Scenario 3

##### Model 1
```{r cc_lb_3_1}
cc_lb_3_1 <- rst.op(input1 = s3_p_lb_1[[1]],
                    op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_lb_3_1.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```
##### Model 1 ps
```{r cc_lb_3_1_ps}
cc_lb_3_1_ps <- rst.op(input1 = s3_p_lb_1_ps[[1]],
                       op = "cc",
                    proj_mask = ch_mask,
                    filename = "output/pva_vars/cc_lb_3_1_ps.grd",
                    layernames = "carryingCapacity",
                    size = 3) %T>%
  plot
```


#### Initial population

##### Scenario 1

###### Model 1
```{r p0_lb_1_1}
p0_lb_1_1 <- initpop(hs = s1_p_lb_1[[1]],
                     cc = cc_lb_1_1,
                     tm = tm_lb_fm,
                     popsize = 5000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1",
                     species = "lb") %T>%
  plot
```
###### Model 1 ps
```{r p0_lb_1_1_ps}
p0_lb_1_1_ps <- initpop(hs = s1_p_lb_1_ps[[1]],
                     cc = cc_lb_1_1_ps,
                     tm = tm_lb_fm,
                     popsize = 5000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1_ps",
                     species = "lb") %T>%
  plot
```
###### Model 1 low fecondity
```{r p0_lb_1_1_fl}
p0_lb_1_1_fl <- initpop(hs = s1_p_lb_1[[1]],
                     cc = cc_lb_1_1,
                     tm = tm_lb_fl,
                     popsize = 5000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1_fl",
                     species = "lb") %T>%
  plot
```
###### Model 1 ps low fecundity
```{r p0_lb_1_1_ps_fl}
p0_lb_1_1_ps_fl <- initpop(hs = s1_p_lb_1_ps[[1]],
                     cc = cc_lb_1_1_ps,
                     tm = tm_lb_fl,
                     popsize = 5000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1_ps_fl",
                     species = "lb") %T>%
  plot
```

###### Model 1 low pop
```{r p0_lb_1_1_pl}
p0_lb_1_1_pl <- initpop(hs = s1_p_lb_1[[1]],
                     cc = cc_lb_1_1,
                     tm = tm_lb_fm,
                     popsize = 2500,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1_fl",
                     species = "lb") %T>%
  plot
```
###### Model 1 ps low pop
```{r p0_lb_1_1_ps_pl}
p0_lb_1_1_ps_pl <- initpop(hs = s1_p_lb_1_ps[[1]],
                     cc = cc_lb_1_1_ps,
                     tm = tm_lb_fm,
                     popsize = 2500,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1_ps_pl",
                     species = "lb") %T>%
  plot
```


###### Model 1 high pop
```{r p0_lb_1_1_ph}
p0_lb_1_1_ph <- initpop(hs = s1_p_lb_1[[1]],
                     cc = cc_lb_1_1,
                     tm = tm_lb_fm,
                     popsize = 9000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1_ph",
                     species = "lb") %T>%
  plot
```
###### Model 1 ps high pop
```{r p0_lb_1_1_ps_ph}
p0_lb_1_1_ps_ph <- initpop(hs = s1_p_lb_1_ps[[1]],
                     cc = cc_lb_1_1_ps,
                     tm = tm_lb_fm,
                     popsize = 9000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "1_ps_ph",
                     species = "lb") %T>%
  plot
```


###### Model 3
```{r p0_lb_1_3}
p0_lb_1_3 <- initpop(hs = s1_p_lb_3[[1]],
                     cc = cc_lb_1_3,
                     tm = tm_lb_fm,
                     popsize = 5000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "3",
                     species = "lb") %T>%
  plot
```
###### Model 3 ps
```{r p0_lb_1_3_ps}
p0_lb_1_3_ps <- initpop(hs = s1_p_lb_3_ps[[1]],
                     cc = cc_lb_1_3_ps,
                     tm = tm_lb_fm,
                     popsize = 5000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s1",
                     varset = "3_ps",
                     species = "lb") %T>%
  plot
```

##### Scenario 2
###### Model 1
```{r p0_lb_2_1}
p0_lb_2_1 <- initpop(hs = s2_p_lb_1[[1]],
                     cc = cc_lb_2_1,
                     tm = tm_lb_fm,
                     popsize = 5000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s2",
                     varset = "1",
                     species = "lb") %T>%
  plot
```

###### Model 1 ps
```{r p0_lb_2_1_ps}
p0_lb_2_1_ps <- initpop(hs = s2_p_lb_1_ps[[1]],
                     cc = cc_lb_2_1_ps,
                     tm = tm_lb_fm,
                     popsize = 5000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s2",
                     varset = "1_ps",
                     species = "lb") %T>%
  plot
```

##### Scenario 3
###### Model 1
```{r p0_lb_3_1}
p0_lb_3_1 <- initpop(hs = s3_p_lb_1[[1]],
                     cc = cc_lb_3_1,
                     tm = tm_lb_fm,
                     popsize = 5000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s3",
                     varset = "1",
                     species = "lb") %T>%
  plot
```

###### Model 1 ps
```{r p0_lb_3_1_ps}
p0_lb_3_1_ps <- initpop(hs = s3_p_lb_1_ps[[1]],
                     cc = cc_lb_3_1_ps,
                     tm = tm_lb_fm,
                     popsize = 5000,
                     proj_mask = ch_mask,
                     out_path = "output/pva_vars/",
                     scn_id = "s3",
                     varset = "1_ps",
                     species = "lb") %T>%
  plot
```


#### Landscape objects

##### Scenario 1

###### Model 1
```{r l_lb_1_1}
l_lb_1_1 <- landscape(
  population = p0_lb_1_1,
  suitability = s1_p_lb_1,
  carrying_capacity = cc_lb_1_1
)
```

###### Model 1 ps
```{r l_lb_1_1_ps}
l_lb_1_1_ps <- landscape(
  population = p0_lb_1_1_ps,
  suitability = s1_p_lb_1_ps,
  carrying_capacity = cc_lb_1_1_ps
)
```

###### Model 1 low fecundity
```{r l_lb_1_1_fl}
l_lb_1_1_fl <- landscape(
  population = p0_lb_1_1_fl,
  suitability = s1_p_lb_1,
  carrying_capacity = cc_lb_1_1
)
```

###### Model 1 ps low fecundity
```{r l_lb_1_1_ps_fl}
l_lb_1_1_ps_fl <- landscape(
  population = p0_lb_1_1_ps_fl,
  suitability = s1_p_lb_1_ps,
  carrying_capacity = cc_lb_1_1_ps
)
```

###### Model 1 low population
```{r l_lb_1_1_pl}
l_lb_1_1_pl <- landscape(
  population = p0_lb_1_1_pl,
  suitability = s1_p_lb_1,
  carrying_capacity = cc_lb_1_1
)
```

###### Model 1 ps low population
```{r l_lb_1_1_ps_pl}
l_lb_1_1_ps_pl <- landscape(
  population = p0_lb_1_1_ps_pl,
  suitability = s1_p_lb_1_ps,
  carrying_capacity = cc_lb_1_1_ps
)
```

###### Model 1 high population
```{r l_lb_1_1_ph}
l_lb_1_1_ph <- landscape(
  population = p0_lb_1_1_ph,
  suitability = s1_p_lb_1,
  carrying_capacity = cc_lb_1_1
)
```

###### Model 1 ps high population
```{r l_lb_1_1_ps_ph}
l_lb_1_1_ps_ph <- landscape(
  population = p0_lb_1_1_ps_ph,
  suitability = s1_p_lb_1_ps,
  carrying_capacity = cc_lb_1_1_ps
)
```

###### Model 3
```{r l_lb_1_3}
l_lb_1_3 <- landscape(
  population = p0_lb_1_3,
  suitability = s1_p_lb_3,
  carrying_capacity = cc_lb_1_3
)
```

###### Model 3 ps
```{r l_lb_1_3_ps}
l_lb_1_3_ps <- landscape(
  population = p0_lb_1_3_ps,
  suitability = s1_p_lb_3_ps,
  carrying_capacity = cc_lb_1_3_ps
)
```

##### Scenario 2
###### Model 1
```{r l_lb_2_1}
l_lb_2_1 <- landscape(
  population = p0_lb_2_1,
  suitability = s2_p_lb_1,
  carrying_capacity = cc_lb_2_1
)
```

###### Model 1 ps
```{r l_lb_2_1_ps}
l_lb_2_1_ps <- landscape(
  population = p0_lb_2_1_ps,
  suitability = s2_p_lb_1_ps,
  carrying_capacity = cc_lb_2_1_ps
)
```

##### Scenario 3
###### Model 1
```{r l_lb_3_1}
l_lb_3_1 <- landscape(
  population = p0_lb_3_1,
  suitability = s3_p_lb_1,
  carrying_capacity = cc_lb_3_1
)
```

###### Model 1 ps
```{r l_lb_3_1_ps}
l_lb_3_1_ps <- landscape(
  population = p0_lb_3_1_ps,
  suitability = s3_p_lb_1_ps,
  carrying_capacity = cc_lb_3_1_ps
)
```



#### Population dynamics objects

##### Mid fecundity, mid dispersal
```{r pd_lb_fm_dm}
pd_lb_fm_dm <- population_dynamics(
  change = growth(transition_matrix = tm_lb_fm,
                  global_stochasticity = 0.1),
  dispersal =  cellular_automata_dispersal(max_cells = c(0, 50, 50),
                                          dispersal_proportion = carrying_capacity_dispersal())
  )
```

##### Low fecundity, mid dispersal
```{r pd_lb_fl_dm}
pd_lb_fl_dm <- population_dynamics(
  change = growth(transition_matrix = tm_lb_fl,
                  global_stochasticity = 0.1),
  dispersal =  cellular_automata_dispersal(max_cells = c(0, 50, 50),
                                          dispersal_proportion = carrying_capacity_dispersal())
  )
```

##### Mid fecundity, low dispersal
```{r pd_lb_fm_dl}
pd_lb_fm_dl <- population_dynamics(
  change = growth(transition_matrix = tm_lb_fm,
                  global_stochasticity = 0.1),
  dispersal =  cellular_automata_dispersal(max_cells = c(0, 20, 20),
                                          dispersal_proportion = carrying_capacity_dispersal())
  )
```


```{r}
save.image(file = "output/session_images/lb_pva_objects.RData")
```



### PVAs

```{r}
ntimesteps <- 50
nreplicates <- 5
nworkers <- 5
width.pdf <- 5
height.pdf <- 3.125
```


#### Scenario 1

##### Model 1
```{r sim_lb_1_1}
sim_lb_1_1 <- parsim(
  landscape = l_lb_1_1,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1",
  species = "lb"
)

gc()
```

```{r popsize_lb_1_1}
popsize_lb_1_1 <- gps(x = sim_lb_1_1,
                      workers = nworkers)

saveRDS(object = popsize_lb_1_1,
        file = "output/pva_popmat/popsize_lb_1_1")
```

```{r spop_lb_1_1}
spop_lb_1_1 <- psr(popmat = popsize_lb_1_1)

pdf(file = "output/plots/pop/spop_lb_1_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1)
dev.off()

spop_lb_1_1
```

```{r tpop_lb_1_1}
tpop_lb_1_1 <- psr(popmat = popsize_lb_1_1, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_1_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1, stages = 0)
dev.off()

tpop_lb_1_1
```


##### Model 1 ps
```{r sim_lb_1_1_ps}
sim_lb_1_1_ps <- parsim(
  landscape = l_lb_1_1_ps,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1_ps",
  species = "lb"
)

gc()
```

```{r popsize_lb_1_1_ps}
popsize_lb_1_1_ps <- gps(x = sim_lb_1_1_ps,
                      workers = nworkers)

saveRDS(object = popsize_lb_1_1_ps,
        file = "output/pva_popmat/popsize_lb_1_1_ps")
```

```{r spop_lb_1_1_ps}
spop_lb_1_1_ps <- psr(popmat = popsize_lb_1_1_ps)

pdf(file = "output/plots/pop/spop_lb_1_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_ps)
dev.off()

spop_lb_1_1_ps
```

```{r tpop_lb_1_1_ps}
tpop_lb_1_1_ps <- psr(popmat = popsize_lb_1_1_ps, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_1_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_ps, stages = 0)
dev.off()

tpop_lb_1_1_ps
```

##### Model 3
```{r sim_lb_1_3}
sim_lb_1_3 <- parsim(
  landscape = l_lb_1_3,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "3",
  species = "lb"
)

gc()
```

```{r popsize_lb_1_3}
popsize_lb_1_3 <- gps(x = sim_lb_1_3,
                      workers = nworkers)

saveRDS(object = popsize_lb_1_3,
        file = "output/pva_popmat/popsize_lb_1_3")
```

```{r spop_lb_1_1_ps}
spop_lb_1_1_ps <- psr(popmat = popsize_lb_1_1_ps)

pdf(file = "output/plots/pop/spop_lb_1_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_ps)
dev.off()

spop_lb_1_1_ps
```

```{r tpop_lb_1_1_ps}
tpop_lb_1_1_ps <- psr(popmat = popsize_lb_1_1_ps, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_1_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_ps, stages = 0)
dev.off()

tpop_lb_1_1_ps
```

##### Model 3 ps
```{r sim_lb_1_3_ps}
sim_lb_1_3_ps <- parsim(
  landscape = l_lb_1_3_ps,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "3_ps",
  species = "lb"
)

gc()
```

```{r popsize_lb_1_3_ps}
popsize_lb_1_3_ps <- gps(x = sim_lb_1_3_ps,
                      workers = nworkers)

saveRDS(object = popsize_lb_1_3_ps,
        file = "output/pva_popmat/popsize_lb_1_3_ps")
```

```{r spop_lb_1_3_ps}
spop_lb_1_3_ps <- psr(popmat = popsize_lb_1_3_ps)

pdf(file = "output/plots/pop/spop_lb_1_3_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_3_ps)
dev.off()

spop_lb_1_3_ps
```

```{r tpop_lb_1_3_ps}
tpop_lb_1_3_ps <- psr(popmat = popsize_lb_1_3_ps, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_1_3_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_3_ps, stages = 0)
dev.off()

tpop_lb_1_3_ps
```

#### Scenario 2

##### Model 1
```{r sim_lb_2_1}
sim_lb_2_1 <- parsim(
  landscape = l_lb_2_1,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s2",
  varset = "1",
  species = "lb"
)

gc()
```

```{r popsize_lb_2_1}
popsize_lb_2_1 <- gps(x = sim_lb_2_1,
                      workers = nworkers)

saveRDS(object = popsize_lb_2_1,
        file = "output/pva_popmat/popsize_lb_2_1")
```

```{r spop_lb_2_1}
spop_lb_2_1 <- psr(popmat = popsize_lb_2_1)

pdf(file = "output/plots/pop/spop_lb_2_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_2_1)
dev.off()

spop_lb_2_1
```

```{r tpop_lb_2_1}
tpop_lb_2_1 <- psr(popmat = popsize_lb_2_1, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_2_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_2_1, stages = 0)
dev.off()

tpop_lb_2_1
```


##### Model 1 ps
```{r sim_lb_2_1_ps}
sim_lb_2_1_ps <- parsim(
  landscape = l_lb_2_1_ps,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s2",
  varset = "1_ps",
  species = "lb"
)

gc()
```

```{r popsize_lb_2_1_ps}
popsize_lb_2_1_ps <- gps(x = sim_lb_2_1_ps,
                      workers = nworkers)

saveRDS(object = popsize_lb_2_1_ps,
        file = "output/pva_popmat/popsize_lb_2_1_ps")
```

```{r spop_lb_2_1_ps}
spop_lb_2_1_ps <- psr(popmat = popsize_lb_2_1_ps)

pdf(file = "output/plots/pop/spop_lb_2_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_2_1_ps)
dev.off()

spop_lb_2_1_ps
```

```{r tpop_lb_2_1_ps}
tpop_lb_2_1_ps <- psr(popmat = popsize_lb_2_1_ps, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_2_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_2_1_ps, stages = 0)
dev.off()

tpop_lb_2_1_ps
```

#### Scenario 3

##### Model 1
```{r sim_lb_3_1}
sim_lb_3_1 <- parsim(
  landscape = l_lb_3_1,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s3",
  varset = "1",
  species = "lb"
)

gc()
```

```{r popsize_lb_3_1}
popsize_lb_3_1 <- gps(x = sim_lb_3_1,
                      workers = nworkers)

saveRDS(object = popsize_lb_3_1,
        file = "output/pva_popmat/popsize_lb_3_1")
```

```{r spop_lb_3_1}
spop_lb_3_1 <- psr(popmat = popsize_lb_3_1)

pdf(file = "output/plots/pop/spop_lb_3_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_3_1)
dev.off()

spop_lb_3_1
```

```{r tpop_lb_3_1}
tpop_lb_3_1 <- psr(popmat = popsize_lb_3_1, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_3_1.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_3_1, stages = 0)
dev.off()

tpop_lb_3_1
```


##### Model 1 ps
```{r sim_lb_3_1_ps}
sim_lb_3_1_ps <- parsim(
  landscape = l_lb_3_1_ps,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s3",
  varset = "1_ps",
  species = "lb"
)

gc()
```

```{r popsize_lb_3_1_ps}
popsize_lb_3_1_ps <- gps(x = sim_lb_3_1_ps,
                      workers = nworkers)

saveRDS(object = popsize_lb_3_1_ps,
        file = "output/pva_popmat/popsize_lb_3_1_ps")
```

```{r spop_lb_3_1_ps}
spop_lb_3_1_ps <- psr(popmat = popsize_lb_3_1_ps)

pdf(file = "output/plots/pop/spop_lb_3_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_3_1_ps)
dev.off()

spop_lb_3_1_ps
```

```{r tpop_lb_3_1_ps}
tpop_lb_3_1_ps <- psr(popmat = popsize_lb_3_1_ps, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_3_1_ps.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_3_1_ps, stages = 0)
dev.off()

tpop_lb_3_1_ps
```

## Some extra

### GG

#### Low fecundity

#### Scenario 1

##### Model 1
```{r sim_gg_1_1_fl}
sim_gg_1_1_fl <- parsim(
  landscape = l_gg_1_1_fl,
  population_dynamics = pd_gg_fl_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1_fl",
  species = "gg"
)

gc()
```

```{r popsize_gg_1_1_fl}
popsize_gg_1_1_fl <- gps(x = sim_gg_1_1_fl,
                      workers = nworkers)

saveRDS(object = popsize_gg_1_1_fl,
        file = "output/pva_popmat/popsize_gg_1_1_fl")
```

```{r spop_gg_1_1_fl}
spop_gg_1_1_fl <- psr(popmat = popsize_gg_1_1_fl)

pdf(file = "output/plots/pop/spop_gg_1_1_fl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1_fl)
dev.off()

spop_gg_1_1_fl
```

```{r tpop_gg_1_1_fl}
tpop_gg_1_1_fl <- psr(popmat = popsize_gg_1_1_fl, stages = 0)

pdf(file = "output/plots/pop/tpop_gg_1_1_fl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1_fl, stages = 0)
dev.off()

tpop_gg_1_1_fl
```


##### Model 1 ps
```{r sim_gg_1_1_ps_fl}
sim_gg_1_1_ps_fl <- parsim(
  landscape = l_gg_1_1_ps_fl,
  population_dynamics = pd_gg_fl_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1_ps_fl",
  species = "gg"
)

gc()
```

```{r popsize_gg_1_1_ps_fl}
popsize_gg_1_1_ps_fl <- gps(x = sim_gg_1_1_ps_fl,
                      workers = nworkers)

saveRDS(object = popsize_gg_1_1_ps_fl,
        file = "output/pva_popmat/popsize_gg_1_1_ps_fl")
```

```{r spop_gg_1_1_ps_fl}
spop_gg_1_1_ps_fl <- psr(popmat = popsize_gg_1_1_ps_fl)

pdf(file = "output/plots/pop/spop_gg_1_1_ps_fl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1_ps_fl)
dev.off()

spop_gg_1_1_ps_fl
```

```{r tpop_gg_1_1_ps_fl}
tpop_gg_1_1_ps_fl <- psr(popmat = popsize_gg_1_1_ps_fl, stages = 0)

pdf(file = "output/plots/pop/tpop_gg_1_1_ps_fl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1_ps_fl, stages = 0)
dev.off()

tpop_gg_1_1_ps_fl
```

#### Low dispersal

#### Scenario 1

##### Model 1
```{r sim_gg_1_1_dl}
sim_gg_1_1_dl <- parsim(
  landscape = l_gg_1_1,
  population_dynamics = pd_gg_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1_dl",
  species = "gg"
)

gc()
```

```{r popsize_gg_1_1_dl}
popsize_gg_1_1_dl <- gps(x = sim_gg_1_1_dl,
                      workers = nworkers)

saveRDS(object = popsize_gg_1_1_dl,
        file = "output/pva_popmat/popsize_gg_1_1_dl")
```

```{r spop_gg_1_1_dl}
spop_gg_1_1_dl <- psr(popmat = popsize_gg_1_1_dl)

pdf(file = "output/plots/pop/spop_gg_1_1_dl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1_dl)
dev.off()

spop_gg_1_1_dl
```

```{r tpop_gg_1_1_dl}
tpop_gg_1_1_dl <- psr(popmat = popsize_gg_1_1_dl, stages = 0)

pdf(file = "output/plots/pop/tpop_gg_1_1_dl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1_dl, stages = 0)
dev.off()

tpop_gg_1_1_dl
```


##### Model 1 ps
```{r sim_gg_1_1_ps_dl}
sim_gg_1_1_ps_dl <- parsim(
  landscape = l_gg_1_1_ps,
  population_dynamics = pd_gg_fm_dl,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1_ps_dl",
  species = "gg"
)

gc()
```

```{r popsize_gg_1_1_ps_dl}
popsize_gg_1_1_ps_dl <- gps(x = sim_gg_1_1_ps_dl,
                      workers = nworkers)

saveRDS(object = popsize_gg_1_1_ps_dl,
        file = "output/pva_popmat/popsize_gg_1_1_ps_dl")
```

```{r spop_gg_1_1_ps_dl}
spop_gg_1_1_ps_dl <- psr(popmat = popsize_gg_1_1_ps_dl)

pdf(file = "output/plots/pop/spop_gg_1_1_ps_dl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1_ps_dl)
dev.off()

spop_gg_1_1_ps_dl
```

```{r tpop_gg_1_1_ps_dl}
tpop_gg_1_1_ps_dl <- psr(popmat = popsize_gg_1_1_ps_dl, stages = 0)

pdf(file = "output/plots/pop/tpop_gg_1_1_ps_dl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_gg_1_1_ps_dl, stages = 0)
dev.off()

tpop_gg_1_1_ps_dl
```

Extra LBP

##### Model 1 pl
```{r sim_lb_1_1_pl}
sim_lb_1_1_pl <- parsim(
  landscape = l_lb_1_1_pl,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1_pl",
  species = "lb"
)

gc()
```

```{r popsize_lb_1_1_pl}
popsize_lb_1_1_pl <- gps(x = sim_lb_1_1_pl,
                      workers = nworkers)

saveRDS(object = popsize_lb_1_1_pl,
        file = "output/pva_popmat/popsize_lb_1_1_pl")
```

```{r spop_lb_1_1_pl}
spop_lb_1_1_pl <- psr(popmat = popsize_lb_1_1_pl)

pdf(file = "output/plots/pop/spop_lb_1_1_pl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_pl)
dev.off()

spop_lb_1_1_pl
```

```{r tpop_lb_1_1_pl}
tpop_lb_1_1_pl <- psr(popmat = popsize_lb_1_1_pl, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_1_1_pl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_pl, stages = 0)
dev.off()

tpop_lb_1_1_pl
```


##### Model 1 ps pl
```{r sim_lb_1_1_ps_pl}
sim_lb_1_1_ps_pl <- parsim(
  landscape = l_lb_1_1_ps_pl,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1_ps_pl",
  species = "lb"
)

gc()
```

```{r popsize_lb_1_1_ps_pl}
popsize_lb_1_1_ps_pl <- gps(x = sim_lb_1_1_ps_pl,
                      workers = nworkers)

saveRDS(object = popsize_lb_1_1_ps_pl,
        file = "output/pva_popmat/popsize_lb_1_1_ps_pl")
```

```{r spop_lb_1_1_ps_pl}
spop_lb_1_1_ps_pl <- psr(popmat = popsize_lb_1_1_ps_pl)

pdf(file = "output/plots/pop/spop_lb_1_1_ps_pl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_ps_pl)
dev.off()

spop_lb_1_1_ps_pl
```

```{r tpop_lb_1_1_ps_pl}
tpop_lb_1_1_ps_pl <- psr(popmat = popsize_lb_1_1_ps_pl, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_1_1_ps_pl.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_ps_pl, stages = 0)
dev.off()

tpop_lb_1_1_ps_pl
```

#### Model 1 ph
```{r sim_lb_1_1_ph}
sim_lb_1_1_ph <- parsim(
  landscape = l_lb_1_1_ph,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1_ph",
  species = "lb"
)

gc()
```

```{r popsize_lb_1_1_ph}
popsize_lb_1_1_ph <- gps(x = sim_lb_1_1_ph,
                      workers = nworkers)

saveRDS(object = popsize_lb_1_1_ph,
        file = "output/pva_popmat/popsize_lb_1_1_ph")
```

```{r spop_lb_1_1_ph}
spop_lb_1_1_ph <- psr(popmat = popsize_lb_1_1_ph)

pdf(file = "output/plots/pop/spop_lb_1_1_ph.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_ph)
dev.off()

spop_lb_1_1_ph
```

```{r tpop_lb_1_1_ph}
tpop_lb_1_1_ph <- psr(popmat = popsize_lb_1_1_ph, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_1_1_ph.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_ph, stages = 0)
dev.off()

tpop_lb_1_1_ph
```


##### Model 1 ps pl
```{r sim_lb_1_1_ps_ph}
sim_lb_1_1_ps_ph <- parsim(
  landscape = l_lb_1_1_ps_ph,
  population_dynamics = pd_lb_fm_dm,
  timesteps = ntimesteps,
  replicates = nreplicates,
  workers = nworkers,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1_ps_ph",
  species = "lb"
)

gc()
```

```{r popsize_lb_1_1_ps_ph}
popsize_lb_1_1_ps_ph <- gps(x = sim_lb_1_1_ps_ph,
                      workers = nworkers)

saveRDS(object = popsize_lb_1_1_ps_ph,
        file = "output/pva_popmat/popsize_lb_1_1_ps_ph")
```

```{r spop_lb_1_1_ps_ph}
spop_lb_1_1_ps_ph <- psr(popmat = popsize_lb_1_1_ps_ph)

pdf(file = "output/plots/pop/spop_lb_1_1_ps_ph.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_ps_ph)
dev.off()

spop_lb_1_1_ps_ph
```

```{r tpop_lb_1_1_ps_ph}
tpop_lb_1_1_ps_ph <- psr(popmat = popsize_lb_1_1_ps_ph, stages = 0)

pdf(file = "output/plots/pop/tpop_lb_1_1_ps_ph.pdf",
    width = width.pdf,
    height = height.pdf)
psr(popmat = popsize_lb_1_1_ps_ph, stages = 0)
dev.off()

tpop_lb_1_1_ps_ph
```
