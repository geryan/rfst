---
title: "Forest Futures Analysis"
output: html_notebook:
  toc: true
  toc_depth: 3
author: GE Ryan
date: 20190827
---

# Setup and data preparation

## Controls and software

### Packages
```{r packages}
library(magrittr)
library(dplyr)
library(tibble)
library(sf)
library(lwgeom)
library(rgdal)
library(readr)
library(readxl)
library(ggplot2)
library(lubridate)
library(foreach)
library(doMC)
library(future)
library(future.apply)
library(tidyr)
library(dismo)
library(gbm)
library(steps)
library(raster)
library(rasterVis)
library(rlang)
library(viridis)
library(purrr)
```

```{r load everything}
load(file = "output/RData/00_comp_controls.RData")
load(file = "output/RData/01_landscape_variables.RData")
load(file = "output/RData/02_species_occurrences.RData")
load(file = "output/RData/03_LANDIS_variables.RData")
load(file = "output/RData/04_disturbance_variables.RData")
load(file = "output/RData/05_geophys_vars.RData")
load(file = "output/RData/06_climate_variables.RData")
load(file = "output/RData/07_combined_variables.RData")
load(file = "output/RData/08_distribution_model_data.RData")
load(file = "output/RData/09_fit_distribution_models.RData")
load(file = "output/RData/10_predict_SDMs.RData")
#load(file = "output/RData/")
```


### Functions
```{r source all functions}
source(file = "R/functions/source.functions.R")
source.functions("R/functions")
```


### Paths
```{r proj_paths}
proj_path <- "/home/unimelb.edu.au/ryange/rfst"
# proj_path <- "D:/Users/ryan/Dropbox/Work/RFA_STEPS/rfst/"
```

### Start year
```{r year0}
year0 <- 2019
```

### Timesteps
```{r ntimesteps}
ntimesteps <- 50
```

### Cores to use
```{r ncores}
ncores <- 20
```

### LANDIS scenarios
```{r LANDIS scenarios}
scn_list <- c("1", "4", "8")
rep_list <- sprintf("%02d", 1:10)
```


### Save computing controls
```{r save computing controls}
save(proj_path,
     year0,
     ntimesteps,
     ncores,
     scn_list,
     rep_list,
     source.functions,
     file = "output/RData/00_comp_controls.RData")
```


### Image controls

#### Png controls
```{r png controls}
res <- 600
width.png <- 3200
height.png <- 2000
```


## Landscape
```{r source landscape}
#source(file = "R/01_landscape_variables.R")
```

```{r load landscape vars}
load(file = "output/RData/01_landscape_variables.RData")
```

Mask of central highlands
```{r plot ch_mask}
lp(ch_mask)
```
LANDIS Ecoregions
```{r plot ch_eco}
lp(ch_eco)
```
Fire ecoregions
```{r plot ch_fire_eco}
lp(ch_fire_eco)
```
LANDIS initial conditions
```{r plot ch_ic}
lp(ch_ic)
```
Management zones
```{r plot ch_mgt}
lp(ch_mgt)
```
Aspect
```{r plot ch_aspect}
lp(ch_aspect)
```
Slope
```{r plot ch_slope}
lp(ch_slope)
```
Stand classifications
```{r plot ch_stands}
lp(ch_stands)
```
Fire history
```{r plot ch_fire_history}
lp(ch_fire_history)
```

Logging history
```{r plot logging history}
lp(ch_logging_history)
```


## Species occurrences

```{r source species occurrences}
#source(file = "R/02_species_occurrence.R")
```

```{r load species occurrences}
load(file = "output/RData/02_species_occurrences.RData")
```

```{r plot pa_lb_09}
ggplot() +
  geom_sf(data = ch_rfa) +
  geom_sf(data = pa_lb_09, aes(col = as.factor(PA), alpha = date))
```

```{r plot pa_lb_80}
ggplot() +
  geom_sf(data = ch_rfa) +
  geom_sf(data = pa_lb_80, aes(col = as.factor(PA), alpha = date))
```

```{r plot pa_gg_09}
ggplot() +
  geom_sf(data = ch_rfa) +
  geom_sf(data = pa_gg_09, aes(col = as.factor(PA), alpha = date))
```

```{r plot pa_gg_80}
ggplot() +
  geom_sf(data = ch_rfa) +
  geom_sf(data = pa_gg_80, aes(col = as.factor(PA), alpha = date))
```

## LANDIS outputs
```{r source LANDIS variables}
#source(file = "R/03_LANDIS_variables.R")
```

```{r load LANDIS variables}
load(file = "output/RData/03_LANDIS_variables.RData")
```

### Scenario 1: BAU: Timber harvesting, planned burning, climate change RCP 4.5
```{r}
lp(lv_1_01[[1]])
```
```{r}
levelplot(lv_1_01[[1]][[1]], margin = FALSE)
```

```{r}
levelplot(lv_1_01[[1]][[15]], margin = FALSE)
```

```{r}
levelplot(lv_1_01[[1]][[20]], margin = FALSE)
```
```{r}
levelplot(lv_1_01[[1]][[13]], margin = FALSE)
```

```{r}
levelplot(lv_1_01[[51]][[13]], margin = FALSE)
```

```{r}
levelplot(lv_4_01[[51]][[13]], margin = FALSE)
```

```{r}
levelplot(lv_8_01[[51]][[13]], margin = FALSE)
```

```{r}
levelplot(lv_4_01[[3]][[19]], margin = FALSE)
```
```{r}
levelplot(lv_4_01[[3]][[13]], margin = FALSE)
```

```{r}
levelplot(lv_4_01[[4]][[13]], margin = FALSE)
```




## Disturbance variables
```{r source landscape_variables}
#source(file = "R/04_disturbance_variables.R")
```


```{r load disturbance variables}
load(file = "output/RData/04_disturbance_variables.RData")
```

Logging history
```{r plot logging history s1}
lp(stack(dv_1_01[[1]][[6]], dv_1_01[[51]][[6]]))
```

```{r plot logging history s1}
lp(stack(dv_8_01[[1]][[4]], dv_8_01[[51]][[4]]))
```

```{r}
lp(stack(dv_8_01[[1]][[2]], dv_8_01[[51]][[2]]))
```
```{r}
lp(stack(dv_8_01[[1]][[3]], dv_8_01[[51]][[3]]))
```

```{r}
lp(stack(dv_8_01[[1]][[4]], dv_8_01[[51]][[4]]))
```



## Geoophysical variables
```{r source geophysical variables}
#source(file = "R/05_geophysical_variables.R")
```

```{r load geophysicial variables}
load(file = "output/RData/05_geophys_vars.RData")
```

## Climatic variables
```{r source climate variables}
source(file = "R/06_climate_variables.R")
```

```{r load climate variables}
load(file = "output/RData/06_climate_variables.RData")
```


## 07 Combined variables
```{r source combined variables}
#source(file = "R/07_combined_variables.R")
```


```{r load combined variables}
load(file = "output/RData/07_combined_variables.RData")
```
## 08 Distribution model data
```{r source distrinbution model data}
#source(file = "R/08_distribution_model_data.R")
```

```{r load distribution model data}
load(file = "output/RData/08_distribution_model_data.RData")
```



# Distribution modelling

## Fit models 
```{r source fit distribution models}
#source(file = "R/09_fit_distribution_models.R")
```


```{r load fit distribution models}
load(file = "output/RData/09_fit_distribution_models.RData")
```

## Interrogate models

### Leadbeater's Possum


```{r brt_lb}
brt_lb
```

```{r}
brt_lb %>%
  dplyr::select(year.from, bg, varset, lr, bf, auc, trees)
  
```

### Greater Glider

## Predict to future

```{r source predict_SDMs}
#source(file = "R/10_predict_SDMs.R")
```

```{r load predict_SDMs}
load(file = "output/RData/10_predict_SDMs.RData")
```


### Leadbeater's possum

```{r}
tm_lb <- matrix(c(0.00, 0.59 * 0.75, 0.79 *0.75,
                 0.59,        0.00,       0.00,
                 0.00,        0.59,       0.79),
               nrow = 3,
               ncol = 3,
               byrow = TRUE,
               dimnames = list(c('Newborn','Juvenile','Adult'),
                               c('Newborn','Juvenile','Adult')))


ss_lb <- get.stable.states(tm_lb)

ss_lb

rmax(tm = tm_lb)
```



```{r}
set_lb <- preds_lb[1:3,] %>%
  mutate(
    dv_id = sprintf("dv_%s_%s", scenario, rep)
    ) %>%
  rowwise %>%
  mutate(
    dvs = map(
      .x = dv_id,
      .f = get
    )
  ) %>%
  ungroup %>%
  mutate(
    mort = map(
      .x = dvs,
      .f = function(y){lapply(y, FUN = function(x){x[["mort"]]})}
    ),
    hs = map(
      .x = predmaps,
      .f =  function(x){x[["sdm_0"]]}
    )
  ) %>%
  dplyr::select(-v_id, -variables, -dv_id, -dvs)

set_lb
```




```{r}
ccs <- mapply(
  FUN = mapcc,
  inputlist = set_lb$predmaps,
  scn_id = set_lb$scn_id,
  MoreArgs = list(
    proj_mask = ch_mask,
    size = 6
  )
)

ccs <- tibble(cc = ccs)


```


```{r}
initpops <- mapply(
  FUN = initpop,
  hs = set_lb$hs,
  cc = ccs$carrying_capacity,
  scn_id = set_lb$scn_id,
  MoreArgs = list(
    popsize = 5000,
    proj_mask = ch_mask,
    out_path = "output/pva_vars",
    varset = "",
    species = "lb",
    tm = tm_lb
  )
)

initpops <- tibble(init_pop = initpops)
```

```{r}
tml <- vector("list", 3) # 3 because tibble is 3 rows long. change for longer one

for (i in 1:3){
  tml[[i]] <- tm_lb
}

tml
```

```{r}
simset_lb <- set_lb %>%
  mutate(transition.matrix = tml)

simset_lb <- bind_cols(simset_lb, ccs, initpops)

simset_lb
```


```{r}
sslb <- simset_lb %>%
  mply_landscape

sslb
```
```{r}
 mapply(
    FUN = landscape,
    population = x$init_pop,
    suitability = x$hs,
    carrying_capacity = x$cc
  )
```


```{r}
mply_landscape <- function(x){
  
  library(tibble)
  library(magrittr)
  library(dplyr)
  
  z <- mapply(
    FUN = landscape,
    population = x$init_pop,
    suitability = x$hs,
    carrying_capacity = x$cc
  )
  
  zz <- tibble(landscape = z)
  
  result <- bind_cols(x, zz)
  
  return(result)
  
}
```



```{r}
aa <- set_lb %$%
mapply(
  FUN = mapcc,
  inputlist = predmaps,
  scn_id = scn_id,
  MoreArgs = list(
    proj_mask = ch_mask,
    size = 6
  )
)

aa
```


```{r}
l1 <- landscape(
  population = simset_lb$init.pop[[1]],
  suitability = simset_lb$predmaps[[1]],
  carrying_capacity = simset_lb$carrying_capacity[[1]]
)
```


```{r}
d1 <- population_dynamics(
  change = growth(
    transition_matrix = matrix(c(0.00, 0.59 * 0.75, 0.79 *0.75,
                 0.59,        0.00,       0.00,
                 0.00,        0.59,       0.79),
               nrow = 3,
               ncol = 3,
               byrow = TRUE,
               dimnames = list(c('Newborn','Juvenile','Adult'),
                               c('Newborn','Juvenile','Adult'))),
    global_stochasticity = 0.1
  ),
  dispersal =  cellular_automata_dispersal(
    max_cells = c(0, 50, 50),
    dispersal_proportion = density_dependence_dispersing()
    )
)
```

```{r}
sim_lb_1_1 <- parsim(
  landscape = l1,
  population_dynamics = d1,
  timesteps = 10,
  replicates = 10,
  workers = 10,
  proj_mask = ch_mask,
  out_path = "output/pva_pops/",
  scn_id = "s1",
  varset = "1",
  species = "lb"
)
```

```{r}
plan(sequential)
s1 <- simulation(landscape = l1, population_dynamics = d1, timesteps = 10, replicates = 10)
```

```{r}
pp <- preds_lb[1:3,]
```


```{r}

```

