---
title: "Forest Futures Analysis"
output: html_notebook:
  toc: true
  toc_depth: 3
author: GE Ryan
date: 20190827
---

# Setup and data preparation

## Controls and software

### Packages
```{r packages}
library(magrittr)
library(dplyr)
library(tibble)
library(sf)
library(lwgeom)
library(rgdal)
library(readr)
library(readxl)
library(ggplot2)
library(lubridate)
library(foreach)
library(doMC)
library(future)
library(future.apply)
library(tidyr)
library(dismo)
library(gbm)
library(steps)
library(raster)
library(rasterVis)
library(rlang)
library(viridis)
library(purrr)
```

```{r load everything}
load(file = "output/RData/00_comp_controls.RData")
load(file = "output/RData/01_landscape_variables.RData")
load(file = "output/RData/02_species_occurrences.RData")
load(file = "output/RData/03_LANDIS_variables.RData")
load(file = "output/RData/04_disturbance_variables.RData")
load(file = "output/RData/05_geophys_vars.RData")
load(file = "output/RData/06_climate_variables.RData")
load(file = "output/RData/07_combined_variables.RData")
load(file = "output/RData/08_distribution_model_data.RData")
#load(file = "output/RData/")
```


### Functions
```{r source all functions}
source(file = "R/functions/source.functions.R")
source.functions("R/functions")
```


### Paths
```{r proj_paths}
proj_path <- "/home/unimelb.edu.au/ryange/rfst"
# proj_path <- "D:/Users/ryan/Dropbox/Work/RFA_STEPS/rfst/"
```

### Start year
```{r year0}
year0 <- 2019
```

### Timesteps
```{r ntimesteps}
ntimesteps <- 50
```

### Cores to use
```{r ncores}
ncores <- 20
```

### LANDIS scenarios
```{r LANDIS scenarios}
scn_list <- c("1", "4", "8")
rep_list <- sprintf("%02d", 1:10)
```


### Save computing controls
```{r save computing controls}
save(proj_path,
     year0,
     ntimesteps,
     ncores,
     scn_list,
     rep_list,
     source.functions,
     file = "output/RData/00_comp_controls.RData")
```


### Image controls

#### Png controls
```{r png controls}
res <- 600
width.png <- 3200
height.png <- 2000
```


## Landscape
```{r source landscape}
#source(file = "R/01_landscape_variables.R")
```

```{r load landscape vars}
load(file = "output/RData/01_landscape_variables.RData")
```

Mask of central highlands
```{r plot ch_mask}
lp(ch_mask)
```
LANDIS Ecoregions
```{r plot ch_eco}
lp(ch_eco)
```
Fire ecoregions
```{r plot ch_fire_eco}
lp(ch_fire_eco)
```
LANDIS initial conditions
```{r plot ch_ic}
lp(ch_ic)
```
Management zones
```{r plot ch_mgt}
lp(ch_mgt)
```
Aspect
```{r plot ch_aspect}
lp(ch_aspect)
```
Slope
```{r plot ch_slope}
lp(ch_slope)
```
Stand classifications
```{r plot ch_stands}
lp(ch_stands)
```
Fire history
```{r plot ch_fire_history}
lp(ch_fire_history)
```

Logging history
```{r plot logging history}
lp(ch_logging_history)
```


## Species occurrences

```{r source species occurrences}
#source(file = "R/02_species_occurrence.R")
```

```{r load species occurrences}
load(file = "output/RData/02_species_occurrences.RData")
```

```{r plot pa_lb_09}
ggplot() +
  geom_sf(data = ch_rfa) +
  geom_sf(data = pa_lb_09, aes(col = as.factor(PA), alpha = date))
```

```{r plot pa_lb_80}
ggplot() +
  geom_sf(data = ch_rfa) +
  geom_sf(data = pa_lb_80, aes(col = as.factor(PA), alpha = date))
```

```{r plot pa_gg_09}
ggplot() +
  geom_sf(data = ch_rfa) +
  geom_sf(data = pa_gg_09, aes(col = as.factor(PA), alpha = date))
```

```{r plot pa_gg_80}
ggplot() +
  geom_sf(data = ch_rfa) +
  geom_sf(data = pa_gg_80, aes(col = as.factor(PA), alpha = date))
```

## LANDIS outputs
```{r source LANDIS variables}
#source(file = "R/03_LANDIS_variables.R")
```

```{r load LANDIS variables}
load(file = "output/RData/03_LANDIS_variables.RData")
```

### Scenario 1: BAU: Timber harvesting, planned burning, climate change RCP 4.5
```{r}
lp(lv_1_01[[1]])
```
```{r}
levelplot(lv_1_01[[1]][[1]], margin = FALSE)
```

```{r}
levelplot(lv_1_01[[1]][[15]], margin = FALSE)
```

```{r}
levelplot(lv_1_01[[1]][[20]], margin = FALSE)
```
```{r}
levelplot(lv_1_01[[1]][[13]], margin = FALSE)
```

```{r}
levelplot(lv_1_01[[51]][[13]], margin = FALSE)
```

```{r}
levelplot(lv_4_01[[51]][[13]], margin = FALSE)
```

```{r}
levelplot(lv_8_01[[51]][[13]], margin = FALSE)
```

```{r}
levelplot(lv_4_01[[3]][[19]], margin = FALSE)
```
```{r}
levelplot(lv_4_01[[3]][[13]], margin = FALSE)
```

```{r}
levelplot(lv_4_01[[4]][[13]], margin = FALSE)
```




## Disturbance variables
```{r source landscape_variables}
#source(file = "R/04_disturbance_variables.R")
```


```{r load disturbance variables}
load(file = "output/RData/04_disturbance_variables.RData")
```

Logging history
```{r plot logging history s1}
lp(stack(dv_1_01[[1]][[6]], dv_1_01[[51]][[6]]))
```

```{r plot logging history s1}
lp(stack(dv_8_01[[1]][[4]], dv_8_01[[51]][[4]]))
```

```{r}
lp(stack(dv_8_01[[1]][[2]], dv_8_01[[51]][[2]]))
```
```{r}
lp(stack(dv_8_01[[1]][[3]], dv_8_01[[51]][[3]]))
```

```{r}
lp(stack(dv_8_01[[1]][[4]], dv_8_01[[51]][[4]]))
```



## Geoophysical variables
```{r source geophysical variables}
#source(file = "R/05_geophysical_variables.R")
```

```{r load geophysicial variables}
load(file = "output/RData/05_geophys_vars.RData")
```

## Climatic variables
```{r source climate variables}
source(file = "R/06_climate_variables.R")
```

```{r load climate variables}
load(file = "output/RData/06_climate_variables.RData")
```


## 07 Combined variables
```{r source combined variables}
#source(file = "R/07_combined_variables.R")
```


```{r load combined variables}
load(file = "output/RData/07_combined_variables.RData")
```
## 08 Distribution model data
```{r source distrinbution model data}
#source(file = "R/08_distribution_model_data.R")
```

```{r load distribution model data}
load(file = "output/RData/08_distribution_model_data.RData")
```



# Distribution modelling

## Leadbeater's Possum

### Table of models
```{r}
load(file = "output/RData/09_fit_distribution_models.RData")
```

```{r}
brt_lb %>%
  unnest(auc) %>%
  varset.name 
```

**USE FUTURE_MAPPLY TO DO PREDICTIONS FOR MAPS**


```{r}
ip_lb_09b_1 <- brtpredict(variables = vlb1_1_01,
                         model = brt_lb$brt.fit[[3]],
                         scn_id = "s1_01",
                         varset = "09b_1",
                         species = "lb")

ip_lb_80b_1 <- brtpredict(variables = vlb1_1_01,
                         model = brt_lb$brt.fit[[7]],
                         scn_id = "s1_01",
                         varset = "80b_1",
                         species = "lb")
```

```{r}
lp(ip_lb_09b_1)
```

```{r}
lp(ip_lb_80b_1)
```


```{r lbp dist table}
dt_lb <- tibble(year.from = c("80", "09"),
                bg = c(TRUE, FALSE),
                varset = list(vn_lb_1, vn_lb_2)) %>%
  expand(year.from, bg, varset) %>%
  rowwise %>%
  mutate(pa.data = list(get(sprintf("pa_lb_%02d%s", year.from, ifelse(bg, "", "x"))))) %>%
  ungroup %>%
  mutate(model.data = map(.x = pa.data,
                          .f = get.model.data,
                          y = vars_1_01,
                          na.omit = FALSE),
         model.data = map2(.x = model.data,
                           .y = varset,
                           .f = clean.model.data))

dt_lb
```
```{r}
plan(multisession, workers = 2)

brt_lb <- dt_lb %>%
  filter(year.from == 9) %>%
  filter(bg) %>%
  mutate(brt.fit = future_map(.x = model.data,
                       .f = gbmstep,
                       learning.rate = 0.01,
                       bag.fraction = 0.75))

brt_lb
```

```{r}

brtlb <- tibble(year.from = c("80", "09"),
                bg = c(TRUE, FALSE),
                varset = list(vn_lb_1, vn_lb_2)) %>%
  expand(year.from, bg, varset) %>%
  rowwise %>%
  mutate(pa.data = list(get(sprintf("pa_lb_%s%s", year.from, ifelse(bg, "", "x"))))) %>%
  ungroup %>%
  mutate(partn = 1:8) %>%
  partition(cluster) %>%
  mutate(model.data = map(.x = pa.data,
                          .f = get.model.data,
                          y = vars_1_01,
                          na.omit = FALSE),
         model.data = map2(.x = model.data,
                           .y = varset,
                           .f = clean.model.data))

brtlb
```

```{r}
zbrt_lb <- brt_lb %>%
  mutate(auc = map(.x = brt.fit,
                   .f = brt_auc),
         varset = paste0("%2d_%s%s", year.from, ifelse(bg, "b", "x")))

zbrt_lb
         

ip_lb_09_1 <- brtpredict(variables = vlb1_1_01,
                         model = brt_lb_09_1,
                         scn_id = "s1_01",
                         varset = "09_1",
                         species = "lb")

pred = map(.x = brt.fit,
                    .f = brtpredict,
                    ))
```



### 
```{r brt_lb_09_1}
brt_lb_09_1 <- gbmstep(data = md_lb_09 %>% dplyr::select("PA", vn_lb_1),
                       learning.rate = 0.01,
                       bag.fraction = 0.75)
```

```{r summary brt_lb_09_1}
summary(brt_lb_09_1)
```
```{r gbm.plot brt_lb_09_1}
gbm.plot(brt_lb_09_1)
```
```{r auc brt_lb_09_1}
brt_auc(brt_lb_09_1)
```


```{r ip_lb_09_1}
ip_lb_09_1 <- brtpredict(variables = vlb1_1_01,
                         model = brt_lb_09_1,
                         scn_id = "s1_01",
                         varset = "09_1",
                         species = "lb") %T>%
  lp
```


